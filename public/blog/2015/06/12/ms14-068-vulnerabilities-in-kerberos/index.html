
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>MS14-068: Vulnerabilities in Kerberos - KC's blog</title>
  <meta name="author" content="KC">

  
  <meta name="description" content="MS14-068: From MS14-068 to Full Compromise - Step by Step
Digging into MS14-068, Exploitation and Defense
Exploiting MS14-068 Vulnerable Domain &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zomo.heroku.com/blog/2015/06/12/ms14-068-vulnerabilities-in-kerberos/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="KC's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">KC's blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="zomo.heroku.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">MS14-068: Vulnerabilities in Kerberos</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-12T11:08:09+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:08 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>MS14-068:</p>

<ul>
<li><a href="https://www.trustedsec.com/december-2014/ms14-068-full-compromise-step-step/">From MS14-068 to Full Compromise - Step by Step</a></li>
<li><a href="https://labs.mwrinfosecurity.com/blog/2014/12/16/digging-into-ms14-068-exploitation-and-defence/">Digging into MS14-068, Exploitation and Defense</a></li>
<li><a href="http://adsecurity.org/?p=676">Exploiting MS14-068 Vulnerable Domain Controllers Successfully with the Python Kerberos Exploitation Kit (PyKEK)</a></li>
<li><a href="http://blog.beyondtrust.com/a-quick-look-at-ms14-068">A Quick Look at MS14-068</a></li>
<li><a href="https://www.exploit-db.com/exploits/35474/">Windows Kerberos - Elevation of Privilege (MS14-068)</a></li>
</ul>


<p>Kerberos:</p>

<ul>
<li><a href="https://technet.microsoft.com/en-us/library/cc961976.aspx">Basic Concepts for the Kerberos Protocol</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/cc246080.aspx">Kerberos Protocol Overview</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/cc237917.aspx">MS-PAC: Privilege Attribute Certificate Data Structure</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/cc237955.aspx">PAC_SIGNATURE_DATA</a></li>
<li><a href="http://adsecurity.org/?p=227">Kerberos, Active Directory&rsquo;s Secret Decoder Ring</a></li>
<li><a href="http://cs.unc.edu/~fabian/course_papers/steiner_neuman.pdf">Kerberos: An Authentication Service for Open Network Systems</a></li>
<li><a href="http://www.isi.edu/div7/publication_files/evolution_of_kerberos.pdf">The Evolution of the Kerberos Authentication Service</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/cc772815(v=ws.10).aspx">How the Kerberos Version 5 Authentication Protocol Works</a></li>
</ul>


<p>Other attacks:</p>

<ul>
<li><a href="http://adsecurity.org/?p=1515">Detecting Forged Kerberos Ticket (Golden Ticket &amp; Silver Ticket) Use in Active Directory</a></li>
<li><a href="https://github.com/bidord/pykek">Python Kerberos Exploitation Kit</a></li>
<li><a href="http://livestream.com/NTNU/passwords14/videos/70751388?t=1418474079423">The International Conference on PASSWORDS 2014</a></li>
<li><a href="https://media.blackhat.com/bh-us-12/Briefings/Duckwall/BH_US_12_Duckwall_Campbell_Still_Passing_Slides.pdf">Still Passing the Hash 15 Years Later&hellip;</a></li>
</ul>


<h3>요체</h3>

<p>이 버그의 요체는 KDC 가 가짜 PAC 를 서명하게 만드는 것.</p>

<p>PAC 은 krbtgt 의 키로 hmac-md5 / hmac-sha1-96-aes256 사인되어있는데. 가짜 PAC 를 어떻게 만들 수 있을까?</p>

<p>두가지 트릭을 사용하는데,</p>

<ol>
<li><p>각종 Admin 그룹 권한을 잔뜩 넣은 가짜 PAC 를 만들고, HMAC 이 아니라, MD5 로 서명을 하는 것. 패치전 MS Kerberos 코드에서는 HMAC 이 아니어도 crypto algorithm 을 돌려서 나온 결과가 일치하면 넘어갔다.</p></li>
<li><p>서명은 HMAC 이 아니라 MD4 로 그냥 넘어갔다고 쳐도, TGT 는 K_s (서비스 서버) 로 암호화되는데, 이걸 어떻게 하냐가 핵심. Sylvain Monné 에 따르면, TGS-REQ 에 {TGT}K_s 형태로 보내지 말고, TGS-REQ 의 enc-authorization-data 세그먼트에 TGT 세션키로 암호화해서 집어넣어도 된다고 한다. 좀 더 들여다봐야겠지만, TGS-REQ 에 가짜를 보내면 TGS-REP 에 krbtgt 와 logon 서버가 서명한 PAC 가 오는 모양.</p></li>
</ol>


<p><a href="http://blogs.technet.com/b/srd/archive/2014/11/18/additional-information-about-cve-2014-6324.aspx">Microsoft 에 따르면</a>
Windows Server 2008R2 이하에서 돌아가는 Domain Controller 는 취약하다 (패치안된). 2012 는 관련된 유사한 공격에 취약하지만, exploit 하기 더 어렵다고한다.</p>

<h3>Kerberos</h3>

<p>일단 커버러스 모델에 대해서 알아봐야겠다.</p>

<h4>Initial Setup</h4>

<p>커버러스에서는 TTP (Trusted Third Party) 인 KDC (Key Distribution Center) 가 존재하는 것이 핵심. KDC 는 realm 에 참여하는 모든 entity 와 각각 개별적으로 share 하는 symmetric key 가 있다. 조직 크기에 따라 수십개에서 수만개에 달할 저 symmetric key 를 어떻게 generate 해서 share 하는지는 일단 논외.</p>

<p>일단 V4 기준으로 정리해본다.</p>

<ol>
<li>어떤 Client 는 어떤 Server 에 서비스를 요청하고 싶어한다.</li>
<li>Client 는 KDC 에 c,s,n 을 보낸다. c 는 client identity, s 는 접근하고 싶은 server identity, n 은 replay 를 방지할 nonce.</li>
<li>KDC 는 Client 에게 2 개의 정보를 보낸다.</li>
<li>{Session Key,Ticket}K_c 형태로 보내는데, the client 와 KDC 가 공유하고 있는 symmetric key K_c 로 암호화해서 보내기때문에, 아무나 못푼다.</li>
<li>Session Key 는 the client 와 the server 가 통신할 때 사용할 세션키.</li>
<li>Ticket 은 일단 the server 와 KDC 가 공유하고 있는 symmetric key K_s 로 암호화되서 아무나 못푼다. 오직 the server 만 풀수있다.</li>
<li>Ticket 내용은 {client,start,expire,Session Key}K_s 인데, client identity, 티켓의 유효기간 start ~ expire, 그리고 the client 와 the server 가 사용할 세션키.</li>
<li>일단 4 로 돌아가서, client 는 <code>session key</code> 와 <code>ticket</code> 을 받았다.</li>
<li>이제 the client 는 the server 에, {A_c}session_key, Ticket 을 보낸다. Ticket 은 각종 정보를 K_s 로 암호화한 것.</li>
</ol>


<p>이제 윈도우즈 버전으로 가본다.</p>

<h4>Kerberos in a Windows Domain</h4>

<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/bb742516.aspx">Kerberos Explained</a></li>
</ul>


<p>KDC 에서 Ticket 을 얻어서 타겟 Service 에 Ticket 을 보내는 흐름은 다음과 같다.</p>

<ol>
<li>AS-REQ: The user 가 KDC 에 보내는 메시지. user identity 와 timestamp 를 KDC 로 보낸다. timestamp 는 유저의 패스워드 해쉬로 암호화한다. AD 에 저장되어있는 패스워드를 사용해 timestamp 를 decrypt 해봐서 올바른 시간이 나오면 replay 가 아니란 것을 알수 있다.</li>
<li><p>AS-REP: The user 의 신원을 성공적으로 확인했다면, 세션키와 TGT (Ticket Granting Ticket) 를 보낸다. TGT 에는 <code>Client Name</code>, <code>Start</code>, <code>End</code>, <code>Session Key</code>, <code>Privilege Attribute Certificate (PAC)</code>, <code>Server Signature</code>, <code>KDC Signature</code> 가 들어있다. TGT 는 K_krbtgt 로 암호화된다. 세션키는 K_c 로 암호화된다. 여기까지는 KDC 랑 서비스 서버랑 krbtgt 로 동일한 상황. 요구하는 서비스가 Ticket Granting Service 이기때문.</p></li>
<li><p>TGS-REQ: 접근하고자하는 Service name, TGT (Ticket Granting Ticket), Authenticator 를 서비스에 보낸다. Authenticator 는 { user ID, timestamp }K_c,s 로 암호화된다.</p></li>
<li>TGS-REP: TGS 는 K_krbtgt 를 이용해 TGT 를 복호화한다. TGT 안에 세션키가 있으니, 그 세션키로 Authenticator 를 복호화한다. Authenticator 의 내용과 TGT 의 내용을 비교 검증한다. OK 라면, 서비스 티켓을 찍어낼 차례이다. 서비스 티켓에 PAC 를 복사한다. 서비스 티켓의 PAC 는 krbtgt 키와 K_logon 로 서명된다. 서비스 티켓은 K_logon 로 암호화된다. 이제 클라이언트는 예를 들어 로그온 서버에 이 서비스 티켓을 제출하고 사용을 허가받을 수 있다.</li>
</ol>


<h4>AS-REQ</h4>

<p><code>AS-REQ</code> 의 큰 두가지 핵심은 암호화된 timestamp 와 유저의 신원 정보.</p>

<p>유저의 신원 정보는,</p>

<ul>
<li>cname = 사용자 ID</li>
<li>realm = domain (i.e. BABOCORP.GLOBAL)</li>
<li>service = &lsquo;krbtgt&rsquo;</li>
<li>host = domain (i.e. BABOCORP.GLOBAL)</li>
<li>etype = RC4_HMAC</li>
<li>kdc_options = (Forwardable, Proxiable, Renewable, Canonicalize)</li>
<li>nonce = random 31 bits</li>
</ul>


<p><code>AS-REQ</code> 를 만들때 timestamp 를 유저의 패스워드로 암호화하는데 그 과정을 보면,</p>

<figure class='code'><figcaption><span>유저의 인풋을 해쉬해서 암호화 키로 쓰는 장면</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">pass</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="s">&quot;Password: &quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">unicode_pass</span> <span class="o">=</span> <span class="k">pass</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-16le&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">md4_pass</span> <span class="o">=</span> <span class="n">MD4</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">unicode_pass</span><span class="p">))</span>
</span><span class='line'><span class="n">md4_digest</span> <span class="o">=</span> <span class="n">md4_pass</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span class='line'><span class="n">user_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">RC4_HMAC</span><span class="p">,</span> <span class="n">md4_digest</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>이제 <code>build_pa_enc_timestamp(current_time, key)</code> 에서 timestamp 를 암호화하는데,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">build_pa_enc_timestamp</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span class='line'>    <span class="n">gt</span><span class="p">,</span> <span class="n">ms</span> <span class="o">=</span> <span class="n">epoch2gt</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="n">microseconds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="n">pa_ts_enc</span> <span class="o">=</span> <span class="n">PaEncTsEnc</span><span class="p">()</span>
</span><span class='line'>    <span class="n">pa_ts_enc</span><span class="p">[</span><span class="s">&#39;patimestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gt</span>
</span><span class='line'>    <span class="n">pa_ts_enc</span><span class="p">[</span><span class="s">&#39;pause&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pa_ts</span> <span class="o">=</span> <span class="n">PaEncTimestamp</span><span class="p">()</span>
</span><span class='line'>    <span class="n">pa_ts</span><span class="p">[</span><span class="s">&#39;etype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">pa_ts</span><span class="p">[</span><span class="s">&#39;cipher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">encode</span><span class="p">(</span><span class="n">pa_ts_enc</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">pa_ts</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>pa_ts</code> 의 <code>etype</code> 과 <code>cipher</code> 에 각각 <code>RC4_HMAC</code> 과 유저가 입력한 패스워드의 해쉬를 세팅한다.</p>

<p><code>PaEncTimestamp()</code> 는 ASN.1 으로 <code>etype</code>, <code>cipher</code> 를 가지고 있다.</p>

<ul>
<li><a href="http://luca.ntop.org/Teaching/Appunti/asn1.html">A Layman&rsquo;s Guide to a Subset of ASN.1, BER, and DER</a></li>
</ul>


<p>유저가 입력한 패스워드 해쉬로 timestamp 를 암호화한다.</p>

<figure class='code'><figcaption><span>encrypt()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">etype</span> <span class="o">!=</span> <span class="n">RC4_HMAC</span><span class="p">:</span>
</span><span class='line'>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Only RC4-HMAC supported!&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">k1</span> <span class="o">=</span> <span class="n">HMAC</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">random_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span>
</span><span class='line'>    <span class="n">chksum</span> <span class="o">=</span> <span class="n">HMAC</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span class='line'>    <span class="n">k3</span> <span class="o">=</span> <span class="n">HMAC</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">chksum</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">chksum</span> <span class="o">+</span> <span class="n">ARC4</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>우선 유저가 입력한 패스워드의 MD4 해쉬를 키로, 1 을 HMAC 돌린다.</li>
<li>data 앞에 랜덤 바이트를 8 bytes 붙인다.</li>
<li><ol>
<li>을 키로 pa_ts_enc 구조에 HMAC 을 돌린다. 이게 체크섬.</li>
</ol>
</li>
<li>체크섬에 또 한번 HMAC 을 돌린다.</li>
<li><ol>
<li>를 암호키로 pa_ts_enc 구조에 RC4 를 돌린다.</li>
</ol>
</li>
<li>체크섬 + 5. 가 <code>RC4_HMAC</code> 값이 된다.</li>
</ol>


<h3>Packets</h3>

<p>adsecurity.org 에서 WireShark packets 을 다운받아 훑어보았다.</p>

<h4>AS-REQ</h4>

<ul>
<li>padata 에는 kRB5-PADATA-ENC-TIMESTAMP (eTYPE-ARCFOUR-HMAC-MD5, cipher)</li>
<li>req-body 에는 cname (i.e. darthsidious / LAB.ADSECURITY.ORG), sname (i.e. krbtgt / LAB.ADSECURITY.ORG), etype (eTYPE-ARCFOUR-HMAC-MD5)</li>
</ul>


<h4>AS-REP</h4>

<h4>TGS-REQ</h4>

<h4>TGS-REP</h4>

<h3>Exploitation</h3>

<h4>Discovery</h4>

<p>nmap 으로 FQDN, Domain name, Windows Version 등을 확인한다.</p>

<figure class='code'><figcaption><span>encrypt()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># nmap --script smb-os-discovery.nse -p445 xxx.xxx.xxx.xxx</span>
</span></code></pre></td></tr></table></div></figure>


<p>Powershell 커맨드들.</p>

<figure class='code'><figcaption><span>encrypt()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Get</span><span class="o">-</span><span class="n">ADDomainController</span> <span class="o">-</span><span class="nb">filter</span> <span class="o">*</span>
</span><span class='line'><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Get</span><span class="o">-</span><span class="n">HotFix</span> <span class="o">-</span><span class="n">ID</span> <span class="n">KB3011780</span> <span class="o">-</span><span class="n">ComputerName</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>encrypt()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">net</span> <span class="n">time</span> <span class="o">-</span><span class="n">S</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">rdate</span> <span class="o">-</span><span class="n">n</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">net</span> <span class="n">rpc</span> <span class="o">-</span><span class="n">W</span> <span class="n">DOMAIN</span> <span class="o">-</span><span class="n">U</span> <span class="n">user01</span> <span class="o">-</span><span class="n">S</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span> <span class="n">shell</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">user01</span><span class="s">&#39;s password:</span>
</span><span class='line'><span class="n">Talking</span> <span class="n">to</span> <span class="n">domain</span> <span class="n">DOMAIN</span> <span class="p">(</span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mf">21.</span><span class="o">...</span><span class="p">)</span>
</span><span class='line'><span class="n">net</span> <span class="n">rpc</span><span class="o">&gt;</span> <span class="n">user</span>
</span><span class='line'><span class="n">net</span> <span class="n">rpc</span> <span class="n">user</span><span class="o">&gt;</span> <span class="n">show</span>
</span><span class='line'><span class="n">net</span> <span class="n">rpc</span> <span class="n">user</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">user01</span>
</span><span class='line'><span class="n">user</span> <span class="n">rid</span><span class="p">:</span> <span class="mi">1105</span><span class="p">,</span> <span class="n">group</span> <span class="n">rid</span><span class="p">:</span> <span class="mi">513</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">rpcclient</span> <span class="o">-</span><span class="n">U</span> <span class="n">user01</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span>
</span><span class='line'><span class="n">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span> <span class="n">lookupnames</span> <span class="n">user01</span>
</span><span class='line'><span class="n">user01</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="n">xxx</span> <span class="p">(</span><span class="n">User</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># apt-get install cifs-utils krb5-user</span>
</span><span class='line'><span class="c"># cat &gt; /etc/krb5.conf &lt;&lt; &#39;EOF&#39;</span>
</span><span class='line'><span class="p">[</span><span class="n">libdefaults</span><span class="p">]</span>
</span><span class='line'><span class="n">default_realm</span> <span class="o">=</span> <span class="n">DOMAIN</span> <span class="c"># upper</span>
</span><span class='line'><span class="n">dns_lookup_realm</span> <span class="o">=</span> <span class="n">true</span>
</span><span class='line'><span class="n">dns_lookup_kdc</span> <span class="o">=</span> <span class="n">true</span>
</span><span class='line'><span class="p">[</span><span class="n">realms</span><span class="p">]</span>
</span><span class='line'><span class="n">DOMAIN</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="n">kdc</span> <span class="o">=</span> <span class="n">DC</span><span class="p">:</span><span class="mi">88</span> <span class="c"># upper</span>
</span><span class='line'><span class="n">admin_server</span> <span class="o">=</span> <span class="n">DC</span> <span class="c"># lower</span>
</span><span class='line'><span class="n">default_domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="c"># lower</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">[</span><span class="n">domain_realm</span><span class="p">]</span>
</span><span class='line'><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span> <span class="o">=</span> <span class="n">DOMAIN</span> <span class="c"># lower = upper</span>
</span><span class='line'><span class="n">EOF</span>
</span><span class='line'><span class="c"># rdate -n DC</span>
</span><span class='line'><span class="c"># kinit user@domain</span>
</span><span class='line'><span class="c"># rpcclient -U user DC</span>
</span><span class='line'><span class="c"># cp TGT* /tmp/krb5cc_0</span>
</span><span class='line'><span class="c"># smbclient -W domain //DC/c$ -k</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Uptime</h4>

<p>Responder.py</p>

<h4>RID Enumeration</h4>

<p>ridenum.py</p>

<h4>mimikatz</h4>

<p>mimikatz.exe</p>

<h4>PyKEK</h4>

<p>pykek 이 forge 하는 group membership 은</p>

<figure class='code'><figcaption><span>encrypt()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Domain</span> <span class="n">Users</span> <span class="p">(</span><span class="mi">513</span><span class="p">)</span>
</span><span class='line'><span class="n">Domain</span> <span class="n">Admins</span> <span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'><span class="n">Schema</span> <span class="n">Admins</span> <span class="p">(</span><span class="mi">518</span><span class="p">)</span>
</span><span class='line'><span class="n">Enterprie</span> <span class="n">Admins</span> <span class="p">(</span><span class="mi">519</span><span class="p">)</span>
</span><span class='line'><span class="n">Group</span> <span class="n">Policy</span> <span class="n">Creator</span> <span class="n">Owners</span> <span class="p">(</span><span class="mi">520</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://adsecurity.org/?p=763">PyKEK Kerberos Packets on the Wire aka How the MS14-068 Exploit Works</a></p>

<h3>Patch</h3>

<p>blog.beyondtrust.com 의 글을 보니, VerifyPacSignature() 에서 SignatureType 이 HMAC_MD5 인지 비교하는 코드가 들어간 모양.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">KC</span></span>

      




<time class='entry-date' datetime='2015-06-12T11:08:09+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:08 am</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://zomo.heroku.com/blog/2015/06/12/ms14-068-vulnerabilities-in-kerberos/" data-via="" data-counturl="http://zomo.heroku.com/blog/2015/06/12/ms14-068-vulnerabilities-in-kerberos/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/06/10/mitmproxy/" title="Previous Post: mitmproxy">&laquo; mitmproxy</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/06/14/exploring-control-flow-guard-in-windows-10/" title="Next Post: Exploring Control Flow Guard in Windows 10">Exploring Control Flow Guard in Windows 10 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/10/04/return-oriented-programming-for-the-arm-architecture/">Return Oriented Programming for the ARM Architecture</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/02/the-inside-story-behind-ms08-067/">The Inside Story Behind MS08-067</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/17/rop-and-arm/">ROP and ARM</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/13/sophail-applied-attacks-against-sophos-antivirus/">Sophail: Applied Attacks Against Sophos Antivirus</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/13/stagefright/">Stagefright</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - KC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
