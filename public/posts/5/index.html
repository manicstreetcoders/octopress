
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>KC's blog</title>
  <meta name="author" content="KC">

  
  <meta name="description" content="
Mobile Trusted Computing
Modeling attacks on physical unclonable functions
Silicon physical random functions ">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zomo.heroku.com/posts/5/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="KC's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">KC's blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="zomo.heroku.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/14/physical-unclonable-functions/">Physical Unclonable Functions</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-14T23:19:59+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li><a href="http://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=6856168">Mobile Trusted Computing</a></li>
<li><a href="http://people.csail.mit.edu/devadas/pubs/ccs_attack_puf.pdf">Modeling attacks on physical unclonable functions</a></li>
<li><a href="http://people.csail.mit.edu/devadas/pubs/spuf.pdf">Silicon physical random functions</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/14/exploring-control-flow-guard-in-windows-10/">Exploring Control Flow Guard in Windows 10</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-14T22:50:29+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:50 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li><a href="http://sjc1-te-ftp.trendmicro.com/assets/wp/exploring-control-flow-guard-in-windows10.pdf">트렌드마이크로의 CFG in Windows 10 보고서</a></li>
<li><a href="https://blog.coresecurity.com/2015/03/25/exploiting-cve-2015-0311-part-ii-bypassing-control-flow-guard-on-windows-8-1-update-3/">Exploiting CVE-2015-0311, Part II: Bypassing Control Flow Guard on Windows 8.1 Update 3</a></li>
<li><a href="http://research.microsoft.com/pubs/69217/ccs05-cfi.pdf">Control-Flow Integrity - Principles, Implementations, and Applications</a></li>
<li><a href="http://www.cs.berkeley.edu/~dawnsong/papers/Oakland2013-CCFIR-CR.pdf">Practical Control Flow Integrity &amp; Randomization for Binary Executables</a></li>
<li><a href="http://static.googleusercontent.com/media/research.google.com/en/us/pubs/archive/34913.pdf">Native Client: A Sandbox for Portable, Untrusted x86 Native Code</a></li>
<li><a href="http://www.powerofcommunity.net/poc2014/mj0011.pdf">Windows 10 Control Flow Guard Internals</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typedef int(*fun_t)(int);
</span><span class='line'>int foo(int a) { printf("hello jack: %d\n", a); return a; }
</span><span class='line'>class CTargetObject
</span><span class='line'>{
</span><span class='line'>public:
</span><span class='line'>    fun_t _fun;
</span><span class='line'>} 
</span><span class='line'>int _tmain(int argc, _TCHAR* argv[])
</span><span class='line'>{
</span><span class='line'>    int i = 0;
</span><span class='line'>    CTargetObject* o_array = new CTargetObject[5];
</span><span class='line'>    for (i=0;i&lt;1000;i++)
</span><span class='line'>        o_array[i]._fun = foo;
</span><span class='line'>    o_array[0]._fun(1); // &lt;- indirect call
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Assembly 를 보면,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mov esi,[esi]
</span><span class='line'>push 1
</span><span class='line'>call esi</span></code></pre></td></tr></table></div></figure>


<p>CFG 가 들어간 코드는,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mov esi,[esi]
</span><span class='line'>mov ecx,esi
</span><span class='line'>push 1
</span><span class='line'>call @_guard_check_icall@4
</span><span class='line'>call esi</span></code></pre></td></tr></table></div></figure>


<p><code>_guard_check_icall</code> 은 <code>ntdll!LdrpValidateUserCallTarget</code> 을 point.</p>

<p>하는 일은 Compiler 가 미리 만들어둔 function call address table (실제로는 bitmap) 을 보고, valid 한 펑션 start address 인지 아닌지 판단하는 것.
Compiler instrumentation 이 매우 중요. 플러스 user space / kernel space 에서의 support routine 들이 있음.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/12/ms14-068-vulnerabilities-in-kerberos/">MS14-068: Vulnerabilities in Kerberos</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-12T11:08:09+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:08 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MS14-068:</p>

<ul>
<li><a href="https://www.trustedsec.com/december-2014/ms14-068-full-compromise-step-step/">From MS14-068 to Full Compromise - Step by Step</a></li>
<li><a href="https://labs.mwrinfosecurity.com/blog/2014/12/16/digging-into-ms14-068-exploitation-and-defence/">Digging into MS14-068, Exploitation and Defense</a></li>
<li><a href="http://adsecurity.org/?p=676">Exploiting MS14-068 Vulnerable Domain Controllers Successfully with the Python Kerberos Exploitation Kit (PyKEK)</a></li>
<li><a href="http://blog.beyondtrust.com/a-quick-look-at-ms14-068">A Quick Look at MS14-068</a></li>
<li><a href="https://www.exploit-db.com/exploits/35474/">Windows Kerberos - Elevation of Privilege (MS14-068)</a></li>
</ul>


<p>Kerberos:</p>

<ul>
<li><a href="https://technet.microsoft.com/en-us/library/cc961976.aspx">Basic Concepts for the Kerberos Protocol</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/cc246080.aspx">Kerberos Protocol Overview</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/cc237917.aspx">MS-PAC: Privilege Attribute Certificate Data Structure</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/cc237955.aspx">PAC_SIGNATURE_DATA</a></li>
<li><a href="http://adsecurity.org/?p=227">Kerberos, Active Directory&rsquo;s Secret Decoder Ring</a></li>
<li><a href="http://cs.unc.edu/~fabian/course_papers/steiner_neuman.pdf">Kerberos: An Authentication Service for Open Network Systems</a></li>
<li><a href="http://www.isi.edu/div7/publication_files/evolution_of_kerberos.pdf">The Evolution of the Kerberos Authentication Service</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/cc772815(v=ws.10).aspx">How the Kerberos Version 5 Authentication Protocol Works</a></li>
</ul>


<p>Other attacks:</p>

<ul>
<li><a href="http://adsecurity.org/?p=1515">Detecting Forged Kerberos Ticket (Golden Ticket &amp; Silver Ticket) Use in Active Directory</a></li>
<li><a href="https://github.com/bidord/pykek">Python Kerberos Exploitation Kit</a></li>
<li><a href="http://livestream.com/NTNU/passwords14/videos/70751388?t=1418474079423">The International Conference on PASSWORDS 2014</a></li>
<li><a href="https://media.blackhat.com/bh-us-12/Briefings/Duckwall/BH_US_12_Duckwall_Campbell_Still_Passing_Slides.pdf">Still Passing the Hash 15 Years Later&hellip;</a></li>
</ul>


<h3>요체</h3>

<p>이 버그의 요체는 KDC 가 가짜 PAC 를 서명하게 만드는 것.</p>

<p>PAC 은 krbtgt 의 키로 hmac-md5 / hmac-sha1-96-aes256 사인되어있는데. 가짜 PAC 를 어떻게 만들 수 있을까?</p>

<p>두가지 트릭을 사용하는데,</p>

<ol>
<li><p>각종 Admin 그룹 권한을 잔뜩 넣은 가짜 PAC 를 만들고, HMAC 이 아니라, MD5 로 서명을 하는 것. 패치전 MS Kerberos 코드에서는 HMAC 이 아니어도 crypto algorithm 을 돌려서 나온 결과가 일치하면 넘어갔다.</p></li>
<li><p>서명은 HMAC 이 아니라 MD4 로 그냥 넘어갔다고 쳐도, TGT 는 K_s (서비스 서버) 로 암호화되는데, 이걸 어떻게 하냐가 핵심. Sylvain Monné 에 따르면, TGS-REQ 에 {TGT}K_s 형태로 보내지 말고, TGS-REQ 의 enc-authorization-data 세그먼트에 TGT 세션키로 암호화해서 집어넣어도 된다고 한다. 좀 더 들여다봐야겠지만, TGS-REQ 에 가짜를 보내면 TGS-REP 에 krbtgt 와 logon 서버가 서명한 PAC 가 오는 모양.</p></li>
</ol>


<p><a href="http://blogs.technet.com/b/srd/archive/2014/11/18/additional-information-about-cve-2014-6324.aspx">Microsoft 에 따르면</a>
Windows Server 2008R2 이하에서 돌아가는 Domain Controller 는 취약하다 (패치안된). 2012 는 관련된 유사한 공격에 취약하지만, exploit 하기 더 어렵다고한다.</p>

<h3>Kerberos</h3>

<p>일단 커버러스 모델에 대해서 알아봐야겠다.</p>

<h4>Initial Setup</h4>

<p>커버러스에서는 TTP (Trusted Third Party) 인 KDC (Key Distribution Center) 가 존재하는 것이 핵심. KDC 는 realm 에 참여하는 모든 entity 와 각각 개별적으로 share 하는 symmetric key 가 있다. 조직 크기에 따라 수십개에서 수만개에 달할 저 symmetric key 를 어떻게 generate 해서 share 하는지는 일단 논외.</p>

<p>일단 V4 기준으로 정리해본다.</p>

<ol>
<li>어떤 Client 는 어떤 Server 에 서비스를 요청하고 싶어한다.</li>
<li>Client 는 KDC 에 c,s,n 을 보낸다. c 는 client identity, s 는 접근하고 싶은 server identity, n 은 replay 를 방지할 nonce.</li>
<li>KDC 는 Client 에게 2 개의 정보를 보낸다.</li>
<li>{Session Key,Ticket}K_c 형태로 보내는데, the client 와 KDC 가 공유하고 있는 symmetric key K_c 로 암호화해서 보내기때문에, 아무나 못푼다.</li>
<li>Session Key 는 the client 와 the server 가 통신할 때 사용할 세션키.</li>
<li>Ticket 은 일단 the server 와 KDC 가 공유하고 있는 symmetric key K_s 로 암호화되서 아무나 못푼다. 오직 the server 만 풀수있다.</li>
<li>Ticket 내용은 {client,start,expire,Session Key}K_s 인데, client identity, 티켓의 유효기간 start ~ expire, 그리고 the client 와 the server 가 사용할 세션키.</li>
<li>일단 4 로 돌아가서, client 는 <code>session key</code> 와 <code>ticket</code> 을 받았다.</li>
<li>이제 the client 는 the server 에, {A_c}session_key, Ticket 을 보낸다. Ticket 은 각종 정보를 K_s 로 암호화한 것.</li>
</ol>


<p>이제 윈도우즈 버전으로 가본다.</p>

<h4>Kerberos in a Windows Domain</h4>

<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/bb742516.aspx">Kerberos Explained</a></li>
</ul>


<p>KDC 에서 Ticket 을 얻어서 타겟 Service 에 Ticket 을 보내는 흐름은 다음과 같다.</p>

<ol>
<li>AS-REQ: The user 가 KDC 에 보내는 메시지. user identity 와 timestamp 를 KDC 로 보낸다. timestamp 는 유저의 패스워드 해쉬로 암호화한다. AD 에 저장되어있는 패스워드를 사용해 timestamp 를 decrypt 해봐서 올바른 시간이 나오면 replay 가 아니란 것을 알수 있다.</li>
<li><p>AS-REP: The user 의 신원을 성공적으로 확인했다면, 세션키와 TGT (Ticket Granting Ticket) 를 보낸다. TGT 에는 <code>Client Name</code>, <code>Start</code>, <code>End</code>, <code>Session Key</code>, <code>Privilege Attribute Certificate (PAC)</code>, <code>Server Signature</code>, <code>KDC Signature</code> 가 들어있다. TGT 는 K_krbtgt 로 암호화된다. 세션키는 K_c 로 암호화된다. 여기까지는 KDC 랑 서비스 서버랑 krbtgt 로 동일한 상황. 요구하는 서비스가 Ticket Granting Service 이기때문.</p></li>
<li><p>TGS-REQ: 접근하고자하는 Service name, TGT (Ticket Granting Ticket), Authenticator 를 서비스에 보낸다. Authenticator 는 { user ID, timestamp }K_c,s 로 암호화된다.</p></li>
<li>TGS-REP: TGS 는 K_krbtgt 를 이용해 TGT 를 복호화한다. TGT 안에 세션키가 있으니, 그 세션키로 Authenticator 를 복호화한다. Authenticator 의 내용과 TGT 의 내용을 비교 검증한다. OK 라면, 서비스 티켓을 찍어낼 차례이다. 서비스 티켓에 PAC 를 복사한다. 서비스 티켓의 PAC 는 krbtgt 키와 K_logon 로 서명된다. 서비스 티켓은 K_logon 로 암호화된다. 이제 클라이언트는 예를 들어 로그온 서버에 이 서비스 티켓을 제출하고 사용을 허가받을 수 있다.</li>
</ol>


<h4>AS-REQ</h4>

<p><code>AS-REQ</code> 의 큰 두가지 핵심은 암호화된 timestamp 와 유저의 신원 정보.</p>

<p>유저의 신원 정보는,</p>

<ul>
<li>cname = 사용자 ID</li>
<li>realm = domain (i.e. BABOCORP.GLOBAL)</li>
<li>service = &lsquo;krbtgt&rsquo;</li>
<li>host = domain (i.e. BABOCORP.GLOBAL)</li>
<li>etype = RC4_HMAC</li>
<li>kdc_options = (Forwardable, Proxiable, Renewable, Canonicalize)</li>
<li>nonce = random 31 bits</li>
</ul>


<p><code>AS-REQ</code> 를 만들때 timestamp 를 유저의 패스워드로 암호화하는데 그 과정을 보면,</p>

<figure class='code'><figcaption><span>유저의 인풋을 해쉬해서 암호화 키로 쓰는 장면</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">pass</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="s">&quot;Password: &quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">unicode_pass</span> <span class="o">=</span> <span class="k">pass</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-16le&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">md4_pass</span> <span class="o">=</span> <span class="n">MD4</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">unicode_pass</span><span class="p">))</span>
</span><span class='line'><span class="n">md4_digest</span> <span class="o">=</span> <span class="n">md4_pass</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span class='line'><span class="n">user_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">RC4_HMAC</span><span class="p">,</span> <span class="n">md4_digest</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>이제 <code>build_pa_enc_timestamp(current_time, key)</code> 에서 timestamp 를 암호화하는데,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">build_pa_enc_timestamp</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span class='line'>    <span class="n">gt</span><span class="p">,</span> <span class="n">ms</span> <span class="o">=</span> <span class="n">epoch2gt</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="n">microseconds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="n">pa_ts_enc</span> <span class="o">=</span> <span class="n">PaEncTsEnc</span><span class="p">()</span>
</span><span class='line'>    <span class="n">pa_ts_enc</span><span class="p">[</span><span class="s">&#39;patimestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gt</span>
</span><span class='line'>    <span class="n">pa_ts_enc</span><span class="p">[</span><span class="s">&#39;pause&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pa_ts</span> <span class="o">=</span> <span class="n">PaEncTimestamp</span><span class="p">()</span>
</span><span class='line'>    <span class="n">pa_ts</span><span class="p">[</span><span class="s">&#39;etype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">pa_ts</span><span class="p">[</span><span class="s">&#39;cipher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">encode</span><span class="p">(</span><span class="n">pa_ts_enc</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">pa_ts</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>pa_ts</code> 의 <code>etype</code> 과 <code>cipher</code> 에 각각 <code>RC4_HMAC</code> 과 유저가 입력한 패스워드의 해쉬를 세팅한다.</p>

<p><code>PaEncTimestamp()</code> 는 ASN.1 으로 <code>etype</code>, <code>cipher</code> 를 가지고 있다.</p>

<ul>
<li><a href="http://luca.ntop.org/Teaching/Appunti/asn1.html">A Layman&rsquo;s Guide to a Subset of ASN.1, BER, and DER</a></li>
</ul>


<p>유저가 입력한 패스워드 해쉬로 timestamp 를 암호화한다.</p>

<figure class='code'><figcaption><span>encrypt()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">etype</span> <span class="o">!=</span> <span class="n">RC4_HMAC</span><span class="p">:</span>
</span><span class='line'>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Only RC4-HMAC supported!&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">k1</span> <span class="o">=</span> <span class="n">HMAC</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">random_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span>
</span><span class='line'>    <span class="n">chksum</span> <span class="o">=</span> <span class="n">HMAC</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span class='line'>    <span class="n">k3</span> <span class="o">=</span> <span class="n">HMAC</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">chksum</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">chksum</span> <span class="o">+</span> <span class="n">ARC4</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>우선 유저가 입력한 패스워드의 MD4 해쉬를 키로, 1 을 HMAC 돌린다.</li>
<li>data 앞에 랜덤 바이트를 8 bytes 붙인다.</li>
<li><ol>
<li>을 키로 pa_ts_enc 구조에 HMAC 을 돌린다. 이게 체크섬.</li>
</ol>
</li>
<li>체크섬에 또 한번 HMAC 을 돌린다.</li>
<li><ol>
<li>를 암호키로 pa_ts_enc 구조에 RC4 를 돌린다.</li>
</ol>
</li>
<li>체크섬 + 5. 가 <code>RC4_HMAC</code> 값이 된다.</li>
</ol>


<h3>Packets</h3>

<p>adsecurity.org 에서 WireShark packets 을 다운받아 훑어보았다.</p>

<h4>AS-REQ</h4>

<ul>
<li>padata 에는 kRB5-PADATA-ENC-TIMESTAMP (eTYPE-ARCFOUR-HMAC-MD5, cipher)</li>
<li>req-body 에는 cname (i.e. darthsidious / LAB.ADSECURITY.ORG), sname (i.e. krbtgt / LAB.ADSECURITY.ORG), etype (eTYPE-ARCFOUR-HMAC-MD5)</li>
</ul>


<h4>AS-REP</h4>

<h4>TGS-REQ</h4>

<h4>TGS-REP</h4>

<h3>Exploitation</h3>

<h4>Discovery</h4>

<p>nmap 으로 FQDN, Domain name, Windows Version 등을 확인한다.</p>

<figure class='code'><figcaption><span>encrypt()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># nmap --script smb-os-discovery.nse -p445 xxx.xxx.xxx.xxx</span>
</span></code></pre></td></tr></table></div></figure>


<p>Powershell 커맨드들.</p>

<figure class='code'><figcaption><span>encrypt()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Get</span><span class="o">-</span><span class="n">ADDomainController</span> <span class="o">-</span><span class="nb">filter</span> <span class="o">*</span>
</span><span class='line'><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Get</span><span class="o">-</span><span class="n">HotFix</span> <span class="o">-</span><span class="n">ID</span> <span class="n">KB3011780</span> <span class="o">-</span><span class="n">ComputerName</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>encrypt()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">net</span> <span class="n">time</span> <span class="o">-</span><span class="n">S</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">rdate</span> <span class="o">-</span><span class="n">n</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">net</span> <span class="n">rpc</span> <span class="o">-</span><span class="n">W</span> <span class="n">DOMAIN</span> <span class="o">-</span><span class="n">U</span> <span class="n">user01</span> <span class="o">-</span><span class="n">S</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span> <span class="n">shell</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">user01</span><span class="s">&#39;s password:</span>
</span><span class='line'><span class="n">Talking</span> <span class="n">to</span> <span class="n">domain</span> <span class="n">DOMAIN</span> <span class="p">(</span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mf">21.</span><span class="o">...</span><span class="p">)</span>
</span><span class='line'><span class="n">net</span> <span class="n">rpc</span><span class="o">&gt;</span> <span class="n">user</span>
</span><span class='line'><span class="n">net</span> <span class="n">rpc</span> <span class="n">user</span><span class="o">&gt;</span> <span class="n">show</span>
</span><span class='line'><span class="n">net</span> <span class="n">rpc</span> <span class="n">user</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">user01</span>
</span><span class='line'><span class="n">user</span> <span class="n">rid</span><span class="p">:</span> <span class="mi">1105</span><span class="p">,</span> <span class="n">group</span> <span class="n">rid</span><span class="p">:</span> <span class="mi">513</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">rpcclient</span> <span class="o">-</span><span class="n">U</span> <span class="n">user01</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span>
</span><span class='line'><span class="n">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span> <span class="n">lookupnames</span> <span class="n">user01</span>
</span><span class='line'><span class="n">user01</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="n">xxx</span> <span class="p">(</span><span class="n">User</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># apt-get install cifs-utils krb5-user</span>
</span><span class='line'><span class="c"># cat &gt; /etc/krb5.conf &lt;&lt; &#39;EOF&#39;</span>
</span><span class='line'><span class="p">[</span><span class="n">libdefaults</span><span class="p">]</span>
</span><span class='line'><span class="n">default_realm</span> <span class="o">=</span> <span class="n">DOMAIN</span> <span class="c"># upper</span>
</span><span class='line'><span class="n">dns_lookup_realm</span> <span class="o">=</span> <span class="n">true</span>
</span><span class='line'><span class="n">dns_lookup_kdc</span> <span class="o">=</span> <span class="n">true</span>
</span><span class='line'><span class="p">[</span><span class="n">realms</span><span class="p">]</span>
</span><span class='line'><span class="n">DOMAIN</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="n">kdc</span> <span class="o">=</span> <span class="n">DC</span><span class="p">:</span><span class="mi">88</span> <span class="c"># upper</span>
</span><span class='line'><span class="n">admin_server</span> <span class="o">=</span> <span class="n">DC</span> <span class="c"># lower</span>
</span><span class='line'><span class="n">default_domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="c"># lower</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">[</span><span class="n">domain_realm</span><span class="p">]</span>
</span><span class='line'><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span> <span class="o">=</span> <span class="n">DOMAIN</span> <span class="c"># lower = upper</span>
</span><span class='line'><span class="n">EOF</span>
</span><span class='line'><span class="c"># rdate -n DC</span>
</span><span class='line'><span class="c"># kinit user@domain</span>
</span><span class='line'><span class="c"># rpcclient -U user DC</span>
</span><span class='line'><span class="c"># cp TGT* /tmp/krb5cc_0</span>
</span><span class='line'><span class="c"># smbclient -W domain //DC/c$ -k</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Uptime</h4>

<p>Responder.py</p>

<h4>RID Enumeration</h4>

<p>ridenum.py</p>

<h4>mimikatz</h4>

<p>mimikatz.exe</p>

<h4>PyKEK</h4>

<p>pykek 이 forge 하는 group membership 은</p>

<figure class='code'><figcaption><span>encrypt()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Domain</span> <span class="n">Users</span> <span class="p">(</span><span class="mi">513</span><span class="p">)</span>
</span><span class='line'><span class="n">Domain</span> <span class="n">Admins</span> <span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span><span class='line'><span class="n">Schema</span> <span class="n">Admins</span> <span class="p">(</span><span class="mi">518</span><span class="p">)</span>
</span><span class='line'><span class="n">Enterprie</span> <span class="n">Admins</span> <span class="p">(</span><span class="mi">519</span><span class="p">)</span>
</span><span class='line'><span class="n">Group</span> <span class="n">Policy</span> <span class="n">Creator</span> <span class="n">Owners</span> <span class="p">(</span><span class="mi">520</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://adsecurity.org/?p=763">PyKEK Kerberos Packets on the Wire aka How the MS14-068 Exploit Works</a></p>

<h3>Patch</h3>

<p>blog.beyondtrust.com 의 글을 보니, VerifyPacSignature() 에서 SignatureType 이 HMAC_MD5 인지 비교하는 코드가 들어간 모양.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/10/mitmproxy/">Mitmproxy</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-10T14:47:29+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:47 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Explicit HTTP</h3>

<p>Explicity proxy 로 설정하는 것이 제일 안정적.</p>

<p>Client 는 proxy 에게 다음과 같은 proxy protocol 을 돌린다. RFC 2068.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GET http://www.naver.com/index.html HTTP/1.1</span></code></pre></td></tr></table></div></figure>


<h3>Explicit HTTPS</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CONNECT example.com:443 HTTP/1.1</span></code></pre></td></tr></table></div></figure>


<p>Server 인증서를 위조해야하기때문에, mitmproxy 를 디바이스에다가 trusted CA certificate 으로 등록해야한다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CONNECT 10.1.1.1:443 HTTP/1.1</span></code></pre></td></tr></table></div></figure>


<p>와 같이 숫자로 오는 경우도 있기때문에, <code>upstream certificate sniffing</code> 을 수행한다.
Client 로부터 <code>CONNECT</code> 를 받으면, 진짜 서버에 접속해서 SSL 핸드쉐이크를 돌려서, 서버의 인증서를 가져온다.
여기서 CN 을 추출해, 이 CN 과 동일한 가짜 인증서를 만들고, mitmproxy CA 인증서로 서명한다.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/07/new-directions-in-cryptography/">New Directions in Cryptography</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-07T10:24:26+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:24 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content">
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/07/a-method-for-obtaining-digital-signature-and-public-key-cryptosystems/">A Method for Obtaining Digital Signature and Public-Key Cryptosystems</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-07T10:23:59+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:23 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>R.L. Rivest, A. Shamir, and L. Adleman 의 그 논문.</p>

<p><a href="https://people.csail.mit.edu/rivest/Rsapaper.pdf">here</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/05/freak/">FREAK</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-05T23:05:26+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:05 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>FREAK</h3>

<p>INRIA, Microsoft Research, IMDEA 의 암호학자들이 OpenSSL 을 사용한 프로그램에서 취약점을 발견했다. MitM 포지션을 잡고 있는 해커가, 커넥션의 암호화 강도를 떨어뜨릴 수 있는 취약점이다. &lsquo;export-grade&rsquo; 로 떨어뜨리는데, export RSA moduli 는 512 bits 이하이고, Amazon EC2 에서 12 시간 &amp; 100 불 정도에 팩터링할 수 있다고 한다. 이 정도 시간이면 실시간으로 https 세션을 감청한다던가, packet 을 inject 한다던가가 불가능한데, 문제는 apache mod_ssl 의 경우, RSA key 를 만드는 계산을 돌리는 것이 비싸기때문에, 리스타트될때까지 같은 RSA key 를 사용한다는 것. 이 경우 12 시간이 긴 시간이 아니게 되버린다.</p>

<ul>
<li><a href="https://www.smacktls.com">SMACK: State Machine Attacks</a></li>
<li><a href="http://blog.cryptographyengineering.com/2015/03/attack-of-week-freak-or-factoring-nsa.html">Matthew Green 의 블로그</a></li>
<li><a href="http://www.smacktls.com/smack.pdf">A Messy State of the Union: Taming the Composite State Machines of TLS</a></li>
</ul>


<h3>동작하는 방식</h3>

<p>Matthew Green 의 블로그를 요약해본다.</p>

<ol>
<li>Client Hello 에서 client 는 표준 &lsquo;RSA&rsquo; ciphersuite 를 요청한다.</li>
<li>MitM 해커는 메시지를 &lsquo;export RSA&rsquo; 요청으로 바꿔친다.</li>
<li>서버는 512-bit export RSA key 로 응답한다. private key 로 서명해서.</li>
<li>Client 는 취약한 키를 받아들인다. OpenSSL/SecureTransport 버그로 인해.</li>
</ol>


<h3>예상되는 피해</h3>

<h3>Factoring &lsquo;export-grade&rsquo; RSA</h3>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/05/logjam-diffie-hellman-falls-down/">Logjam: Diffie-Hellman Falls Down</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-05T18:30:24+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:30 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li><a href="https://weakdh.org/imperfect-forward-secrecy.pdf">Imperfect Forward Secrecy: How Diffie-Hellman Fails in Practice</a></li>
<li><a href="http://blog.cryptographyengineering.com/2015/05/attack-of-week-logjam.html">Attack of the week: Logjam</a></li>
</ul>


<h3>Matthew Green Blog 요약</h3>

<ul>
<li>알려진 가장 좋은 방법은 g<sup>a</sup> 를 캡쳐해서, log(g<sup>a</sup>) = a 인 이산로그 문제를 푸는 것.</li>
<li>p 가 2048 bits 정도이면 수학적으로 풀기 어렵다.</li>
<li><p>p 가 512 bits 라면?</p></li>
<li><p>서버가 DHE-EXPORT 를 지원한다면, 공격자가 negotiation message 를 edit 해서, client 가 지원하는 cipher list 를 DHE-EXPORT 만 지원한다고 바꿔놓는다.</p></li>
<li>이제 서버는 client 가 DHE-EXPORT 만 지원한다고 믿게 된다.</li>
<li>이제 서버는 512-bit export-grade Diffie-Hellman tuple 을 보낸다.</li>
<li>클라이언트는 512-bit DH tuple 을 믿어버린다. (클라이언트는 DHE-EXPORT 컨텍스트에서 negotiation 되고 있다는 것을 모른다)</li>
<li>허잡한 파라메터가 오는데도 클라이언트는 모른다.</li>
<li>Negotiation 마지막에 Finished 메시지에 지금까지 교환되었던 negotiation message 의 MAC 이 교환되는데, 이것때문에 뽀록난다.</li>
<li>DH key 를 깨야한다. Finished 메시지가 교환되기전에.</li>
<li>깰 수 있다면, forged Finished 메시지를 만들 수 있다.</li>
</ul>


<h3>Can you really solve a discrete logarithm before a TLS handshake times out?</h3>

<p>Number Field Sieve 를 사용해야하는데, 이걸 optimize 할 수 있다.</p>

<ul>
<li>Pre-computation (for a given prime p): Polynomial selection, sieving, linear algebra 로 구성된 작업. p 에만 dependant.</li>
<li>Solving to find a (for a given g<sup>a</sup> mod p): precomputation 에서 만들어진 table 을 사용한다. g, g<sup>a</sup> 를 가지고 table 을 사용하여 a 를 찾는 알고리즘.</li>
</ul>


<p>Pre-computation 은 p 에 dependant 한데. 그렇다면 실제 TLS 에서 p 는 어떻게 generate 되는 걸까?</p>

<p>Large-scale 로 진행된 internet scan 에서 Apache/mod_ssl 의 92% 는 DH-EXPORT 의 경우, 2 개의 소수만 사용했다고 한다. 이 경우 2 개의 p 에 대해서만 테이블을 만들면 된다.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/04/using-wireshark-with-android/">Using Wireshark With Android</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-04T13:49:09+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ adb shell "tcpdump -s 0 -w - | nc -l -p 4444"
</span><span class='line'>$ adb forward tcp:4444 tcp:4444
</span><span class='line'>$ nc localhost 4444 | sudo wireshark -k -S -i -</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/04/ios-building-a-basic-toolkit/">iOS: Building a Basic Toolkit</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-04T13:23:03+09:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:23 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Cydia</h4>

<h4>BigBoss Recommended Tools</h4>

<h4>otool</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Inspect the Objective-C segment to reveal class and method names:
</span><span class='line'>$ otool -oV MAHHApp
</span><span class='line'>
</span><span class='line'># List the libraries used by the binary:
</span><span class='line'>$ otool -L MAHHApp
</span><span class='line'>
</span><span class='line'># List the symbols exported by a binary
</span><span class='line'>$ otool -IV MAHHApp
</span><span class='line'>
</span><span class='line'># Display the short-form header information:
</span><span class='line'>$ otool -hV MAHHApp
</span><span class='line'>
</span><span class='line'># Display the binary load commands:
</span><span class='line'>$ otool -l MAHHApp</span></code></pre></td></tr></table></div></figure>


<h4>nm</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nm MAHHApp</span></code></pre></td></tr></table></div></figure>


<h4>lipo</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ lipo -info MAHHApp
</span><span class='line'>$ lipo -thin &lt;arch_type&gt; -output MAHHApp-v7 MAHHApp</span></code></pre></td></tr></table></div></figure>


<h4>Debuggers</h4>

<ul>
<li>gdb (Help: <a href="http://www.pod2g.org/2012/02/working-gnu-debugger-on-ios-43.html">here</a></li>
<li>radare (Add cydia repo as a source, <a href="http://cydia.radare.org">http://cydia.radare.org</a>)</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ lipo -thin armv7 gdb-arm-apple-darwin -output gdb-arm7</span></code></pre></td></tr></table></div></figure>


<h4>Tools for Signing Binaries</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># To sign or replace an existing signature, use the following command:
</span><span class='line'>$ codesign -v -fs "CodeSignIdentity" MAHHApp.app/
</span><span class='line'>
</span><span class='line'># To display the code signature of an application:
</span><span class='line'>$ codesign -v -d MAHHApp.app</span></code></pre></td></tr></table></div></figure>


<ul>
<li>saurik&rsquo;s ldid: <a href="http://www.saurik.com/id/8">here</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ldid -S MAHHApp</span></code></pre></td></tr></table></div></figure>


<h4>Installipa</h4>

<ul>
<li><a href="https://github.com/autopear/ipainstaller">here</a></li>
<li>AppSync (repo: <a href="http://cydia.appaddict.org">http://cydia.appaddict.org</a>)</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ipainstaller Lab1.1a.ipa
</span><span class='line'>Analyzing Lab1.1a.ipa...
</span><span class='line'>Installing lab1.1a (v1.0)...
</span><span class='line'>Installed lab1.1a (v1.0) successfully.</span></code></pre></td></tr></table></div></figure>


<h4>Exploring the Filesystem</h4>

<ul>
<li><a href="http://2013.hackitoergosum.org/presentations/Day3-04.Hacking%20apple%20accessories%20to%20pown%20iDevices%20%E2%80%93%20Wake%20up%20Neo!%20Your%20phone%20got%20pwnd%20!%20by%20Mathieu%20GoToHack%20RENARD.pdf">Mathieu Renard</a></li>
<li>iExplorer</li>
<li>iFunBox</li>
</ul>


<h4>Property Lists</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># plutil com.google.Authenticator.plist
</span><span class='line'>$ plutil -convert xml1 com.google.Authenticator.plist
</span><span class='line'>$ plutil -convert binary1 com.google.Authenticator.plist</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/6">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/4">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/13/android-hackers-handbook/">Android Hacker's Handbook</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/11/cve-2013-2094-perf-swevent-enabled-revisited/">CVE-2013-2094: Perf_swevent_enabled Revisited</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/11/bsides-vienna-2015-writing-your-first-windows-exploit-in-less-than-one-hour/">BSides Vienna 2015: Writing Your First Windows Exploit in Less Than One Hour</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/11/sock-sendpage/">Sock_sendpage</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/23/on-the-juniper-backdoor/">On the Juniper Backdoor</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - KC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
